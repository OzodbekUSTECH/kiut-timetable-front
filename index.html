<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="origin" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание занятий</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0096db 0%, #0077cc 100%);
            color: white;
            padding: 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-text {
            text-align: left;
        }

        .header-text h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .form-hint {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .language-selector {
            display: flex;
            gap: 5px;
        }

        .language-selector .btn {
            padding: 5px 10px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }

        .language-selector .btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .language-selector .btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .filters {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            align-items: start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .filter-group label {
            font-weight: 500;
            color: #495057;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-input {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .autocomplete-input:focus {
            outline: none;
            border-color: #0096db;
            box-shadow: 0 0 0 0.2rem rgba(0, 150, 219, 0.25);
        }

        .autocomplete-input.current {
            background-color: #e3f2fd;
            border-color: #0096db;
        }

        .search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            pointer-events: none;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-5px);
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        
        .autocomplete-dropdown.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Специальные стили для модальных dropdown */
        #modalTeacherDropdown,
        #modalRoomDropdown,
        #modalSubjectDropdown {
            z-index: 9999;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s;
        }

        .autocomplete-item:hover,
        .autocomplete-item.active {
            background-color: #e3f2fd;
        }
        
        .autocomplete-item.unavailable {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .autocomplete-item.unavailable:hover {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .calendar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .calendar-info {
            flex: 1;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .calendar-info:hover {
            background-color: #f8f9fa;
        }
        
        .calendar-main {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }
        
        .calendar-dates {
            font-size: 0.8em;
            color: #6c757d;
        }
        
        .calendar-actions {
            display: flex;
            gap: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .calendar-item:hover .calendar-actions {
            opacity: 1;
        }
        
        .calendar-actions .btn {
            padding: 2px 6px;
            font-size: 0.8em;
            border-radius: 3px;
        }

        .calendar-year {
            font-weight: 600;
        }

        .calendar-semester {
            color: #6c757d;
            font-size: 12px;
        }

        .calendar-current {
            background-color: #e8f5e8 !important;
            border-left: 3px solid #28a745;
        }

        .no-results {
            padding: 10px 12px;
            color: #6c757d;
            font-style: italic;
        }

        .loading-indicator {
            color: #0096db;
            font-size: 12px;
            margin-top: 4px;
        }

        .current-calendar-label {
            color: #0096db;
            font-size: 12px;
            font-weight: 500;
        }



        .timetable-container {
            overflow-x: auto;
            padding: 20px;
        }
        
        .drag-drop-controls {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .drag-drop-info {
            color: #495057;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .drag-drop-buttons {
            display: flex;
            gap: 10px;
        }
        
        .drag-drop-buttons button {
            min-width: 140px;
        }
        
        @media (max-width: 768px) {
            .drag-drop-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .drag-drop-buttons {
                justify-content: center;
            }
        }

        .timetable {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .timetable th,
        .timetable td {
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
            position: relative;
        }

        .timetable th {
            background-color: #0096db;
            color: white;
            font-weight: 600;
            padding: 12px 8px;
        }

        .time-header {
            background-color: #0077cc !important;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            width: 60px;
            font-size: 12px;
            line-height: 1.2;
        }

        .day-header {
            background-color: #0096db !important;
            color: white;
            padding: 15px 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .day-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .day-date {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
        }

        .day-cell {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            width: 100px;
            padding: 15px 8px;
            font-size: 13px;
        }

        .lesson-cell {
            width: 180px;
            height: 80px;
            padding: 5px;
            background-color: #ffffff;
            transition: background-color 0.3s;
        }
        
        /* Стили для индикации доступных/недоступных слотов */
        .lesson-cell.available-drop {
            background-color: #d4edda !important;
            border: 2px solid #28a745 !important;
            position: relative;
        }
        
        .lesson-cell.available-drop::after {
            content: "✓ Доступно";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .lesson-cell.unavailable-drop {
            background-color: #f8d7da !important;
            border: 2px solid #dc3545 !important;
            position: relative;
        }
        
        .lesson-cell.unavailable-drop::after {
            content: "✗ Недоступно";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .lesson-cell.checking-drop {
            background-color: #fff3cd !important;
            border: 2px solid #ffc107 !important;
            position: relative;
        }
        
        .lesson-cell.checking-drop::after {
            content: "⏳ Проверка...";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ffc107;
            color: #212529;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .lesson-cell:hover {
            background-color: #f8f9fa;
        }

        .lesson {
            background: linear-gradient(135deg, #0096db 0%, #0077cc 100%);
            color: white;
            padding: 8px;
            border-radius: 6px;
            font-size: 11px;
            line-height: 1.3;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 150, 219, 0.2);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .lesson:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 150, 219, 0.3);
        }

        .lesson-subject {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 12px;
        }

        .lesson-teacher {
            font-size: 10px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .lesson-room {
            font-size: 10px;
            opacity: 0.8;
        }

        .lesson-groups {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 2px;
        }

        .lesson-type {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 2px;
            color: #28a745;
            font-weight: 500;
        }

        .lesson-note {
            font-size: 9px;
            opacity: 0.9;
            margin-top: 3px;
            color: #ffc107;
            font-style: italic;
            word-wrap: break-word;
            max-height: 20px;
            overflow: hidden;
        }

        .empty-cell {
            background-color: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #0096db;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #e3f2fd;
            color: #0c5460;
            padding: 15px;
            margin: 20px;
            border-radius: 4px;
            border: 1px solid #0096db;
            text-align: center;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #0096db;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #0096db;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0096db;
            box-shadow: 0 0 0 0.2rem rgba(0, 150, 219, 0.25);
        }

        .form-group select {
            margin-bottom: 5px;
        }

        .form-group input[disabled] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .form-group select[disabled] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .required-field {
            color: #dc3545;
            font-weight: bold;
        }

        .optional-field {
            color: #6c757d;
            font-size: 12px;
            font-weight: normal;
        }

        .field-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            color: #495057;
        }

        .field-input:focus {
            outline: none;
            border-color: #0096db;
            box-shadow: 0 0 0 0.2rem rgba(0, 150, 219, 0.25);
        }

        .field-input[disabled] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            position: sticky;
            bottom: 0;
            background: white;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #0096db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0077cc;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Drag and drop styles */
        .lesson.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .lesson-cell.drag-over {
            background-color: #e3f2fd;
            border: 2px dashed #0096db;
        }

        .delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .lesson:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: #c82333;
        }



        /* Стили для множественного выбора групп */
        .multi-select-container {
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
        }

        /* Стили для уведомлений */
        #notificationContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .notification {
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
            max-height: 100px;
        }

        .notification.hide {
            transform: translateX(100%);
            opacity: 0;
            max-height: 0;
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .notification.info {
            background: linear-gradient(135deg, #0096db, #0077cc);
        }

        .notification-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-message {
            flex: 1;
            word-wrap: break-word;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin: 0;
            opacity: 0.8;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* Стили для drag & drop зоны */
        .drop-zone {
            border: 2px dashed #0096db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drop-zone:hover {
            background: #e3f2fd;
            border-color: #0077cc;
        }

        .drop-zone.drag-over {
            background: #e3f2fd;
            border-color: #28a745;
            transform: scale(1.02);
        }

        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #0096db;
        }

        .drop-zone-text {
            font-size: 16px;
            color: #495057;
            margin-bottom: 10px;
        }

        .drop-zone-hint {
            font-size: 14px;
            color: #6c757d;
        }

        .file-input {
            display: none;
        }

        .import-progress {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #495057;
            text-align: center;
        }

        .import-results {
            margin-top: 20px;
            display: none;
        }

        .result-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .result-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .selected-groups {
            padding: 8px 12px;
            min-height: 40px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .no-groups-selected {
            color: #6c757d;
            font-style: italic;
        }

        .selected-group-tag {
            background: #0096db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-group {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin: 0;
        }
        
        .selected-group-tag.unavailable-tag {
            background: #dc3545;
            opacity: 0.8;
        }

        .group-selector {
            position: relative;
        }

        .groups-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .group-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s;
        }

        .group-option:hover {
            background-color: #e3f2fd;
        }

        .group-option.selected {
            background-color: #0096db;
            color: white;
        }
        
        .group-option.unavailable {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .group-option.unavailable:hover {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .group-option:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
            }

            .time-header {
                writing-mode: horizontal-tb;
                text-orientation: upright;
                width: 80px;
                font-size: 10px;
            }

            .lesson-cell {
                width: 140px;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                max-height: 95vh;
            }
            
            .modal-buttons {
                position: static;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>📅 <span data-translate="timetable_title">Расписание занятий</span></h1>
                    <p data-translate="timetable_subtitle">Университетское расписание</p>
                </div>
                <div class="header-actions">
                    <div class="language-selector">
                        <button class="btn btn-sm" onclick="setLanguage('ru')" id="langRu">🇷🇺 RU</button>
                        <button class="btn btn-sm" onclick="setLanguage('en')" id="langEn">🇺🇸 EN</button>
                        <button class="btn btn-sm" onclick="setLanguage('uz')" id="langUz">🇺🇿 UZ</button>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="openCreateCalendarModal()" title="Создать новый календарь">
                        ➕
                    </button>
                    <button class="btn btn-primary" onclick="openImportModal()">
                        📤 <span data-translate="import">Импорт XML</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="branchInput" data-translate="branch">Филиал:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="branchInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_branch"
                        placeholder="Выберите филиал..."
                        autocomplete="off"
                    >
                    <span class="search-icon">🏢</span>
                    <div id="branchDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingBranches" class="loading-indicator" style="display: none;">⏳ <span data-translate="loading">Загрузка...</span></div>
            </div>

            <div class="filter-group">
                <label for="calendarInput" data-translate="academic_calendar">Академический календарь:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="calendarInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_calendar"
                        placeholder="Выберите филиал сначала..."
                        autocomplete="off"
                        readonly
                    >
                    <span class="search-icon">📅</span>
                    <div id="calendarDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingCalendars" class="loading-indicator" style="display: none;">⏳ <span data-translate="loading">Загрузка...</span></div>
            </div>

            <div class="filter-group">
                <label for="groupInput" data-translate="group">Группа:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="groupInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_group"
                        placeholder="Введите название группы..."
                        autocomplete="off"
                    >
                    <span class="search-icon">👥</span>
                    <div id="groupDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingGroups" class="loading-indicator" style="display: none;">⏳ <span data-translate="searching">Поиск...</span></div>
            </div>

            <div class="filter-group">
                <label for="teacherInput" data-translate="teacher">Преподаватель:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="teacherInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_teacher"
                        placeholder="Введите имя преподавателя..."
                        autocomplete="off"
                    >
                    <span class="search-icon">👨‍🏫</span>
                    <div id="teacherDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingTeachers" class="loading-indicator" style="display: none;">⏳ <span data-translate="searching">Поиск...</span></div>
            </div>

            <div class="filter-group">
                <label for="roomInput" data-translate="room">Аудитория:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="roomInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_room"
                        placeholder="Введите номер аудитории..."
                        autocomplete="off"
                    >
                    <span class="search-icon">🏢</span>
                    <div id="roomDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingRooms" class="loading-indicator" style="display: none;">⏳ Поиск...</div>
            </div>

            <div class="filter-group">
                <label for="subjectInput" data-translate="subject">Предмет:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="subjectInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_subject"
                        placeholder="Введите название предмета..."
                        autocomplete="off"
                    >
                    <span class="search-icon">📚</span>
                    <div id="subjectDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingSubjects" class="loading-indicator" style="display: none;">⏳ <span data-translate="searching">Поиск...</span></div>
            </div>


            

        </div>





        <div class="timetable-container">
            <div id="loading" class="loading" style="display: none;">
                Загрузка расписания...
            </div>
            <div id="info" class="info">
                Выберите академический календарь и группу, преподавателя или аудиторию для просмотра расписания
            </div>
            <div id="error" class="error" style="display: none;"></div>
            
            <!-- Кнопки для сохранения/отмены изменений -->
            <div id="dragDropControls" class="drag-drop-controls" style="display: none;">
                <div class="drag-drop-info">
                    <i class="fas fa-hand-paper"></i> Перетащите уроки для изменения расписания
                </div>
                <div class="drag-drop-buttons">
                    <button id="saveChangesBtn" class="btn btn-success">
                        <i class="fas fa-save"></i> Сохранить изменения
                    </button>
                    <button id="cancelChangesBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Отменить
                    </button>
                </div>
            </div>
            <table class="timetable" id="timetable">
                <thead>
                    <tr>
                        <th class="time-header" data-translate="time">Время</th>
                        <th class="day-header">
                            <div class="day-name" data-translate="monday">Понедельник</div>
                            <div class="day-date" id="monday-date"></div>
                        </th>
                        <th class="day-header">
                            <div class="day-name" data-translate="tuesday">Вторник</div>
                            <div class="day-date" id="tuesday-date"></div>
                        </th>
                        <th class="day-header">
                            <div class="day-name" data-translate="wednesday">Среда</div>
                            <div class="day-date" id="wednesday-date"></div>
                        </th>
                        <th class="day-header">
                            <div class="day-name" data-translate="thursday">Четверг</div>
                            <div class="day-date" id="thursday-date"></div>
                        </th>
                        <th class="day-header">
                            <div class="day-name" data-translate="friday">Пятница</div>
                            <div class="day-date" id="friday-date"></div>
                        </th>
                        <th class="day-header">
                            <div class="day-name" data-translate="saturday">Суббота</div>
                            <div class="day-date" id="saturday-date"></div>
                        </th>
                    </tr>
                </thead>
                <tbody id="timetable-body">
                    <!-- Расписание будет загружено здесь -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for adding/editing lessons -->
    <div id="lessonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle" data-translate="create_lesson">Добавить урок</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="lessonForm" style="max-height: calc(90vh - 120px); overflow-y: auto;">
                <div class="form-group">
                    <label for="subjectField" data-translate="subject">Предмет: <span class="required-field">*</span></label>
                    <div class="autocomplete-container">
                        <input type="text" id="subjectField" name="subject_name" data-translate-placeholder="select_subject_or_enter" placeholder="Выберите предмет или введите название" class="field-input" required>
                        <span class="search-icon">📚</span>
                        <div id="modalSubjectDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="teacherField" data-translate="teacher">Преподаватель: <span class="required-field">*</span></label>
                    <div class="autocomplete-container">
                        <input type="text" id="teacherField" name="teacher_name" data-translate-placeholder="select_teacher_or_enter" placeholder="Выберите преподавателя или введите имя" class="field-input" required>
                        <span class="search-icon">👨‍🏫</span>
                        <div id="modalTeacherDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="roomField" data-translate="room">Аудитории: <span class="optional-field" data-translate="optional">(необязательно)</span></label>
                    <div class="multi-select-container">
                        <div class="selected-groups" id="selectedRooms">
                            <div class="no-groups-selected" data-translate="select_rooms">Выберите аудитории...</div>
                        </div>
                        <div class="group-selector">
                            <input type="text" id="roomSearch" data-translate-placeholder="search_rooms" placeholder="Поиск аудиторий..." class="field-input">
                            <div class="groups-dropdown" id="roomsDropdown">
                                <!-- Аудитории будут загружены здесь -->
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelectedRooms()" style="margin-top: 5px; font-size: 11px;">
                        🗑️ <span data-translate="clear_rooms">Очистить аудитории</span>
                    </button>
                </div>
                <div class="form-group">
                    <label for="groupField" data-translate="group">Группы: <span class="optional-field" data-translate="optional">(необязательно)</span></label>
                    <div class="multi-select-container">
                        <div class="selected-groups" id="selectedGroups">
                            <div class="no-groups-selected" data-translate="select_groups">Выберите группы...</div>
                        </div>
                        <div class="group-selector">
                            <input type="text" id="groupSearch" data-translate-placeholder="search_groups" placeholder="Поиск групп..." class="field-input">
                            <div class="groups-dropdown" id="groupsDropdown">
                                <!-- Группы будут загружены здесь -->
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelectedGroups()" style="margin-top: 5px; font-size: 11px;">
                        🗑️ <span data-translate="clear_groups">Очистить группы</span>
                    </button>
                </div>
                <div class="form-group">
                    <label for="lessonNumber" data-translate="lesson_number">Номер урока: <span class="required-field">*</span></label>
                    <select id="lessonNumber" name="lessonNumber" required>
                        <option value="" data-translate="select_lesson_number">Выберите номер урока</option>
                        <option value="1">1 (9:00-9:50)</option>
                        <option value="2">2 (10:00-10:50)</option>
                        <option value="3">3 (11:00-11:50)</option>
                        <option value="4">4 (12:00-12:50)</option>
                        <option value="5">5 (13:00-13:50)</option>
                        <option value="6">6 (14:00-14:50)</option>
                        <option value="7">7 (15:00-15:50)</option>
                        <option value="8">8 (16:00-16:50)</option>
                        <option value="9">9 (17:00-17:50)</option>
                        <option value="10">10 (18:00-18:50)</option>
                        <option value="11">11 (19:00-19:50)</option>
                        <option value="12">12 (20:00-20:50)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="weekDay" data-translate="week_day">День недели: <span class="required-field">*</span></label>
                    <select id="weekDay" name="weekDay" required>
                        <option value="" data-translate="select_week_day">Выберите день недели</option>
                        <option value="0" data-translate="monday">Понедельник</option>
                        <option value="1" data-translate="tuesday">Вторник</option>
                        <option value="2" data-translate="wednesday">Среда</option>
                        <option value="3" data-translate="thursday">Четверг</option>
                        <option value="4" data-translate="friday">Пятница</option>
                        <option value="5" data-translate="saturday">Суббота</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="lessonType" data-translate="lesson_type">Тип занятия: <span class="required-field">*</span></label>
                    <select id="lessonType" name="lessonType" required>
                        <option value="" data-translate="select_lesson_type">Выберите тип занятия</option>
                        <option value="LECTURE" data-translate="lecture">Лекция</option>
                        <option value="SEMINAR" data-translate="seminar">Семинар</option>
                        <option value="EXAM" data-translate="exam">Экзамен</option>
                        <option value="EVENT" data-translate="event">Событие</option>
                        <option value="UNKNOWN" data-translate="unknown">Неизвестно</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="note">Примечание:</label>
                    <textarea id="note" name="note" placeholder="Введите примечание (необязательно)" rows="2" style="resize: vertical; min-height: 60px;"></textarea>
                </div>
                
                <!-- Скрытые поля для позиционных данных -->
                <input type="hidden" id="hiddenLessonNumber" name="hiddenLessonNumber">
                <input type="hidden" id="hiddenWeekDay" name="hiddenWeekDay">
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Отмена</button>
                    <button type="submit" class="btn btn-primary" id="saveLessonBtn">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Academic Calendar Modal -->
    <div id="createCalendarModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createCalendarModalLabel">📅 <span data-translate="create_calendar">Создать академический календарь</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createCalendarForm">
                        <div class="form-group mb-3">
                            <label for="branchSelect"><span data-translate="branch">Филиал</span>: <span class="required-field">*</span></label>
                            <select id="branchSelect" name="branchSelect" class="form-control" required>
                                <option value=""><span data-translate="select_branch">Выберите филиал...</span></option>
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="academicYear"><span data-translate="academic_year">Учебный год</span>: <span class="required-field">*</span></label>
                            <input type="text" id="academicYear" name="academicYear" class="form-control" 
                                   placeholder="2024/2025" pattern="\d{4}/\d{4}" required>
                            <small class="form-hint"><span data-translate="academic_year_placeholder">например: 2024/2025</span></small>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="semesterSelect"><span data-translate="semester">Семестр</span>: <span class="required-field">*</span></label>
                            <select id="semesterSelect" name="semester" class="form-control" required>
                                <option value=""><span data-translate="select_semester">Выберите семестр</span></option>
                                <option value="1"><span data-translate="first_semester">1 семестр</span></option>
                                <option value="2"><span data-translate="second_semester">2 семестр</span></option>
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="startDateInput"><span data-translate="start_date">Дата начала</span>: <span class="required-field">*</span></label>
                            <input type="date" id="startDateInput" name="startDate" class="form-control" required>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="endDateInput"><span data-translate="end_date">Дата окончания</span>: <span class="required-field">*</span></label>
                            <input type="date" id="endDateInput" name="endDate" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span data-translate="cancel">Отмена</span></button>
                    <button type="button" class="btn btn-primary" onclick="createAcademicCalendar()"><span data-translate="create">Создать</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📤 <span data-translate="import_timetable">Импорт расписания из XML</span></h2>
                <span class="close" onclick="closeImportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="importBranchSelect" data-translate="branch">Выберите филиал:</label>
                    <select id="importBranchSelect" class="field-input" onchange="loadCalendarsForImport()">
                        <option value="" data-translate="select_branch">Выберите филиал...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="importCalendarSelect" data-translate="academic_calendar">Выберите академический календарь:</label>
                    <select id="importCalendarSelect" class="field-input" disabled>
                        <option value="" data-translate="select_branch_first">Сначала выберите филиал...</option>
                    </select>
                </div>
                
                <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="drop-zone-icon">📁</div>
                    <div class="drop-zone-text" data-translate="drag_drop_file">Перетащите XML файл сюда или кликните для выбора</div>
                    <div class="drop-zone-hint" data-translate="supported_files">Поддерживаются файлы .xml</div>
                    <input type="file" id="fileInput" class="file-input" accept=".xml" onchange="testFileSelect(this)">
                </div>
                
                <div class="import-progress" id="importProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText" data-translate="preparing_import">Подготовка к импорту...</div>
                </div>
                
                <div class="import-results" id="importResults">
                    <h4>Результаты импорта:</h4>
                    <div id="resultsList"></div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Отмена</button>
                <button type="button" class="btn btn-primary" id="importBtn" onclick="startImport()" disabled>Импортировать</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Подтверждение</h2>
                <span class="close" onclick="closeConfirmModal()">&times;</span>
            </div>
            <p id="confirmMessage">Вы уверены, что хотите выполнить это действие?</p>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmBtn">Подтвердить</button>
            </div>
        </div>
    </div>

    <!-- Контейнер для уведомлений -->
    <div id="notificationContainer"></div>

    <script>
        // Система переводов
        const translations = {
            ru: {
                // Заголовки
                'timetable_title': 'Расписание занятий',
                'create_calendar': 'Создать академический календарь',
                'import_timetable': 'Импорт расписания из XML',
                'create_lesson': 'Создать занятие',
                'edit_lesson': 'Редактировать занятие',
                
                // Фильтры
                'branch': 'Филиал',
                'academic_calendar': 'Академический календарь',
                'group': 'Группа',
                'teacher': 'Преподаватель',
                'room': 'Аудитория',
                'subject': 'Предмет',
                
                // Кнопки
                'create': 'Создать',
                'edit': 'Редактировать',
                'delete': 'Удалить',
                'save': 'Сохранить',
                'cancel': 'Отмена',
                'import': 'Импорт',
                'export': 'Экспорт',
                'search': 'Поиск',
                'clear': 'Очистить',
                
                // Формы
                'academic_year': 'Учебный год',
                'semester': 'Семестр',
                'first_semester': '1 семестр',
                'second_semester': '2 семестр',
                'start_date': 'Дата начала',
                'end_date': 'Дата окончания',
                'select_branch': 'Выберите филиал...',
                'select_calendar': 'Выберите академический календарь...',
                'select_group': 'Выберите группу...',
                'select_teacher': 'Выберите преподавателя...',
                'select_room': 'Выберите аудиторию...',
                'select_subject': 'Выберите предмет...',
                
                // Сообщения
                'calendar_created': 'Академический календарь успешно создан!',
                'calendar_updated': 'Академический календарь успешно обновлен!',
                'lesson_created': 'Занятие успешно создано!',
                'lesson_updated': 'Занятие успешно обновлено!',
                'lesson_deleted': 'Занятие успешно удалено!',
                'import_success': 'Импорт успешно завершен!',
                'error_loading': 'Ошибка загрузки',
                'error_creating': 'Ошибка создания',
                'error_updating': 'Ошибка обновления',
                'error_deleting': 'Ошибка удаления',
                
                // Плейсхолдеры
                'academic_year_placeholder': 'например: 2024/2025',
                'drag_drop_file': 'Перетащите XML файл сюда или кликните для выбора',
                'supported_files': 'Поддерживаются файлы .xml',
                'preparing_import': 'Подготовка к импорту...',
                'select_semester': 'Выберите семестр',
                'loading': 'Загрузка...',
                'searching': 'Поиск...',
                'timetable_subtitle': 'Университетское расписание',
                'error_invalid_year_format': 'Неверный формат учебного года. Используйте формат: 2024/2025',
                'select_branch_first': 'Сначала выберите филиал...',
                'select_calendar_first': 'Сначала выберите календарь',
                'update_calendar': 'Обновить календарь',

                'edit_calendar': 'Редактировать календарь',
                'create_new_calendar': 'Создать новый календарь',
                'calendar_updated': 'Календарь обновлен',
                'error_updating': 'Ошибка обновления',
                'error_loading_calendar': 'Ошибка загрузки календаря',
                'time': 'Время',
                'optional': '(необязательно)',
                'select_subject_or_enter': 'Выберите предмет или введите название',
                'select_teacher_or_enter': 'Выберите преподавателя или введите имя',
                'select_rooms': 'Выберите аудитории...',
                'search_rooms': 'Поиск аудиторий...',
                'clear_rooms': 'Очистить аудитории',
                'select_groups': 'Выберите группы...',
                'search_groups': 'Поиск групп...',
                'clear_groups': 'Очистить группы',
                'lesson_number': 'Номер урока',
                'select_lesson_number': 'Выберите номер урока',
                'week_day': 'День недели',
                'select_week_day': 'Выберите день недели',
                'lesson_type': 'Тип занятия',
                'select_lesson_type': 'Выберите тип занятия',
                'lecture': 'Лекция',
                'seminar': 'Семинар',
                'exam': 'Экзамен',
                'event': 'Событие',
                'unknown': 'Неизвестно',
                
                // Дни недели
                'monday': 'Понедельник',
                'tuesday': 'Вторник',
                'wednesday': 'Среда',
                'thursday': 'Четверг',
                'friday': 'Пятница',
                'saturday': 'Суббота',
                'sunday': 'Воскресенье'
            },
            en: {
                // Headers
                'timetable_title': 'Class Schedule',
                'create_calendar': 'Create Academic Calendar',
                'import_timetable': 'Import Schedule from XML',
                'create_lesson': 'Create Lesson',
                'edit_lesson': 'Edit Lesson',
                
                // Filters
                'branch': 'Branch',
                'academic_calendar': 'Academic Calendar',
                'group': 'Group',
                'teacher': 'Teacher',
                'room': 'Room',
                'subject': 'Subject',
                
                // Buttons
                'create': 'Create',
                'edit': 'Edit',
                'delete': 'Delete',
                'save': 'Save',
                'cancel': 'Cancel',
                'import': 'Import',
                'export': 'Export',
                'search': 'Search',
                'clear': 'Clear',
                
                // Forms
                'academic_year': 'Academic Year',
                'semester': 'Semester',
                'first_semester': '1st Semester',
                'second_semester': '2nd Semester',
                'start_date': 'Start Date',
                'end_date': 'End Date',
                'select_branch': 'Select branch...',
                'select_calendar': 'Select academic calendar...',
                'select_group': 'Select group...',
                'select_teacher': 'Select teacher...',
                'select_room': 'Select room...',
                'select_subject': 'Select subject...',
                
                // Messages
                'calendar_created': 'Academic calendar created successfully!',
                'calendar_updated': 'Academic calendar updated successfully!',
                'lesson_created': 'Lesson created successfully!',
                'lesson_updated': 'Lesson updated successfully!',
                'lesson_deleted': 'Lesson deleted successfully!',
                'import_success': 'Import completed successfully!',
                'error_loading': 'Error loading',
                'error_creating': 'Error creating',
                'error_updating': 'Error updating',
                'error_deleting': 'Error deleting',
                
                // Placeholders
                'academic_year_placeholder': 'e.g.: 2024/2025',
                'drag_drop_file': 'Drag and drop XML file here or click to select',
                'supported_files': 'Supported files: .xml',
                'preparing_import': 'Preparing import...',
                'select_semester': 'Select semester',
                'loading': 'Loading...',
                'searching': 'Searching...',
                'timetable_subtitle': 'University Schedule',
                'error_invalid_year_format': 'Invalid academic year format. Use format: 2024/2025',
                'select_branch_first': 'Select branch first...',
                'select_calendar_first': 'Select calendar first',
                'update_calendar': 'Update calendar',

                'edit_calendar': 'Edit calendar',
                'create_new_calendar': 'Create new calendar',
                'calendar_updated': 'Calendar updated',
                'error_updating': 'Error updating',
                'error_loading_calendar': 'Error loading calendar',
                'time': 'Time',
                'optional': '(optional)',
                'select_subject_or_enter': 'Select subject or enter name',
                'select_teacher_or_enter': 'Select teacher or enter name',
                'select_rooms': 'Select rooms...',
                'search_rooms': 'Search rooms...',
                'clear_rooms': 'Clear rooms',
                'select_groups': 'Select groups...',
                'search_groups': 'Search groups...',
                'clear_groups': 'Clear groups',
                'lesson_number': 'Lesson number',
                'select_lesson_number': 'Select lesson number',
                'week_day': 'Week day',
                'select_week_day': 'Select week day',
                'lesson_type': 'Lesson type',
                'select_lesson_type': 'Select lesson type',
                'lecture': 'Lecture',
                'seminar': 'Seminar',
                'exam': 'Exam',
                'event': 'Event',
                'unknown': 'Unknown',
                
                // Days of week
                'monday': 'Monday',
                'tuesday': 'Tuesday',
                'wednesday': 'Wednesday',
                'thursday': 'Thursday',
                'friday': 'Friday',
                'saturday': 'Saturday',
                'sunday': 'Sunday'
            },
            uz: {
                // Sarlavhalar
                'timetable_title': 'Dars jadvali',
                'create_calendar': 'Akademik kalendar yaratish',
                'import_timetable': 'XML dan jadvalni import qilish',
                'create_lesson': 'Dars yaratish',
                'edit_lesson': 'Darsni tahrirlash',
                
                // Filtrlar
                'branch': 'Filial',
                'academic_calendar': 'Akademik kalendar',
                'group': 'Guruh',
                'teacher': 'O\'qituvchi',
                'room': 'Xona',
                'subject': 'Fan',
                
                // Tugmalar
                'create': 'Yaratish',
                'edit': 'Tahrirlash',
                'delete': 'O\'chirish',
                'save': 'Saqlash',
                'cancel': 'Bekor qilish',
                'import': 'Import',
                'export': 'Eksport',
                'search': 'Qidirish',
                'clear': 'Tozalash',
                
                // Formalar
                'academic_year': 'O\'quv yili',
                'semester': 'Semestr',
                'first_semester': '1-semestr',
                'second_semester': '2-semestr',
                'start_date': 'Boshlanish sanasi',
                'end_date': 'Tugash sanasi',
                'select_branch': 'Filialni tanlang...',
                'select_calendar': 'Akademik kalendarni tanlang...',
                'select_group': 'Guruhni tanlang...',
                'select_teacher': 'O\'qituvchini tanlang...',
                'select_room': 'Xonani tanlang...',
                'select_subject': 'Fanni tanlang...',
                
                // Xabarlar
                'calendar_created': 'Akademik kalendar muvaffaqiyatli yaratildi!',
                'calendar_updated': 'Akademik kalendar muvaffaqiyatli yangilandi!',
                'lesson_created': 'Dars muvaffaqiyatli yaratildi!',
                'lesson_updated': 'Dars muvaffaqiyatli yangilandi!',
                'lesson_deleted': 'Dars muvaffaqiyatli o\'chirildi!',
                'import_success': 'Import muvaffaqiyatli yakunlandi!',
                'error_loading': 'Yuklash xatosi',
                'error_creating': 'Yaratish xatosi',
                'error_updating': 'Yangilash xatosi',
                'error_deleting': 'O\'chirish xatosi',
                
                // Placeholderlar
                'academic_year_placeholder': 'masalan: 2024/2025',
                'drag_drop_file': 'XML faylni bu yerga tashlang yoki tanlash uchun bosing',
                'supported_files': 'Qo\'llab-quvvatlanadigan fayllar: .xml',
                'preparing_import': 'Import tayyorlanmoqda...',
                'select_semester': 'Semestrni tanlang',
                'loading': 'Yuklanmoqda...',
                'searching': 'Qidirilmoqda...',
                'timetable_subtitle': 'Universitet jadvali',
                'error_invalid_year_format': 'Noto\'g\'ri o\'quv yili formati. Formatni ishlating: 2024/2025',
                'select_branch_first': 'Avval filialni tanlang...',
                'select_calendar_first': 'Avval kalendarni tanlang',
                'update_calendar': 'Kalendarni yangilash',

                'edit_calendar': 'Kalendarni tahrirlash',
                'create_new_calendar': 'Yangi kalendar yaratish',
                'calendar_updated': 'Kalendar yangilandi',
                'error_updating': 'Yangilash xatosi',
                'error_loading_calendar': 'Kalendarni yuklash xatosi',
                'time': 'Vaqt',
                'optional': '(ixtiyoriy)',
                'select_subject_or_enter': 'Fanni tanlang yoki nomini kiriting',
                'select_teacher_or_enter': 'O\'qituvchini tanlang yoki ismini kiriting',
                'select_rooms': 'Xonalarni tanlang...',
                'search_rooms': 'Xonalarni qidirish...',
                'clear_rooms': 'Xonalarni tozalash',
                'select_groups': 'Guruhlarni tanlang...',
                'search_groups': 'Guruhlarni qidirish...',
                'clear_groups': 'Guruhlarni tozalash',
                'lesson_number': 'Dars raqami',
                'select_lesson_number': 'Dars raqamini tanlang',
                'week_day': 'Hafta kuni',
                'select_week_day': 'Hafta kunini tanlang',
                'lesson_type': 'Dars turi',
                'select_lesson_type': 'Dars turini tanlang',
                'lecture': 'Ma\'ruza',
                'seminar': 'Seminar',
                'exam': 'Imtihon',
                'event': 'Tadbir',
                'unknown': 'Noma\'lum',
                
                // Hafta kunlari
                'monday': 'Dushanba',
                'tuesday': 'Seshanba',
                'wednesday': 'Chorshanba',
                'thursday': 'Payshanba',
                'friday': 'Juma',
                'saturday': 'Shanba',
                'sunday': 'Yakshanba'
            }
        };

        // Функция для получения перевода
        function t(key) {
            return translations[currentLanguage]?.[key] || translations.ru[key] || key;
        }

        // Функция для обновления дат в заголовках таблицы
        function updateWeekDates() {
            const today = new Date();
            const currentDay = today.getDay(); // 0 = воскресенье, 1 = понедельник, ...
            
            // Находим понедельник текущей недели
            const monday = new Date(today);
            const daysToMonday = currentDay === 0 ? 6 : currentDay - 1; // Если воскресенье, то понедельник был 6 дней назад
            monday.setDate(today.getDate() - daysToMonday);
            
            // Массив дней недели
            const weekDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            
            // Обновляем даты для каждого дня
            weekDays.forEach((day, index) => {
                const date = new Date(monday);
                date.setDate(monday.getDate() + index);
                
                const dateElement = document.getElementById(`${day}-date`);
                console.log(`Looking for element: ${day}-date`, dateElement); // Отладочная информация
                
                if (dateElement) {
                    const dayOfMonth = date.getDate();
                    const month = date.getMonth() + 1;
                    const dateText = `${dayOfMonth.toString().padStart(2, '0')}.${month.toString().padStart(2, '0')}`;
                    dateElement.textContent = dateText;
                    console.log(`Updated ${day}-date with: ${dateText}`); // Отладочная информация
                    
                    // Подсвечиваем текущий день
                    if (date.toDateString() === today.toDateString()) {
                        dateElement.style.color = '#ffd700';
                        dateElement.style.fontWeight = 'bold';
                    } else {
                        dateElement.style.color = 'rgba(255, 255, 255, 0.8)';
                        dateElement.style.fontWeight = '400';
                    }
                } else {
                    console.log(`Element ${day}-date not found!`); // Отладочная информация
                }
            });
        }

        // Функция для обновления академического календаря
        async function updateAcademicCalendar(calendarId, updateData) {
            try {
                const response = await fetch(`${ACADEMIC_CALENDARS_API_URL}${calendarId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error(`Ошибка обновления календаря: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                showNotification(t('calendar_updated'), 'success');
                
                // Обновляем список календарей если нужно
                if (selectedValues.branch.id) {
                    loadCalendarsForBranch();
                }
                
                return result;
            } catch (error) {
                showNotification(`${t('error_updating')}: ${error.message}`, 'error');
                throw error;
            }
        }



        // Функция для редактирования календаря
        async function editCalendar(calendarId, event) {
            event.stopPropagation();
            
            try {
                // Получаем данные календаря
                const response = await fetch(`${ACADEMIC_CALENDARS_API_URL}${calendarId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const calendar = await response.json();
                
                // Загружаем филиалы и выбираем правильный
                await loadBranchesForCreate();
                
                // Заполняем модальное окно данными для редактирования
                const modalLabel = document.getElementById('createCalendarModalLabel');
                if (modalLabel) {
                    modalLabel.textContent = t('edit_calendar');
                }
                document.getElementById('academicYear').value = calendar.academic_year;
                document.getElementById('semesterSelect').value = calendar.semester;
                document.getElementById('startDateInput').value = calendar.start_date;
                document.getElementById('endDateInput').value = calendar.end_date;
                
                // Выбираем правильный филиал
                const branchSelect = document.getElementById('branchSelect');
                if (branchSelect && calendar.branch_id) {
                    branchSelect.value = calendar.branch_id;
                }
                
                // Показываем модальное окно
                const modal = new bootstrap.Modal(document.getElementById('createCalendarModal'));
                modal.show();
                
                // Сохраняем ID календаря для обновления
                document.getElementById('createCalendarModal').setAttribute('data-edit-id', calendarId);
                
            } catch (error) {
                console.error('Ошибка загрузки календаря для редактирования:', error);
                showNotification(t('error_loading_calendar'), 'error');
            }
        }



        // Функции для работы с уведомлениями
        let notificationCounter = 0;
        
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const currentId = ++notificationCounter;
            notification.dataset.id = currentId;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            notification.innerHTML = `
                <span class="notification-icon">${icons[type] || icons.info}</span>
                <span class="notification-message">${message}</span>
                <button class="notification-close" onclick="removeNotification(${currentId})">×</button>
            `;
            
            // Добавляем уведомление в начало контейнера (сверху)
            container.insertBefore(notification, container.firstChild);
            
            // Показываем уведомление с анимацией
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Автоматически скрываем через указанное время
            if (duration > 0) {
                setTimeout(() => {
                    // Удаляем уведомление напрямую по элементу
                    if (notification.parentElement) {
                        notification.classList.remove('show');
                        notification.classList.add('hide');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }
            
            return currentId;
        }
        
        function removeNotification(id) {
            const notification = document.querySelector(`[data-id="${id}"]`);
            if (notification) {
                notification.classList.remove('show');
                notification.classList.add('hide');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }
        

        
        function clearAllNotifications() {
            const container = document.getElementById('notificationContainer');
            const notifications = container.querySelectorAll('.notification');
            notifications.forEach(notification => {
                notification.classList.remove('show');
                notification.classList.add('hide');
            });
            setTimeout(() => {
                container.innerHTML = '';
            }, 300);
        }

        // Переменные для импорта
        let selectedFile = null;
        let selectedCalendarId = null;

        // Функции для работы с созданием календаря
        function openCreateCalendarModal() {
            const modal = document.getElementById('createCalendarModal');
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            loadBranchesForCreate();
        }

        function closeCreateCalendarModal() {
            const modal = document.getElementById('createCalendarModal');
            const bootstrapModal = bootstrap.Modal.getInstance(modal);
            if (bootstrapModal) {
                bootstrapModal.hide();
            }
            document.getElementById('createCalendarForm').reset();
            
            // Очищаем данные редактирования
            modal.removeAttribute('data-edit-id');
            const modalLabel = document.getElementById('createCalendarModalLabel');
            if (modalLabel) {
                modalLabel.textContent = t('create_calendar');
            }
        }

        async function loadBranchesForCreate() {
            try {
                // Используем кэшированные данные если они есть
                if (fullListsCache.branch && fullListsCache.branch.length > 0) {
                    const select = document.getElementById('branchSelect');
                    select.innerHTML = `<option value="">${t('select_branch')}</option>`;
                    
                    fullListsCache.branch.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.id;
                        option.textContent = getBranchDisplayName(branch);
                        select.appendChild(option);
                    });
                    
                    // Автоматически выбираем текущий филиал если он выбран
                    if (selectedValues.branch && selectedValues.branch.id) {
                        select.value = selectedValues.branch.id;
                    }
                } else {
                    // Если кэш пуст, загружаем данные
                    const response = await fetch(`${BRANCHES_API_URL}?disable_pagination=true`);
                    if (response.ok) {
                        const data = await response.json();
                        const branches = data.items || data;
                        const select = document.getElementById('branchSelect');
                        select.innerHTML = `<option value="">${t('select_branch')}</option>`;
                        
                        branches.forEach(branch => {
                            const option = document.createElement('option');
                            option.value = branch.id;
                            option.textContent = getBranchDisplayName(branch);
                            select.appendChild(option);
                        });
                        
                        // Автоматически выбираем текущий филиал если он выбран
                        if (selectedValues.branch && selectedValues.branch.id) {
                            select.value = selectedValues.branch.id;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading branches for create:', error);
                showNotification(t('error_loading'), 'error');
            }
        }


        

        

        

        


        async function createAcademicCalendar() {
            const form = document.getElementById('createCalendarForm');
            const formData = new FormData(form);
            
            // Валидация формата учебного года
            const academicYear = formData.get('academicYear');
            if (!/^\d{4}\/\d{4}$/.test(academicYear)) {
                showNotification(t('error_invalid_year_format'), 'error');
                return;
            }
            
            const calendarData = {
                branch_id: formData.get('branchSelect'), // Используем UUID как строку
                academic_year: academicYear,
                semester: parseInt(formData.get('semester')),
                start_date: formData.get('startDate'),
                end_date: formData.get('endDate')
            };

            // Проверяем, редактируем ли мы существующий календарь
            const editId = document.getElementById('createCalendarModal').getAttribute('data-edit-id');
            const isEditing = editId !== null;

            try {
                const url = isEditing ? `${ACADEMIC_CALENDARS_API_URL}${editId}` : ACADEMIC_CALENDARS_API_URL;
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(calendarData)
                });

                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                showNotification(isEditing ? t('calendar_updated') : t('calendar_created'), 'success');
                closeCreateCalendarModal();
                
                // Обновляем список календарей если нужно
                if (selectedValues.branch.id) {
                    loadCalendarsForBranch();
                }
            } catch (error) {
                showNotification(`${isEditing ? t('error_updating') : t('error_creating')}: ${error.message}`, 'error');
            }
        }

        // Функции для работы с импортом
        function openImportModal() {
            console.log('openImportModal called');
            const modal = document.getElementById('importModal');
            modal.style.display = 'block';
            loadBranchesForImport();
            console.log('Setting up drag and drop...');
            setupFileDragAndDrop();
            console.log('Drag and drop setup complete');
        }

        function closeImportModal() {
            const modal = document.getElementById('importModal');
            modal.style.display = 'none';
            resetImportForm();
        }

        function resetImportForm() {
            selectedFile = null;
            document.getElementById('dropZone').classList.remove('drag-over');
            document.getElementById('dropZone').innerHTML = `
                <div class="drop-zone-icon">📁</div>
                <div class="drop-zone-text" data-translate="drag_drop_file">Перетащите XML файл сюда или кликните для выбора</div>
                <div class="drop-zone-hint" data-translate="supported_files">Поддерживаются файлы .xml</div>
                <input type="file" id="fileInput" class="file-input" accept=".xml">
            `;
            document.getElementById('importBranchSelect').value = '';
            document.getElementById('importCalendarSelect').innerHTML = `<option value="">${t('select_branch_first')}</option>`;
            document.getElementById('importCalendarSelect').disabled = true;
            document.getElementById('importBtn').disabled = true;
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importResults').style.display = 'none';
            setupFileDragAndDrop();
        }

        async function loadBranchesForImport() {
            try {
                const response = await fetch(`${BRANCHES_API_URL}?disable_pagination=true`);
                if (response.ok) {
                    const data = await response.json();
                    const branches = data.items || data;
                    const select = document.getElementById('importBranchSelect');
                    select.innerHTML = `<option value="">${t('select_branch')}</option>`;
                    
                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.id;
                        option.textContent = getBranchDisplayName(branch);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                showNotification(t('error_loading'), 'error');
            }
        }



        function setupFileDragAndDrop() {
            console.log('=== SETUP FILE DRAG AND DROP ===');
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            console.log('Drop zone found:', dropZone);
            console.log('File input found:', fileInput);
            console.log('Drop zone HTML:', dropZone ? dropZone.outerHTML : 'NOT FOUND');
            
            if (!dropZone || !fileInput) {
                console.error('Drop zone or file input not found!');
                return;
            }

            // Обработчик drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
                console.log('=== DRAG OVER ===');
                console.log('Event target:', e.target);
                console.log('Drop zone:', dropZone);
            });

            dropZone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
                console.log('Drag enter drop zone');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Проверяем, что мы действительно покидаем drop zone
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('drag-over');
                    console.log('Drag leave drop zone');
                }
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
                console.log('=== FILE DROPPED ===');
                console.log('Event target:', e.target);
                console.log('DataTransfer files:', e.dataTransfer.files);
                console.log('Files length:', e.dataTransfer.files.length);
                
                const files = e.dataTransfer.files;
                console.log('Files in drop event:', files.length);
                
                if (files.length > 0) {
                    const file = files[0];
                    console.log('File dropped:', file.name, file.type);
                    
                    if (file.type === 'text/xml' || file.name.endsWith('.xml')) {
                        console.log('Valid XML file, processing...');
                        
                        // Показываем уведомление
                        showNotification(`Файл выбран: ${file.name}`, 'success');

                        // Обновляем drop zone
                        const dropZone = document.getElementById('dropZone');
                        dropZone.innerHTML = `
                            <div class="drop-zone-icon">✅</div>
                            <div class="drop-zone-text">Файл выбран: ${file.name}</div>
                            <div class="drop-zone-hint">Размер: ${(file.size / 1024).toFixed(1)} KB</div>
                            <button class="btn btn-sm btn-secondary" onclick="resetFileSelection()">Изменить файл</button>
                            <input type="file" id="fileInput" class="file-input" accept=".xml" onchange="testFileSelect(this)">
                        `;
                        // Убираем onclick с drop zone, так как теперь есть кнопка
                        dropZone.removeAttribute('onclick');

                        // Сохраняем файл
                        selectedFile = file;
                        console.log('File saved to selectedFile:', selectedFile);

                        // Проверяем готовность импорта
                        checkImportReady();
                    } else {
                        console.log('Invalid file type:', file.type);
                        showNotification('Пожалуйста, выберите XML файл', 'warning');
                    }
                } else {
                    console.log('No files in drop event');
                }
            });
            
            console.log('File drag and drop setup complete');
        }

        function handleFileSelect(file) {
            console.log('handleFileSelect called with file:', file);
            selectedFile = file;
            
            // Обновляем отображение
            const dropZone = document.getElementById('dropZone');
            console.log('Updating drop zone display');
            
            dropZone.innerHTML = `
                <div class="drop-zone-icon">✅</div>
                <div class="drop-zone-text">Файл выбран: ${file.name}</div>
                <div class="drop-zone-hint">Размер: ${(file.size / 1024).toFixed(1)} KB</div>
                <button class="btn btn-sm btn-secondary" onclick="resetFileSelection()">Изменить файл</button>
                <input type="file" id="fileInput" class="file-input" accept=".xml">
            `;
            
            console.log('Drop zone updated, calling checkImportReady');
            checkImportReady();
        }

        function resetFileSelection() {
            console.log('resetFileSelection called');
            selectedFile = null;
            
            // Восстанавливаем drop zone
            const dropZone = document.getElementById('dropZone');
            dropZone.innerHTML = `
                <div class="drop-zone-icon">📁</div>
                <div class="drop-zone-text" data-translate="drag_drop_file">Перетащите XML файл сюда или кликните для выбора</div>
                <div class="drop-zone-hint" data-translate="supported_files">Поддерживаются файлы .xml</div>
                <input type="file" id="fileInput" class="file-input" accept=".xml" onchange="testFileSelect(this)">
            `;
            // Восстанавливаем onclick
            dropZone.onclick = function() {
                document.getElementById('fileInput').click();
            };
            
            // Проверяем готовность импорта
            checkImportReady();
        }

        // Простая тестовая функция для выбора файла
        function testFileSelect(input) {
            console.log('=== TEST FILE SELECT ===');
            console.log('Input element:', input);
            console.log('Input files:', input.files);
            console.log('Files length:', input.files ? input.files.length : 'no files');
            
            if (input.files && input.files.length > 0) {
                const file = input.files[0];
                console.log('File selected:', file);
                console.log('File name:', file.name);
                console.log('File type:', file.type);
                console.log('File size:', file.size);
                
                // Показываем уведомление
                showNotification(`Файл выбран: ${file.name}`, 'success');
                
                // Обновляем drop zone
                const dropZone = document.getElementById('dropZone');
                dropZone.innerHTML = `
                    <div class="drop-zone-icon">✅</div>
                    <div class="drop-zone-text">Файл выбран: ${file.name}</div>
                    <div class="drop-zone-hint">Размер: ${(file.size / 1024).toFixed(1)} KB</div>
                    <button class="btn btn-sm btn-secondary" onclick="resetFileSelection()">Изменить файл</button>
                    <input type="file" id="fileInput" class="file-input" accept=".xml" onchange="testFileSelect(this)">
                `;
                // Убираем onclick с drop zone, так как теперь есть кнопка
                dropZone.removeAttribute('onclick');
                
                // Сохраняем файл
                selectedFile = file;
                console.log('File saved to selectedFile:', selectedFile);
                
                // Проверяем готовность импорта
                checkImportReady();
            } else {
                console.log('No file selected - this is normal when just opening the dialog');
                // Не показываем уведомление, если файл просто не выбран (это нормально)
            }
        }

        function checkImportReady() {
            console.log('checkImportReady called');
            const branchSelect = document.getElementById('importBranchSelect');
            const calendarSelect = document.getElementById('importCalendarSelect');
            const importBtn = document.getElementById('importBtn');
            
            console.log('selectedFile:', selectedFile);
            console.log('branchSelect.value:', branchSelect.value);
            console.log('calendarSelect.value:', calendarSelect.value);
            
            if (selectedFile && branchSelect.value && calendarSelect.value) {
                console.log('All conditions met, enabling import button');
                importBtn.disabled = false;
            } else {
                console.log('Some conditions not met, disabling import button');
                importBtn.disabled = true;
            }
        }

        // Обработчик изменения календаря
        function setupImportCalendarHandler() {
            const calendarSelect = document.getElementById('importCalendarSelect');
            if (calendarSelect) {
                calendarSelect.addEventListener('change', function() {
                    checkImportReady();
                });
            }
        }

        async function startImport() {
            const branchSelect = document.getElementById('importBranchSelect');
            const calendarSelect = document.getElementById('importCalendarSelect');
            
            if (!selectedFile || !branchSelect.value || !calendarSelect.value) {
                showNotification('Пожалуйста, выберите файл, филиал и календарь', 'warning');
                return;
            }

            const progressDiv = document.getElementById('importProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const resultsDiv = document.getElementById('importResults');
            const resultsList = document.getElementById('resultsList');

            // Показываем прогресс
            progressDiv.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Загрузка файла...';

            try {
                // Читаем файл
                const formData = new FormData();
                formData.append('file', selectedFile);

                progressFill.style.width = '30%';
                progressText.textContent = 'Отправка файла на сервер...';

                // Отправляем файл на сервер
                const response = await fetch(`${TIMETABLES_API_URL}parse?academic_calendar_id=${calendarSelect.value}`, {
                    method: 'POST',
                    body: formData
                });

                progressFill.style.width = '60%';
                progressText.textContent = 'Обработка данных...';

                if (!response.ok) {
                    throw new Error(`Ошибка сервера: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                progressFill.style.width = '100%';
                progressText.textContent = 'Импорт завершен!';

                // Показываем результаты
                resultsDiv.style.display = 'block';
                resultsList.innerHTML = '';

                if (result.success) {
                    showNotification('Импорт успешно завершен!', 'success');
                    
                    // Добавляем результаты
                    if (result.imported_lessons) {
                        const successItem = document.createElement('div');
                        successItem.className = 'result-item result-success';
                        successItem.textContent = `✅ Импортировано уроков: ${result.imported_lessons}`;
                        resultsList.appendChild(successItem);
                    }

                    if (result.errors && result.errors.length > 0) {
                        const errorItem = document.createElement('div');
                        errorItem.className = 'result-item result-error';
                        errorItem.textContent = `❌ Ошибок: ${result.errors.length}`;
                        resultsList.appendChild(errorItem);
                    }

                    // Перезагружаем расписание
                    setTimeout(() => {
                        loadTimetable();
                    }, 1000);
                } else {
                    showNotification('Ошибка при импорте', 'error');
                    
                    if (result.errors) {
                        result.errors.forEach(error => {
                            const errorItem = document.createElement('div');
                            errorItem.className = 'result-item result-error';
                            errorItem.textContent = `❌ ${error}`;
                            resultsList.appendChild(errorItem);
                        });
                    }
                }

            } catch (error) {
                showNotification(`Ошибка импорта: ${error.message}`, 'error');
                
                progressFill.style.width = '0%';
                progressText.textContent = 'Ошибка импорта';
                
                resultsDiv.style.display = 'block';
                resultsList.innerHTML = `
                    <div class="result-item result-error">
                        ❌ Ошибка: ${error.message}
                    </div>
                `;
            }
        }



        // Заменяем alert на уведомления
        function showAlert(message, type = 'info') {
            showNotification(message, type, 8000); // 8 секунд для alert-сообщений
        }

        // Конфигурация времени уроков
        const periods = [
            { period: 1, starttime: "9:00", endtime: "9:50" },
            { period: 2, starttime: "10:00", endtime: "10:50" },
            { period: 3, starttime: "11:00", endtime: "11:50" },
            { period: 4, starttime: "12:00", endtime: "12:50" },
            { period: 5, starttime: "13:00", endtime: "13:50" },
            { period: 6, starttime: "14:00", endtime: "14:50" },
            { period: 7, starttime: "15:00", endtime: "15:50" },
            { period: 8, starttime: "16:00", endtime: "16:50" },
            { period: 9, starttime: "17:00", endtime: "17:50" },
            { period: 10, starttime: "18:00", endtime: "18:50" },
            { period: 11, starttime: "19:00", endtime: "19:50" },
            { period: 12, starttime: "20:00", endtime: "20:50" }
        ];

        // Дни недели (0-5: понедельник-суббота)
        const weekDays = [
            { id: 0, name: "Понедельник" },
            { id: 1, name: "Вторник" },
            { id: 2, name: "Среда" },
            { id: 3, name: "Четверг" },
            { id: 4, name: "Пятница" },
            { id: 5, name: "Суббота" }
        ];

        // URL вашего API
        const API_URL = 'http://172.16.3.77:8000/api';
        const BRANCHES_API_URL = `${API_URL}/branches/`;
        const TIMETABLES_API_URL = `${API_URL}/timetables/`;
        const ACADEMIC_CALENDARS_API_URL = `${API_URL}/academic-calendars/`;
        const GROUPS_API_URL = `${API_URL}/groups/`;
        const TEACHERS_API_URL = `${API_URL}/teachers/`;
        const ROOMS_API_URL = `${API_URL}/rooms/`;
        const SUBJECTS_API_URL = `${API_URL}/subjects/`;

        // Хранение выбранных значений
        let selectedValues = {
            branch: { id: '', name: '' },
            calendar: { id: '', name: '' },
            group: { id: '', name: '', name_ru: '', name_en: '', name_uz: '' },
            teacher: { id: '', name: '', name_ru: '', name_en: '', name_uz: '' },
            room: { id: '', name: '', name_ru: '', name_en: '', name_uz: '' },
            subject: { id: '', name: '', name_ru: '', name_en: '', name_uz: '' }
        };

        // Функции для работы с localStorage
        function saveSelectedValues() {
            localStorage.setItem('timetableSelectedValues', JSON.stringify(selectedValues));
        }

        function loadSelectedValues() {
            const saved = localStorage.getItem('timetableSelectedValues');
            if (saved) {
                selectedValues = JSON.parse(saved);
                // Восстанавливаем значения в полях ввода
                Object.keys(selectedValues).forEach(type => {
                    const input = document.getElementById(type + 'Input');
                    if (input && selectedValues[type].name) {
                        if (type === 'branch') {
                            input.value = selectedValues[type].name;
                        } else {
                            input.value = selectedValues[type].name;
                        }
                    }
                });
                

            }
            
            // Обновляем состояние полей
            updateFieldStates();
            
            // Обновляем даты в заголовках таблицы
            updateWeekDates();
            
            // Язык будет установлен после загрузки всех элементов
        }

        // Кэш для полных списков
        let fullListsCache = {
            branch: [],
            calendar: [],
            group: [],
            teacher: [],
            room: [],
            subject: []
        };

        // Таймауты для задержки поиска
        let searchTimeouts = {};
        
        // Флаг для отслеживания загружающихся запросов
        let loadingRequests = {
            branch: false,
            calendar: false,
            group: false,
            teacher: false,
            room: false,
            subject: false
        };
        
        // Флаг для предотвращения одновременных действий с dropdown
        let dropdownActionInProgress = {
            branch: false,
            calendar: false,
            group: false,
            teacher: false,
            room: false,
            subject: false
        };

        // Переменные для редактирования
        let currentLessonId = null;
        let draggedLesson = null;
        let pendingChanges = [];
        let originalTimetableState = null; // Сохраняем исходное состояние расписания
        let originalTimetableData = null; // Сохраняем исходные данные расписания
        
        // Переменные для множественного выбора групп
        let selectedGroups = [];
        let allGroups = [];
        
        // Переменные для множественного выбора аудиторий
        let selectedRooms = [];
        let allRooms = [];
        
        // Функция для получения доступных слотов для перемещения
        async function getAvailableSlots(lessonId) {
            try {
                const params = new URLSearchParams();
                
                // Добавляем branch_id если выбран branch
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                const response = await fetch(`${TIMETABLES_API_URL}${lessonId}/available-slots?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`Ошибка получения доступных слотов: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                return [];
            }
        }
        
        // Функция для проверки доступности слота
        async function checkSlotAvailability(lessonId, position) {
            try {
                // Сначала пытаемся использовать кэшированные данные
                const lessonElement = document.querySelector(`[data-lesson-id="${lessonId}"]`);
                let availableSlots = [];
                
                if (lessonElement && lessonElement.dataset.availableSlots) {
                    availableSlots = JSON.parse(lessonElement.dataset.availableSlots);
    
                } else {
                    // Если кэша нет, загружаем с сервера
                    availableSlots = await getAvailableSlots(lessonId);
                }
                
                // Проверяем, есть ли позиция в списке доступных слотов
                const isAvailable = availableSlots.some(slot => 
                    slot.week_day === position.weekDay && 
                    slot.lesson_number === position.lessonNumber
                );
                


                
                return isAvailable;
            } catch (error) {

                // В случае ошибки разрешаем перемещение
                return true;
            }
        }
        

        
        // Функция для показа доступности всех слотов
        async function showDropAvailability() {
            if (!draggedLesson) return;
            
            const lessonId = draggedLesson.dataset.lessonId;
            if (!lessonId) return;
            
            
            
            // Загружаем доступные слоты только для перетаскиваемого урока
            try {
                const availableSlots = await getAvailableSlots(lessonId);

                
                // Сохраняем доступные слоты в data-атрибуте урока для кэширования
                draggedLesson.dataset.availableSlots = JSON.stringify(availableSlots);
                
                const cells = document.querySelectorAll('.lesson-cell');
                
                for (const cell of cells) {
                    // Пропускаем ячейку, из которой перетаскиваем
                    if (cell.contains(draggedLesson)) continue;
                    
                    // Показываем индикацию проверки
                    cell.classList.add('checking-drop');
                    
                    const position = getCellPosition(cell);
                    if (position) {
                        // Проверяем доступность используя загруженные данные
                        const isAvailable = availableSlots.some(slot => 
                            slot.week_day === position.weekDay && 
                            slot.lesson_number === position.lessonNumber
                        );
                        
                        // Убираем класс проверки
                        cell.classList.remove('checking-drop');
                        
                        // Добавляем соответствующий класс
                        if (isAvailable) {
                            cell.classList.add('available-drop');
                        } else {
                            cell.classList.add('unavailable-drop');
                        }
                    }
                }
            } catch (error) {

                // В случае ошибки показываем все слоты как недоступные
                const cells = document.querySelectorAll('.lesson-cell');
                cells.forEach(cell => {
                    if (!cell.contains(draggedLesson)) {
                        cell.classList.add('unavailable-drop');
                    }
                });
            }
        }
        
        // Функция для очистки индикации доступности
        function clearDropAvailability() {
            const cells = document.querySelectorAll('.lesson-cell');
            cells.forEach(cell => {
                cell.classList.remove('available-drop', 'unavailable-drop', 'checking-drop');
            });
        }
        
        // Функция для проверки и показа доступности конкретного слота
        function checkAndShowSlotAvailability(cell) {
            if (!draggedLesson) return;
            
            const lessonId = draggedLesson.dataset.lessonId;
            if (!lessonId) return;
            
            // Пропускаем ячейку, из которой перетаскиваем
            if (cell.contains(draggedLesson)) return;
            
            // Убираем предыдущие классы
            cell.classList.remove('available-drop', 'unavailable-drop', 'checking-drop');
            
            // Используем кэшированные данные доступных слотов
            const availableSlotsData = draggedLesson.dataset.availableSlots;
            if (availableSlotsData) {
                try {
                    const availableSlots = JSON.parse(availableSlotsData);
                    const position = getCellPosition(cell);
                    
                    if (position) {
                        // Проверяем доступность используя кэшированные данные
                        const isAvailable = availableSlots.some(slot => 
                            slot.week_day === position.weekDay && 
                            slot.lesson_number === position.lessonNumber
                        );
                        
                        // Добавляем соответствующий класс
                        if (isAvailable) {
                            cell.classList.add('available-drop');
                        } else {
                            cell.classList.add('unavailable-drop');
                        }
                    }
                } catch (error) {
                    cell.classList.add('unavailable-drop');
                }
            } else {
                // Если кэша нет, показываем как недоступный
                cell.classList.add('unavailable-drop');
            }
        }
        
        // Функция для получения доступных элементов с проверкой конфликтов
        async function getAvailableItems(type, academicCalendarId, weekDay, lessonNumber, excludeLessonId = null) {
            try {
                let apiUrl;
                switch (type) {
                    case 'teachers':
                        apiUrl = TEACHERS_API_URL;
                        break;
                    case 'groups':
                        apiUrl = GROUPS_API_URL;
                        break;
                    case 'rooms':
                        apiUrl = ROOMS_API_URL;
                        break;
                    default:
                        throw new Error(`Неизвестный тип: ${type}`);
                }
                
                // Добавляем параметры для проверки доступности
                const params = new URLSearchParams({
                    academic_calendar_id: academicCalendarId,
                    week_day: weekDay,
                    lesson_number: lessonNumber
                });
                
                // Добавляем branch_id если выбран branch
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                if (excludeLessonId) {
                    params.append('exclude_lesson_id', excludeLessonId);
                }
                
                const response = await fetch(`${apiUrl}?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`Ошибка получения ${type}: ${response.status}`);
                }
                
                const data = await response.json();
                return data.items || data;
            } catch (error) {
                return [];
            }
        }
        
        // Функция для загрузки доступных элементов в модальное окно
        async function loadAvailableItemsForModal(weekDay, lessonNumber, excludeLessonId = null) {
            if (!selectedValues.calendar.id || weekDay === undefined || lessonNumber === undefined) {

                return Promise.resolve();
            }
            
            try {

                
                // Загружаем доступных преподавателей
                const availableTeachers = await getAvailableItems('teachers', selectedValues.calendar.id, weekDay, lessonNumber, excludeLessonId);

                
                // Загружаем доступные группы
                const availableGroups = await getAvailableItems('groups', selectedValues.calendar.id, weekDay, lessonNumber, excludeLessonId);

                
                // Загружаем доступные аудитории
                const availableRooms = await getAvailableItems('rooms', selectedValues.calendar.id, weekDay, lessonNumber, excludeLessonId);

                
                // Обновляем кэш для модального окна
                fullListsCache.teacher = availableTeachers;
                fullListsCache.group = availableGroups;
                fullListsCache.room = availableRooms;
                
                // Обновляем списки для множественного выбора
                allGroups = availableGroups;
                allRooms = availableRooms;
                
                // Обновляем отображение в модальном окне

                updateModalAvailability();
                
                return Promise.resolve();
                
            } catch (error) {
                // В случае ошибки все равно показываем модальное окно
                return Promise.resolve();
            }
        }
        
        // Функция для обновления отображения доступности в модальном окне
        function updateModalAvailability() {
            // Обновляем автодополнение для преподавателей
            const teacherField = document.getElementById('teacherField');
            if (teacherField) {
                // Очищаем текущее значение если преподаватель недоступен
                const currentTeacher = fullListsCache.teacher.find(t => t.name === teacherField.value);
                if (teacherField.value && !currentTeacher) {
                    teacherField.value = '';
                    teacherField.style.backgroundColor = '#ffebee';
                    teacherField.title = 'Этот преподаватель недоступен в данное время';
                } else if (teacherField.value && currentTeacher) {
                    teacherField.style.backgroundColor = 'white';
                    teacherField.title = '';
                }
            }
            
            // Обновляем отображение групп
            updateGroupsDropdownAvailability();
            
            // Обновляем отображение аудиторий
            updateRoomsDropdownAvailability();
            
            // Обновляем отображение выбранных групп и аудиторий
            updateSelectedGroupsDisplay();
            updateSelectedRoomsDisplay();
        }
        
        // Функция для обновления доступности в dropdown групп
        function updateGroupsDropdownAvailability() {
            const dropdown = document.getElementById('groupsDropdown');
            if (!dropdown) return;
            

            
            dropdown.innerHTML = '';
            
            fullListsCache.group.forEach(group => {
                const option = document.createElement('div');
                option.className = 'group-option';
                option.textContent = group.name;
                
                if (group.hasOwnProperty('is_available') && !group.is_available) {
                    option.classList.add('unavailable');
                    option.textContent += ' (недоступна)';
                    option.title = 'Эта группа недоступна в данное время';

                }
                
                option.onclick = () => toggleGroup(group);
                dropdown.appendChild(option);
            });
        }
        
        // Функция для обновления доступности в dropdown аудиторий
        function updateRoomsDropdownAvailability() {
            const dropdown = document.getElementById('roomsDropdown');
            if (!dropdown) return;
            

            
            dropdown.innerHTML = '';
            
            fullListsCache.room.forEach(room => {
                const option = document.createElement('div');
                option.className = 'group-option';
                option.textContent = room.name;
                
                if (room.hasOwnProperty('is_available') && !room.is_available) {
                    option.classList.add('unavailable');
                    option.textContent += ' (недоступна)';
                    option.title = 'Эта аудитория недоступна в данное время';

                }
                
                option.onclick = () => toggleRoom(room);
                dropdown.appendChild(option);
            });
        }

        // Загрузка данных для выпадающих списков
        async function loadDropdownData() {
            try {
                // НЕ загружаем branches здесь, они уже загружены в loadBranches()
                // fullListsCache.branch уже заполнен
                
                // НЕ загружаем фильтры (groups, teachers, rooms, subjects) при инициализации
                // Они будут загружены только при выборе branch и calendar
                
                console.log('loadDropdownData: загружаем только branches при инициализации');
                
            } catch (error) {
                console.error('Ошибка в loadDropdownData:', error);
            }
        }



        // Функции для работы с множественным выбором групп
        async function loadAllGroups() {
            try {
                const params = new URLSearchParams();
                params.append('disable_pagination', 'true');
                
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                const response = await fetch(`${GROUPS_API_URL}?${params.toString()}`);
                if (response.ok) {
                    const data = await response.json();
                    const groups = data.items || data;
                    allGroups = groups;
                    fullListsCache.group = groups;
                    filterGroups(document.getElementById('groupSearch').value.trim().toLowerCase());
                }
            } catch (error) {
            }
        }

        function setupGroupSelector() {
            const groupSearch = document.getElementById('groupSearch');
            const groupsDropdown = document.getElementById('groupsDropdown');
            
            groupSearch.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                if (allGroups.length > 0) {
                    filterGroups(query);
                }
            });
            
            groupSearch.addEventListener('focus', function() {
                // Закрываем другие dropdown при фокусе на новом поле
                hideOtherDropdowns('groupsDropdown');
                activeInput = 'groupSearch';
                
                setTimeout(() => {
                    if (allGroups.length > 0) {
                        showGroupsDropdown();
                        filterGroups(this.value.trim().toLowerCase());
                } else {
                        // Если группы не загружены, загружаем их
                        loadAllGroups();
                    }
                }, 100); // Небольшая задержка
            });
        }

        function filterGroups(query) {
            const groupsDropdown = document.getElementById('groupsDropdown');
            groupsDropdown.innerHTML = '';
            
            const filteredGroups = allGroups.filter(group => 
                group.name.toLowerCase().includes(query)
            );
            
            if (filteredGroups.length === 0) {
                groupsDropdown.innerHTML = '<div class="no-results">Ничего не найдено</div>';
            } else {
                filteredGroups.forEach(group => {
                    const option = document.createElement('div');
                    option.className = 'group-option';
                    option.textContent = group.name;
                    option.dataset.groupId = group.id;
                    option.dataset.groupName = group.name;
                    
                    // Проверяем доступность группы
                    if (group.hasOwnProperty('is_available') && !group.is_available) {
                        option.classList.add('unavailable');
                        option.textContent += ' (недоступна)';
                        option.title = 'Эта группа недоступна в данное время';
                    }
                    
                    // Проверяем, выбрана ли уже эта группа
                    if (selectedGroups.some(sg => sg.id === group.id)) {
                        option.classList.add('selected');
                    }
                    
                    option.addEventListener('click', () => toggleGroup(group));
                    groupsDropdown.appendChild(option);
                });
            }
            
            showGroupsDropdown();
        }

        function showGroupsDropdown() {
            const groupsDropdown = document.getElementById('groupsDropdown');
            groupsDropdown.style.display = 'block';
        }

        function toggleGroup(group) {
            // Проверяем доступность группы
            if (!group.is_available) {
                showAlert('Эта группа недоступна в данное время', 'warning');
                return;
            }
            
            const existingIndex = selectedGroups.findIndex(sg => sg.id === group.id);
            
            if (existingIndex >= 0) {
                // Удаляем группу
                selectedGroups.splice(existingIndex, 1);
            } else {
                // Добавляем группу
                selectedGroups.push(group);
            }
            
            updateSelectedGroupsDisplay();
            // Не закрываем dropdown при выборе группы
            filterGroups(document.getElementById('groupSearch').value);
        }

        function updateSelectedGroupsDisplay() {
            const selectedGroupsContainer = document.getElementById('selectedGroups');
            
            if (selectedGroups.length === 0) {
                selectedGroupsContainer.innerHTML = '<div class="no-groups-selected">Выберите группы...</div>';
            } else {
                selectedGroupsContainer.innerHTML = '';
                selectedGroups.forEach(group => {
                    const tag = document.createElement('div');
                    tag.className = 'selected-group-tag';
                    
                    // Проверяем доступность группы
                    const isAvailable = group.is_available !== false; // По умолчанию доступна
                    if (!isAvailable) {
                        tag.classList.add('unavailable-tag');
                        tag.title = 'Эта группа недоступна в данное время';
                    }
                    
                    tag.innerHTML = `
                        ${group.name}${!isAvailable ? ' (недоступна)' : ''}
                        <button class="remove-group" onclick="removeGroup('${group.id}')">×</button>
                    `;
                    selectedGroupsContainer.appendChild(tag);
                });
            }
        }

        function removeGroup(groupId) {
            selectedGroups = selectedGroups.filter(group => group.id !== groupId);
            updateSelectedGroupsDisplay();
            filterGroups(document.getElementById('groupSearch').value);
        }

        function clearSelectedGroups() {
            selectedGroups = [];
            updateSelectedGroupsDisplay();
        }

        // Функции для работы с множественным выбором аудиторий
        async function loadAllRooms() {
            try {
                const params = new URLSearchParams();
                params.append('disable_pagination', 'true');
                
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                const response = await fetch(`${ROOMS_API_URL}?${params.toString()}`);
                if (response.ok) {
                    const data = await response.json();
                    const rooms = data.items || data;
                    allRooms = rooms;
                    fullListsCache.room = rooms;
                    filterRooms(document.getElementById('roomSearch').value.trim().toLowerCase());
                }
            } catch (error) {
            }
        }

        function setupRoomSelector() {
            const roomSearch = document.getElementById('roomSearch');
            const roomsDropdown = document.getElementById('roomsDropdown');
            
            roomSearch.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                if (allRooms.length > 0) {
                    filterRooms(query);
                }
            });
            
            roomSearch.addEventListener('focus', function() {
                // Закрываем другие dropdown при фокусе на новом поле
                hideOtherDropdowns('roomsDropdown');
                activeInput = 'roomSearch';
                
                setTimeout(() => {
                    if (allRooms.length > 0) {
                        showRoomsDropdown();
                        filterRooms(this.value.trim().toLowerCase());
                    } else {
                        // Если аудитории не загружены, загружаем их
                        loadAllRooms();
                    }
                }, 100); // Небольшая задержка
            });
        }

        function filterRooms(query) {
            const roomsDropdown = document.getElementById('roomsDropdown');
            roomsDropdown.innerHTML = '';
            
            const filteredRooms = allRooms.filter(room => 
                room.name.toLowerCase().includes(query)
            );
            
            if (filteredRooms.length === 0) {
                roomsDropdown.innerHTML = '<div class="no-results">Ничего не найдено</div>';
            } else {
                filteredRooms.forEach(room => {
                    const option = document.createElement('div');
                    option.className = 'group-option';
                    option.textContent = room.name;
                    option.dataset.roomId = room.id;
                    option.dataset.roomName = room.name;
                    
                    // Проверяем доступность аудитории
                    if (room.hasOwnProperty('is_available') && !room.is_available) {
                        option.classList.add('unavailable');
                        option.textContent += ' (недоступна)';
                        option.title = 'Эта аудитория недоступна в данное время';
                    }
                    
                    // Проверяем, выбрана ли уже эта аудитория
                    if (selectedRooms.some(sr => sr.id === room.id)) {
                        option.classList.add('selected');
                    }
                    
                    option.addEventListener('click', () => toggleRoom(room));
                    roomsDropdown.appendChild(option);
                });
            }
            
            showRoomsDropdown();
        }

        function showRoomsDropdown() {
            const roomsDropdown = document.getElementById('roomsDropdown');
            roomsDropdown.style.display = 'block';
        }

        function toggleRoom(room) {
            // Проверяем доступность аудитории
            if (!room.is_available) {
                showAlert('Эта аудитория недоступна в данное время', 'warning');
                return;
            }

            const existingIndex = selectedRooms.findIndex(sr => sr.id === room.id);
            
            if (existingIndex >= 0) {
                // Удаляем аудиторию
                selectedRooms.splice(existingIndex, 1);
            } else {
                // Добавляем аудиторию
                selectedRooms.push(room);
            }
            
            updateSelectedRoomsDisplay();
            // Не закрываем dropdown при выборе аудитории
            filterRooms(document.getElementById('roomSearch').value);
        }

        function updateSelectedRoomsDisplay() {
            const selectedRoomsContainer = document.getElementById('selectedRooms');
            
            if (selectedRooms.length === 0) {
                selectedRoomsContainer.innerHTML = '<div class="no-groups-selected">Выберите аудитории...</div>';
            } else {
                selectedRoomsContainer.innerHTML = '';
                selectedRooms.forEach(room => {
                    const tag = document.createElement('div');
                    tag.className = 'selected-group-tag';
                    
                    // Проверяем доступность аудитории
                    const isAvailable = room.is_available !== false; // По умолчанию доступна
                    if (!isAvailable) {
                        tag.classList.add('unavailable-tag');
                        tag.title = 'Эта аудитория недоступна в данное время';
                    }
                    
                    tag.innerHTML = `
                        ${room.name}${!isAvailable ? ' (недоступна)' : ''}
                        <button class="remove-group" onclick="removeRoom('${room.id}')">×</button>
                    `;
                    selectedRoomsContainer.appendChild(tag);
                });
            }
        }

        function removeRoom(roomId) {
            selectedRooms = selectedRooms.filter(room => room.id !== roomId);
            updateSelectedRoomsDisplay();
            filterRooms(document.getElementById('roomSearch').value);
        }

        function clearSelectedRooms() {
            selectedRooms = [];
            updateSelectedRoomsDisplay();
        }

        // Функция для очистки полей ввода
        function clearField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = '';
            }
        }

        // Функция для отображения типа занятия
        function getLessonTypeDisplay(lessonType) {
            const typeMap = {
                'LECTURE': 'Лекция',
                'SEMINAR': 'Семинар',
                'EXAM': 'Экзамен',
                'EVENT': 'Событие',
                'UNKNOWN': 'Неизвестно'
            };
            return typeMap[lessonType] || lessonType;
        }



        // Функция для настройки drag & drop
        function setupDragAndDrop() {
            
            // Сохраняем исходное состояние при включении drag & drop
            if (!originalTimetableData && window.currentTimetableData) {
                originalTimetableData = JSON.parse(JSON.stringify(window.currentTimetableData));
            }
            
            document.querySelectorAll('.lesson').forEach(lesson => {
                lesson.draggable = true;
                lesson.addEventListener('dragstart', handleDragStart);
                lesson.addEventListener('dragend', handleDragEnd);
            });
            
            document.querySelectorAll('.lesson-cell').forEach(cell => {
                cell.addEventListener('dragover', handleDragOver);
                cell.addEventListener('drop', handleDrop);
                cell.addEventListener('dragenter', handleDragEnter);
                cell.addEventListener('dragleave', handleDragLeave);
            });
        }



        // Функция для получения текущих данных урока
        function getCurrentLessonData(lessonId) {
            const lessonElement = document.querySelector(`[data-lesson-id="${lessonId}"]`);
            if (!lessonElement) return {};
            
            // Получаем данные из скрытого элемента
            const lessonIds = lessonElement.querySelector('.lesson-ids');
            if (!lessonIds) return {};
            
            const currentData = {};
            
            // Получаем subject_id
            const subjectId = lessonIds.dataset.subjectId;
            if (subjectId) currentData.subject_id = subjectId;
            
            // Получаем teacher_id
            const teacherId = lessonIds.dataset.teacherId;
            if (teacherId) currentData.teacher_id = teacherId;
            
            // Получаем rooms
            try {
                const rooms = JSON.parse(lessonIds.dataset.rooms || '[]');
                if (rooms.length > 0) {
                    currentData.room_ids = rooms.map(room => room.id);
                }
            } catch (e) {
            }
            
            // Получаем groups
            try {
                const groups = JSON.parse(lessonIds.dataset.groups || '[]');
                if (groups.length > 0) {
                    currentData.group_ids = groups.map(group => group.id);
                }
            } catch (e) {
            }
            
            // Получаем позиционные данные
            const weekDay = lessonIds.dataset.weekDay;
            if (weekDay !== undefined) currentData.week_day = parseInt(weekDay);
            
            const lessonNumber = lessonIds.dataset.lessonNumber;
            if (lessonNumber !== undefined) currentData.lesson_number = parseInt(lessonNumber);
            
            // Получаем тип занятия
            const lessonType = lessonIds.dataset.lessonType;
            if (lessonType) currentData.lesson_type = lessonType;
            
            // Получаем примечание
            const note = lessonIds.dataset.note;
            if (note) currentData.note = note;
            
            return currentData;
        }

        // Функция для создания объекта только с измененными полями
        function createPartialUpdateData(newData, originalData = {}) {
            const updateData = {};
            
            // Сравниваем каждое поле и добавляем только измененные
            Object.keys(newData).forEach(key => {
                // Специальная обработка для массивов
                if (Array.isArray(newData[key]) && Array.isArray(originalData[key])) {
                    // Сравниваем массивы по содержимому
                    const newArray = newData[key].sort();
                    const originalArray = originalData[key].sort();
                    const arraysEqual = newArray.length === originalArray.length && 
                        newArray.every((val, index) => val === originalArray[index]);
                    
                    if (!arraysEqual) {
                        updateData[key] = newData[key];
                    }
                } else if (newData[key] !== originalData[key]) {
                    // Включаем изменения, но не null для обязательных полей
                    if (key === 'subject_id' || key === 'teacher_id') {
                        // Не отправляем null для обязательных полей
                        if (newData[key] !== null) {
                            updateData[key] = newData[key];
                        }
                    } else {
                        updateData[key] = newData[key];
                    }
                }
            });
            
            return updateData;
        }

        // Функция для создания данных только для перемещения
        function createMoveUpdateData(lessonData) {
            const moveData = {};
            
            // Добавляем только позиционные данные
            if (lessonData.lesson_number !== undefined && lessonData.lesson_number !== null) {
                moveData.lesson_number = lessonData.lesson_number;
            }
            if (lessonData.week_day !== undefined && lessonData.week_day !== null) {
                moveData.week_day = lessonData.week_day;
            }
            
            return moveData;
        }

        // Проверка возможности редактирования
        function canEdit() {
            // Можно редактировать если выбран branch, календарь и хотя бы один фильтр
            return selectedValues.branch.id && selectedValues.calendar.id && (selectedValues.group.id || selectedValues.teacher.id || selectedValues.room.id || selectedValues.subject.id);
        }



        // Drag and Drop функции
        function handleDragStart(e) {
            if (!canEdit()) {
                e.preventDefault();
                showAlert('Для редактирования необходимо выбрать академический календарь и группу, преподавателя или аудиторию');
                return;
            }
            
            draggedLesson = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            
            // Показываем индикацию доступности для всех слотов
            showDropAvailability();
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            
            // Очищаем кэш доступных слотов
            if (draggedLesson && draggedLesson.dataset.availableSlots) {
                delete draggedLesson.dataset.availableSlots;
            }
            
            draggedLesson = null;
            
            // Убираем индикацию доступности
            clearDropAvailability();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Проверяем доступность слота при наведении
            if (e.target.classList.contains('lesson-cell') && draggedLesson) {
                checkAndShowSlotAvailability(e.target);
            }
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            if (draggedLesson && e.target.classList.contains('lesson-cell')) {
                const newPosition = getCellPosition(e.target);
                const oldPosition = getLessonPosition(draggedLesson);
                const lessonId = draggedLesson.dataset.lessonId;
                
                if (newPosition && oldPosition) {
                    // Проверяем доступность нового слота используя кэшированные данные
                    const availableSlotsData = draggedLesson.dataset.availableSlots;
                    let isAvailable = false;
                    
                    if (availableSlotsData) {
                        try {
                            const availableSlots = JSON.parse(availableSlotsData);
                            isAvailable = availableSlots.some(slot => 
                                slot.week_day === newPosition.weekDay && 
                                slot.lesson_number === newPosition.lessonNumber
                            );
                        } catch (error) {
                            
                            isAvailable = true; // В случае ошибки разрешаем перемещение
                        }
                    } else {
                        isAvailable = true;
                    }
                    
                    if (isAvailable) {
                    moveLesson(draggedLesson, oldPosition, newPosition);
                        
                        // Показываем кнопки сохранения/отмены только если есть изменения
                        if (pendingChanges.length > 0) {
                            showDragDropControls();
                        }
                    } else {
                        showAlert('Этот слот недоступен для перемещения');
                    }
                    
                    // Очищаем индикацию доступности
                    clearDropAvailability();
                }
            }
        }

        function getCellPosition(cell) {
            const row = cell.parentElement;
            const dayIndex = Array.from(row.children).indexOf(cell) - 1; // -1 для учета ячейки времени
            const periodIndex = Array.from(row.parentElement.children).indexOf(row);
            
            return {
                weekDay: dayIndex,
                lessonNumber: periodIndex + 1
            };
        }

        function getLessonPosition(lesson) {
            const cell = lesson.closest('.lesson-cell');
            return getCellPosition(cell);
        }

        function moveLesson(lesson, oldPos, newPos) {
            const oldCell = document.querySelector(`tr:nth-child(${oldPos.lessonNumber}) td:nth-child(${oldPos.weekDay + 2})`);
            const newCell = document.querySelector(`tr:nth-child(${newPos.lessonNumber}) td:nth-child(${newPos.weekDay + 2})`);
            
            if (oldCell && newCell) {
                newCell.appendChild(lesson);
                
                // Проверяем и сохраняем lessonId
                const lessonId = lesson.dataset.lessonId;
                
                // Обновляем позиционные данные в скрытом элементе урока
                const lessonIds = lesson.querySelector('.lesson-ids');
                if (lessonIds) {
                    lessonIds.dataset.lessonNumber = newPos.lessonNumber;
                    lessonIds.dataset.weekDay = newPos.weekDay;
                }
                
                // Убеждаемся, что lessonId сохраняется в data-атрибуте
                if (lessonId) {
                    // Дополнительно проверяем, что lessonId остался после перемещения
                    setTimeout(() => {
                        const movedLesson = document.querySelector(`[data-lesson-id="${lessonId}"]`);
                        if (movedLesson) {
                            // LessonId подтвержден
                        } else {
                            // LessonId потерян
                        }
                    }, 100);
                } else {
                    // LessonId отсутствует
                }
                
                // Создаем объект только с позиционными данными для перемещения
                const lessonData = {};
                
                // Добавляем только измененные позиционные данные
                if (oldPos.lessonNumber !== newPos.lessonNumber) {
                    lessonData.lesson_number = newPos.lessonNumber;
                }
                if (oldPos.weekDay !== newPos.weekDay) {
                    lessonData.week_day = newPos.weekDay;
                }
                
                // Добавляем изменение только если позиция действительно изменилась
                if (Object.keys(lessonData).length > 0) {
                    const changeData = {
                        lessonId: lesson.dataset.lessonId,
                        lessonData: lessonData
                    };
                    
                    addPendingChange('move', changeData);
                } else {
                    // Позиция не изменилась
                }
            }
        }
        
        // Функции для управления drag-and-drop интерфейсом
        function showDragDropControls() {
            // Показываем контролы только если есть изменения
            if (pendingChanges.length > 0) {
                const controls = document.getElementById('dragDropControls');
                if (controls) {
                    controls.style.display = 'flex';
                }
            }
        }
        
        function hideDragDropControls() {
            const controls = document.getElementById('dragDropControls');
            if (controls) {
                controls.style.display = 'none';
            }
        }
        
        function saveDragDropChanges() {
            if (pendingChanges.length === 0) {
                hideDragDropControls();
                clearDropAvailability();
                return;
            }
            
            // Сохраняем изменения
            saveChangesAsync();
        }
        
        function cancelDragDropChanges() {
            if (pendingChanges.length > 0) {
                const shouldCancel = confirm('Отменить все изменения? Это вернет расписание к исходному состоянию.');
                if (shouldCancel) {
                    let dataRestored = false;
                    
                    if (originalTimetableData) {
                        renderTimetable(originalTimetableData);
                        originalTimetableData = null; // Сбросить только после успешного восстановления
                        dataRestored = true;
                    } else if (window.currentTimetableData) {
                        // Если originalTimetableData не установлен, используем текущие данные
                        renderTimetable(window.currentTimetableData);
                        dataRestored = true;
                    } else {
                        // Если нет данных вообще, перезагружаем
                        loadTimetable();
                        dataRestored = true;
                    }
                    
                    
                    if (dataRestored) {
                        pendingChanges = [];
                        hideDragDropControls();
                        clearDropAvailability();
                        
                        // Восстанавливаем drag & drop функциональность
                        setupDragAndDrop();
                    }
                }
            } else {
                // Если нет изменений, просто скрываем контролы
                hideDragDropControls();
                clearDropAvailability();
            }
        }
        
        async function saveChangesAsync() {
            try {
                // Проверяем, есть ли изменения для сохранения
                if (pendingChanges.length === 0) {
                    return;
                }
                
                for (const change of pendingChanges) {
                    switch (change.type) {
                        case 'move':
                            // Для перемещения используем только позиционные данные
                            const moveData = createMoveUpdateData(change.data.lessonData);
                            
                            if (Object.keys(moveData).length > 0) {
                                // Для перемещения отправляем данные напрямую, без сравнения с оригиналом
                                await updateLessonDirect(change.data.lessonId, moveData);
                            }
                            break;
                        case 'delete':
                            await deleteLesson(change.data.lessonId);
                            break;
                    }
                }
                
                pendingChanges = [];
                originalTimetableState = null;
                originalTimetableData = null; // Сбрасываем после успешного сохранения
                hideDragDropControls();
                
                // Очищаем индикацию доступности
                clearDropAvailability();
                
                showAlert('Изменения сохранены');
                
                // Перезагружаем расписание
                await loadTimetable();
            } catch (error) {
                showAlert('Ошибка сохранения изменений: ' + error.message, 'error');
            }
        }

        // Модальные окна
        function openModal(lessonData = null, cellPosition = null) {
            
            if (!canEdit()) {
                showAlert('Для редактирования необходимо выбрать академический календарь и группу, преподавателя, аудиторию или предмет');
                return;
            }

            // Определяем позиционные данные
            let weekDay, lessonNumber;
            if (lessonData) {
                weekDay = lessonData.week_day;
                lessonNumber = lessonData.lesson_number;
            } else if (cellPosition) {
                weekDay = cellPosition.weekDay;
                lessonNumber = cellPosition.lessonNumber;
            }
            
            // Загружаем доступные элементы для выбранной позиции
            loadAvailableItemsForModal(weekDay, lessonNumber, lessonData?.id).then(() => {
                // Показываем модальное окно только после загрузки доступных элементов
                showModal();
            });

            // Функция для показа модального окна
            function showModal() {
            const modal = document.getElementById('lessonModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('lessonForm');
            
            // Сбрасываем форму
            form.reset();
            
            // Сбрасываем все поля
                ['subject', 'teacher'].forEach(field => {
                const input = document.getElementById(`${field}Field`);
                input.value = '';
                input.disabled = false;
                input.style.backgroundColor = 'white';
            });

                // Сбрасываем новые поля
                document.getElementById('lessonType').value = '';
                document.getElementById('note').value = '';
                
                // Сбрасываем группы и аудитории
                clearSelectedGroups();
                clearSelectedRooms();
                
                // Сбрасываем поля номера урока и дня недели
                document.getElementById('lessonNumber').disabled = false;
                document.getElementById('weekDay').disabled = false;
                document.getElementById('lessonNumber').style.backgroundColor = 'white';
                document.getElementById('weekDay').style.backgroundColor = 'white';

                if (lessonData && lessonData.id) {
                    // Редактирование существующего урока
                    
                title.textContent = 'Редактировать урок';
                currentLessonId = lessonData.id;
                
                // Заполняем поля данными урока
                    document.getElementById('subjectField').value = lessonData.subject?.name || '';
                    document.getElementById('teacherField').value = lessonData.teacher?.name || '';
                    document.getElementById('lessonType').value = lessonData.lesson_type || '';
                    document.getElementById('note').value = lessonData.note || '';
                    
                    // Заполняем аудитории
                    if (lessonData.rooms && lessonData.rooms.length > 0) {
                        selectedRooms = lessonData.rooms.map(room => ({
                            id: room.id,
                            name: room.name
                        }));
                        updateSelectedRoomsDisplay();
                    }
                    
                    // Заполняем позиционные данные
                    const lessonNumberField = document.getElementById('lessonNumber');
                    const weekDayField = document.getElementById('weekDay');
                    const hiddenLessonNumberField = document.getElementById('hiddenLessonNumber');
                    const hiddenWeekDayField = document.getElementById('hiddenWeekDay');
                    
                    if (lessonNumberField && weekDayField) {
                        // Для select нужно установить value как строку
                        lessonNumberField.value = String(lessonData.lesson_number || '');
                        weekDayField.value = String(lessonData.week_day ?? ''); // Используем ?? для 0
                        
                        // Заполняем скрытые поля
                        if (hiddenLessonNumberField && hiddenWeekDayField) {
                            hiddenLessonNumberField.value = String(lessonData.lesson_number || '');
                            hiddenWeekDayField.value = String(lessonData.week_day ?? '');
                        }
                        
                    } else {
                        // Поля не найдены
                    }
                    
                    // Заполняем группы
                    if (lessonData.groups && lessonData.groups.length > 0) {
                        selectedGroups = lessonData.groups.map(group => ({
                            id: group.id,
                            name: group.name
                        }));
                        updateSelectedGroupsDisplay();
                    }
                    
                    // Отладочная информация
                    
                    // Делаем номер урока и день недели неизменяемыми при редактировании
                    document.getElementById('lessonNumber').disabled = true;
                    document.getElementById('weekDay').disabled = true;
                    document.getElementById('lessonNumber').style.backgroundColor = '#f8f9fa';
                    document.getElementById('weekDay').style.backgroundColor = '#f8f9fa';
                    
                    // Предмет и преподаватель остаются редактируемыми, но обязательными
                            } else {
                    // Добавление нового урока



                    
                title.textContent = 'Добавить урок';
                currentLessonId = null;
                
                // Автоматически заполняем поля на основе текущего выбора
                if (selectedValues.teacher.id) {
                    document.getElementById('teacherField').value = selectedValues.teacher.name;
                    document.getElementById('teacherField').disabled = true;
                    document.getElementById('teacherField').style.backgroundColor = '#f8f9fa';

                }
                
                if (selectedValues.room.id) {
                        // Для множественного выбора аудиторий не блокируем поле
                        // Пользователь может выбрать несколько аудиторий
                }

                if (selectedValues.subject.id) {
                    document.getElementById('subjectField').value = selectedValues.subject.name;
                    document.getElementById('subjectField').disabled = true;
                    document.getElementById('subjectField').style.backgroundColor = '#f8f9fa';

                    }
                    
                    // Автоматически выбираем группы если есть фильтр по группе
                    if (selectedValues.group.id) {
                        // Ищем группу в кэше
                        const groupInCache = fullListsCache.group.find(g => g.id === selectedValues.group.id);
                        if (groupInCache) {
                            selectedGroups = [groupInCache];
                            updateSelectedGroupsDisplay();
    
                        }
                    }
                    
                    // Автоматически выбираем аудитории если есть фильтр по аудитории
                    if (selectedValues.room.id) {
                        // Ищем аудиторию в кэше
                        const roomInCache = fullListsCache.room.find(r => r.id === selectedValues.room.id);
                        if (roomInCache) {
                            selectedRooms = [roomInCache];
                            updateSelectedRoomsDisplay();
    
                        }
                }
                
                // Автоматически заполняем номер урока и день недели на основе позиции ячейки
                if (cellPosition) {
                        document.getElementById('lessonNumber').value = String(cellPosition.lessonNumber);
                        document.getElementById('weekDay').value = String(cellPosition.weekDay ?? '');
                        document.getElementById('hiddenLessonNumber').value = String(cellPosition.lessonNumber);
                        document.getElementById('hiddenWeekDay').value = String(cellPosition.weekDay ?? '');
                        
                        // Делаем поля номера урока и дня недели неизменяемыми
                        document.getElementById('lessonNumber').disabled = true;
                        document.getElementById('weekDay').disabled = true;
                        document.getElementById('lessonNumber').style.backgroundColor = '#f8f9fa';
                        document.getElementById('weekDay').style.backgroundColor = '#f8f9fa';
                    }
                }
                
                // Показываем модальное окно
            modal.style.display = 'block';
            }
        }

        function closeModal() {
            
            // Сохраняем currentLessonId в DOM элементе урока, если он есть
            if (currentLessonId) {
                const lessonElement = document.querySelector(`[data-lesson-id="${currentLessonId}"]`);
                if (lessonElement) {
                    lessonElement.dataset.currentLessonId = currentLessonId;
                    
                } else {

                }
            }
            
            document.getElementById('lessonModal').style.display = 'none';
            currentLessonId = null;
            

        }
        
        // Функция для обновления данных урока в DOM
        function updateLessonDataInDOM(lessonId, lessonData) {
            
            const lessonElement = document.querySelector(`[data-lesson-id="${lessonId}"]`);
            if (!lessonElement) {

                return;
            }
            
            const lessonIds = lessonElement.querySelector('.lesson-ids');
            if (lessonIds) {
                // Обновляем позиционные данные
                if (lessonData.lesson_number !== undefined) {
                    lessonIds.dataset.lessonNumber = lessonData.lesson_number;

                }
                if (lessonData.week_day !== undefined) {
                    lessonIds.dataset.weekDay = lessonData.week_day;

                }
                
                // Обновляем данные о предмете и преподавателе
                if (lessonData.subject_id) {
                    lessonIds.dataset.subjectId = lessonData.subject_id;

                }
                if (lessonData.teacher_id) {
                    lessonIds.dataset.teacherId = lessonData.teacher_id;

                }
                
                // Обновляем тип занятия и примечание
                if (lessonData.lesson_type) {
                    lessonIds.dataset.lessonType = lessonData.lesson_type;

                }
                if (lessonData.note !== undefined) {
                    lessonIds.dataset.note = lessonData.note;

                }
                
    
                
                // Обновляем визуальное отображение урока
                updateLessonDisplay(lessonElement, lessonData);
            } else {

            }
                }
        
        // Функция для обновления визуального отображения урока
        function updateLessonDisplay(lessonElement, lessonData) {


            
            // Обновляем отображение предмета
            const subjectDisplay = lessonElement.querySelector('.lesson-subject');
            if (subjectDisplay && lessonData.subject_name) {
                subjectDisplay.textContent = lessonData.subject_name;
            }
            
            // Обновляем отображение преподавателя
            const teacherDisplay = lessonElement.querySelector('.lesson-teacher');
            if (teacherDisplay && lessonData.teacher_name) {
                teacherDisplay.textContent = `👨‍🏫 ${lessonData.teacher_name}`;
            }
            
            // Обновляем отображение типа занятия
            const lessonTypeDisplay = lessonElement.querySelector('.lesson-type');
            if (lessonData.lesson_type) {
                const typeDisplay = getLessonTypeDisplay(lessonData.lesson_type);
                if (lessonTypeDisplay) {
                    lessonTypeDisplay.textContent = `📚 ${typeDisplay}`;
                } else {
                    // Создаем элемент типа занятия если его нет
                    const newTypeElement = document.createElement('div');
                    newTypeElement.className = 'lesson-type';
                    newTypeElement.textContent = `📚 ${typeDisplay}`;
                    lessonElement.appendChild(newTypeElement);
                }
            }
            
            // Обновляем отображение примечания
            const noteDisplay = lessonElement.querySelector('.lesson-note');
            if (lessonData.note) {
                if (noteDisplay) {
                    noteDisplay.textContent = `📝 ${lessonData.note}`;
                } else {
                    // Создаем элемент примечания если его нет
                    const newNoteElement = document.createElement('div');
                    newNoteElement.className = 'lesson-note';
                    newNoteElement.textContent = `📝 ${lessonData.note}`;
                    lessonElement.appendChild(newNoteElement);
                }
            } else if (noteDisplay) {
                // Удаляем элемент примечания если примечания нет
                noteDisplay.remove();
            }
            
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // Обработка формы урока
        document.getElementById('lessonForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const lessonData = {};

            // Добавляем позиционные данные
            let lessonNumber, weekDay;
            
            // Получаем позиционные данные из скрытых полей
            lessonNumber = parseInt(formData.get('hiddenLessonNumber'));
            weekDay = parseInt(formData.get('hiddenWeekDay'));
            
            // Добавляем позиционные данные
            lessonData.lesson_number = lessonNumber;
            lessonData.week_day = weekDay;

            // Обрабатываем обязательные поля с возможностью выбора из списка или ввода текста
            ['subject', 'teacher'].forEach(field => {
                const input = document.getElementById(`${field}Field`);
                const value = input.value.trim();
                
                if (!value) {
                    throw new Error(`${field === 'subject' ? 'Предмет' : 'Преподаватель'} обязателен`);
                }
                
                // Ищем значение в кэше
                const cachedItem = fullListsCache[field].find(item => item.name === value);
                
                if (cachedItem) {
                    // Значение найдено в кэше - отправляем ID
                    lessonData[`${field}_id`] = cachedItem.id;
                    } else {
                        // Значение введено вручную - отправляем только name
                        lessonData[`${field}_name`] = value;
                }
            });
            
            // Обрабатываем группы (автоматически выбранные или вручную)
            if (selectedGroups.length > 0) {
                lessonData.group_ids = selectedGroups.map(group => group.id);
            }
            
            // Обрабатываем аудитории (автоматически выбранные или вручную)
            if (selectedRooms.length > 0) {
                lessonData.room_ids = selectedRooms.map(room => room.id);
            }
            
            // Обрабатываем тип занятия
            const lessonType = formData.get('lessonType');
            if (lessonType) {
                lessonData.lesson_type = lessonType;
            }
            
            // Обрабатываем примечание
            const note = formData.get('note');
            if (note && note.trim()) {
                lessonData.note = note.trim();
            }

            try {
                if (currentLessonId) {
                    // Обновление существующего урока
                    await updateLesson(currentLessonId, lessonData);
                } else {
                    // Создание нового урока
                    await createLesson(lessonData);
                }
                
                closeModal();
                
                // Если есть pendingChanges, очищаем их после успешного сохранения
                if (pendingChanges.length > 0) {
                    pendingChanges = [];
                    originalTimetableState = null;
                    originalTimetableData = null;
                    hideDragDropControls();
                    clearDropAvailability();
                }
                
                // Если редактировали перемещенный урок, обновляем его данные в DOM
                if (currentLessonId) {
                    updateLessonDataInDOM(currentLessonId, lessonData);
                    
                    // Очищаем сохраненный currentLessonId после успешного сохранения
                    const lessonElement = document.querySelector(`[data-lesson-id="${currentLessonId}"]`);
                    if (lessonElement && lessonElement.dataset.currentLessonId) {
                        delete lessonElement.dataset.currentLessonId;
                    }
                }
                
                loadTimetable(); // Перезагружаем расписание
            } catch (error) {

                showAlert('Ошибка сохранения урока: ' + error.message, 'error');
            }
        });

        // API функции
        async function createLesson(lessonData) {
            const branchId = selectedValues.branch.id;
            const calendarId = selectedValues.calendar.id;

            const requestData = {
                ...lessonData,
                branch_id: branchId,
                academic_calendar_id: calendarId
            };

            // Проверяем обязательные поля
            if (!requestData.lesson_type) {
                requestData.lesson_type = 'UNKNOWN';
            }
            if (!requestData.lesson_number) {
                throw new Error('Номер урока обязателен');
            }
            if (requestData.week_day === undefined || requestData.week_day === null) {
                throw new Error('День недели обязателен');
            }
            if (!requestData.subject_id && !requestData.subject_name) {
                throw new Error('Предмет обязателен');
            }
            if (!requestData.teacher_id && !requestData.teacher_name) {
                throw new Error('Преподаватель обязателен');
            }


            const response = await fetch(TIMETABLES_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                throw new Error(`Ошибка: ${response.status} ${response.statusText}`);
            }

            return await response.json();
        }

        async function updateLesson(lessonId, lessonData) {
            
            // Получаем текущие данные урока для сравнения
            const currentLesson = getCurrentLessonData(lessonId);
            
            // Создаем объект только с измененными полями
            const updateData = createPartialUpdateData(lessonData, currentLesson);

            // Если нет изменений, не отправляем запрос
            if (Object.keys(updateData).length === 0) {
                return;
            }


            const response = await fetch(`${TIMETABLES_API_URL}${lessonId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });


            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Ошибка: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const result = await response.json();

            return result;
        }
        
        // Функция для прямого обновления урока (для перемещения)
        async function updateLessonDirect(lessonId, lessonData) {


            // Проверяем, что есть данные для отправки
            if (Object.keys(lessonData).length === 0) {

                return;
            }



            const response = await fetch(`${TIMETABLES_API_URL}${lessonId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(lessonData)
            });



            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Ошибка: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const result = await response.json();
            return result;
        }

        async function deleteLesson(lessonId) {
            const response = await fetch(`${TIMETABLES_API_URL}${lessonId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Ошибка: ${response.status} ${response.statusText}`);
            }

            return await response.json();
        }

        // Управление изменениями
        function addPendingChange(type, data) {

            
            // Инициализируем originalTimetableData при первом изменении
            if (!originalTimetableData && window.currentTimetableData) {
                originalTimetableData = JSON.parse(JSON.stringify(window.currentTimetableData));
            }
            
            const change = { type, data, timestamp: Date.now() };
            pendingChanges.push(change);

        }



        // Функция удаления урока
        function deleteLessonFromUI(lessonId) {
            showConfirmModal(
                'Вы уверены, что хотите удалить этот урок?',
                async () => {
                    try {
                        await deleteLesson(lessonId);
                        loadTimetable();
                    } catch (error) {

                        showAlert('Ошибка удаления урока: ' + error.message, 'error');
                    }
                }
            );
        }

        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmBtn').onclick = () => {
                onConfirm();
                closeConfirmModal();
            };
            document.getElementById('confirmModal').style.display = 'block';
        }

        // Загрузка branches
        async function loadBranches() {
            // Проверяем, не загружается ли уже запрос для branches
            if (loadingRequests.branch) {
                console.log('Branch request already loading');
                return;
            }
            
            loadingRequests.branch = true;
            
            try {
                document.getElementById('loadingBranches').style.display = 'block';
                
                const response = await fetch(`${BRANCHES_API_URL}?disable_pagination=true`);
                if (response.ok) {
                    const data = await response.json();
                    const branches = data.items || data;
                    fullListsCache.branch = branches;
                    
                    // Восстанавливаем сохраненный branch если есть
                    const savedBranch = selectedValues.branch;
                    if (savedBranch && savedBranch.id) {
                        const branchInCache = branches.find(b => b.id === savedBranch.id);
                        if (branchInCache) {
                            const branchInput = document.getElementById('branchInput');
                            branchInput.value = getBranchDisplayName(branchInCache);
                            selectedValues.branch = {
                                id: branchInCache.id,
                                name: getBranchDisplayName(branchInCache)
                            };
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки branches:', error);
            } finally {
                document.getElementById('loadingBranches').style.display = 'none';
                loadingRequests.branch = false;
                
                // Загружаем сохраненные значения фильтров после загрузки branches
                loadSelectedValues();
                
                // Если есть сохраненный branch, загружаем календари
                if (selectedValues.branch.id) {
                    loadCalendarsForBranch();
                }
                
                // Устанавливаем язык после загрузки всех элементов
                const savedLanguage = localStorage.getItem('timetableLanguage');
                if (savedLanguage) {
                    setTimeout(() => {
                        setLanguage(savedLanguage);
                    }, 100);
                } else {
                    // Устанавливаем активную кнопку для русского языка по умолчанию
                    document.getElementById('langRu').classList.add('active');
                }
            }
            }

        // Функция для получения отображаемого имени branch с учетом языка
        function getBranchDisplayName(branch) {
            const currentLang = getCurrentLanguage();
            if (branch.name && typeof branch.name === 'object') {
                return branch.name[currentLang] || branch.name.ru || branch.name.en || branch.name.uz || 'Без названия';
            }
            return branch.name || 'Без названия';
        }

        // Переменная для текущего языка
        let currentLanguage = 'ru';

        // Функция для получения текущего языка
        function getCurrentLanguage() {
            return currentLanguage;
        }

        // Функция для установки языка
        function setLanguage(lang) {
            currentLanguage = lang;
            
            // Обновляем активную кнопку
            document.querySelectorAll('.language-selector .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const langButton = document.getElementById(`lang${lang.toUpperCase()}`);
            if (langButton) {
                langButton.classList.add('active');
            }
            
            // Сохраняем язык в localStorage
            localStorage.setItem('timetableLanguage', lang);
            
            // Обновляем отображение всех элементов
            updateLanguageDisplay();
        }

        // Функция для обновления отображения с учетом языка
        function updateLanguageDisplay() {
            // Обновляем все элементы с переводами, кроме дат в заголовках
            document.querySelectorAll('[data-translate]').forEach(element => {
                // Пропускаем элементы с датами в заголовках таблицы
                if (element.id && element.id.endsWith('-date')) {
                    return;
                }
                const key = element.getAttribute('data-translate');
                element.textContent = t(key);
            });
            
            // Обновляем плейсхолдеры
            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                element.placeholder = t(key);
            });
            
            // Обновляем опции в селектах
            document.querySelectorAll('option[data-translate]').forEach(option => {
                const key = option.getAttribute('data-translate');
                option.textContent = t(key);
            });
            
            // Обновляем даты в заголовках таблицы
            updateWeekDates();
            
            // Обновляем отображение branches
            if (selectedValues.branch && selectedValues.branch.id) {
                const branchInput = document.getElementById('branchInput');
                if (branchInput) {
                    const branchInCache = fullListsCache.branch.find(b => b.id === selectedValues.branch.id);
                    if (branchInCache) {
                        branchInput.value = getBranchDisplayName(branchInCache);
                    }
                }
            }
            
            // Обновляем отображение других элементов
            Object.keys(selectedValues).forEach(type => {
                if (type !== 'branch' && selectedValues[type] && selectedValues[type].id) {
                    const input = document.getElementById(type + 'Input');
                    if (input) {
                        const langKey = `name_${currentLanguage}`;
                        if (selectedValues[type][langKey]) {
                            input.value = selectedValues[type][langKey];
                        }
                    }
                }
            });
        }

        // Загрузка календарей для модального окна импорта
        async function loadCalendarsForImport() {
            console.log('loadCalendarsForImport called');
            const branchSelect = document.getElementById('importBranchSelect');
            const calendarSelect = document.getElementById('importCalendarSelect');
            
            console.log('Branch select value:', branchSelect.value);
            
            if (!branchSelect.value) {
                console.log('No branch selected, disabling calendar select');
                calendarSelect.innerHTML = '<option value="" data-translate="select_branch_first">Сначала выберите филиал...</option>';
                calendarSelect.disabled = true;
                checkImportReady();
                return;
            }
            
            try {
                calendarSelect.disabled = true;
                calendarSelect.innerHTML = '<option value="">Загрузка календарей...</option>';
                
                console.log('Fetching calendars for branch:', branchSelect.value);
                
                // Загружаем календари для выбранного branch
                const response = await fetch(`${ACADEMIC_CALENDARS_API_URL}?branch_id=${branchSelect.value}&disable_pagination=true`);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    const calendars = data.items || data;
                    
                    console.log('Calendars loaded:', calendars.length);
                    
                    calendarSelect.innerHTML = '<option value="" data-translate="select_calendar">Выберите календарь...</option>';
                    
                    calendars.forEach(calendar => {
                        const option = document.createElement('option');
                        option.value = calendar.id;
                        option.textContent = `${calendar.academic_year} | Семестр ${calendar.semester}`;
                        calendarSelect.appendChild(option);
                    });
                    
                    calendarSelect.disabled = false;
                    console.log('Calendar select enabled');
                    
                    // Добавляем обработчик изменения календаря
                    calendarSelect.addEventListener('change', function() {
                        console.log('Calendar selection changed:', this.value);
                        checkImportReady();
                    });
                } else {
                    console.error('Failed to load calendars, status:', response.status);
                    calendarSelect.innerHTML = '<option value="">Ошибка загрузки календарей</option>';
                }
                
                checkImportReady();
            } catch (error) {
                console.error('Ошибка загрузки календарей для импорта:', error);
                calendarSelect.innerHTML = '<option value="">Ошибка загрузки календарей</option>';
                checkImportReady();
            }
        }
        
        // Загрузка календарей для выбранного branch
        async function loadCalendarsForBranch(branchId = null) {
            if (!branchId && !selectedValues.branch.id) {
                return;
            }
            
            // Проверяем, не загружается ли уже запрос для календарей
            if (loadingRequests.calendar) {
                console.log('Calendar request already loading');
                return;
            }
            
            loadingRequests.calendar = true;
            
            const targetBranchId = branchId || selectedValues.branch.id;
            
            try {
                document.getElementById('loadingCalendars').style.display = 'block';
                
                // Загружаем календари для конкретного branch
                const response = await fetch(`${ACADEMIC_CALENDARS_API_URL}?branch_id=${targetBranchId}&disable_pagination=true`);
                if (response.ok) {
                    const data = await response.json();
                    const calendars = data.items || data;
                    fullListsCache.calendar = calendars;
                    
                    console.log('Calendars loaded for branch:', targetBranchId, 'Count:', calendars.length);
                    
                    // Обновляем кэш календарей
                    fullListsCache.calendar = calendars;
                    
                    // Очищаем поле календаря при смене branch
                    const calendarInput = document.getElementById('calendarInput');
                    calendarInput.value = '';
                    calendarInput.placeholder = 'Выберите академический календарь...';
                    calendarInput.removeAttribute('readonly');
                    calendarInput.classList.remove('current');
                    
                    // Очищаем selectedValues для календаря
                    selectedValues.calendar = null;
                    saveSelectedValues();
                    
                    // Обновляем выпадающий список календарей если он открыт
                    const calendarDropdown = document.getElementById('calendarDropdown');
                    if (calendarDropdown && calendarDropdown.style.display === 'block') {
                        displayDropdownResults(calendarDropdown, calendars, 'calendar');
                    }
                    
                    // Если календарей нет, показываем сообщение в placeholder
                    if (calendars.length === 0) {
                        const calendarInput = document.getElementById('calendarInput');
                        calendarInput.placeholder = 'Нет календарей для этого филиала';
                    }
                    
                    // Пытаемся получить текущий календарь для этого branch только если есть календари
                    if (calendars.length > 0) {
                        try {
                            const currentResponse = await fetch(`${ACADEMIC_CALENDARS_API_URL}${targetBranchId}/current`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            if (currentResponse.ok) {
                                const currentCalendar = await currentResponse.json();
                                
                                // Ищем текущий календарь в списке календарей по academic_year и semester
                                const matchingCalendar = calendars.find(cal => 
                                    cal.academic_year === currentCalendar.academic_year && 
                                    cal.semester === currentCalendar.semester
                                );
                                
                                if (matchingCalendar) {
                                    const displayName = `${matchingCalendar.academic_year} | ${t('semester')} ${matchingCalendar.semester}`;
                                    
                                    const calendarInput = document.getElementById('calendarInput');
                                    calendarInput.value = displayName;
                                    calendarInput.classList.add('current');
                                    calendarInput.placeholder = 'Текущий календарь';
                                    calendarInput.removeAttribute('readonly');
                                    
                                    selectedValues.calendar = { 
                                        id: matchingCalendar.id, // Используем UUID из списка
                                        name: displayName 
                                    };
                                    
                                    // Сохраняем выбранный календарь
                                    saveSelectedValues();
                                    
                                    // Обновляем состояние полей после автоматического выбора календаря
                                    updateFieldStates();
                                } else {
                                    // Если текущий календарь не найден в списке, оставляем поле пустым
                                    const calendarInput = document.getElementById('calendarInput');
                                    calendarInput.value = '';
                                    calendarInput.placeholder = 'Выберите академический календарь...';
                                    calendarInput.removeAttribute('readonly');
                                    calendarInput.classList.remove('current');
                                }
                            } else {
                                // Если текущий календарь не найден, оставляем поле пустым
                                const calendarInput = document.getElementById('calendarInput');
                                calendarInput.value = '';
                                calendarInput.placeholder = 'Выберите академический календарь...';
                                calendarInput.removeAttribute('readonly');
                                calendarInput.classList.remove('current');
                            }
                        } catch (currentError) {
                            // В случае ошибки оставляем поле пустым
                            const calendarInput = document.getElementById('calendarInput');
                            calendarInput.value = '';
                            calendarInput.placeholder = 'Выберите академический календарь...';
                            calendarInput.removeAttribute('readonly');
                            calendarInput.classList.remove('current');
                        }
                    } else {
                        // Если календарей нет, оставляем поле пустым
                        console.log('No calendars found for branch:', targetBranchId);
                        const calendarInput = document.getElementById('calendarInput');
                        calendarInput.value = '';
                        calendarInput.placeholder = 'Нет календарей для этого филиала';
                        calendarInput.removeAttribute('readonly');
                        calendarInput.classList.remove('current');
                        
                        // Обновляем выпадающий список календарей если он открыт
                        const calendarDropdown = document.getElementById('calendarDropdown');
                        if (calendarDropdown && calendarDropdown.style.display === 'block') {
                            displayDropdownResults(calendarDropdown, [], 'calendar');
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки календарей:', error);
                document.getElementById('calendarInput').placeholder = 'Ошибка загрузки календарей';
                document.getElementById('calendarInput').removeAttribute('readonly');
            } finally {
                document.getElementById('loadingCalendars').style.display = 'none';
                loadingRequests.calendar = false;
                
                // Если есть сохраненные фильтры, branch и календарь, загружаем расписание
                if (selectedValues.branch.id && selectedValues.calendar && selectedValues.calendar.id && (selectedValues.group.id || selectedValues.teacher.id || selectedValues.room.id || selectedValues.subject.id)) {
                    loadTimetable();
                }
            }
        }

        // Настройка автодополнения для поля
        function setupAutocomplete(inputId, dropdownId, loadingId, type) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const loading = document.getElementById(loadingId);

            input.addEventListener('input', function() {
                // Проверяем, доступно ли поле
                if (this.hasAttribute('readonly')) {
                    return;
                }
                
                // Для фильтров (group, teacher, room, subject) проверяем наличие branch И calendar
                if (type === 'group' || type === 'teacher' || type === 'room' || type === 'subject') {
                    if (!selectedValues.branch || !selectedValues.branch.id) {
                        return;
                    }
                    if (!selectedValues.calendar || !selectedValues.calendar.id) {
                        return;
                    }
                }
                
                // Проверяем, не загружается ли уже запрос для этого типа
                if (loadingRequests[type]) {
                    console.log('Request already loading for type:', type);
                    return;
                }
                
                const query = this.value.trim();
                
                // Очищаем предыдущий таймаут
                if (searchTimeouts[type]) {
                    clearTimeout(searchTimeouts[type]);
                }

                // Если поле пустое, показываем полный список из кэша
                if (!query) {
                    if (type === 'calendar') {
                        // Для календарей всегда показываем список
                        if (fullListsCache[type] && fullListsCache[type].length > 0) {
                            displayDropdownResults(dropdown, fullListsCache[type], type);
                        } else {
                            // Если кэш пуст или нет календарей, показываем пустой список
                            displayDropdownResults(dropdown, [], type);
                        }
                    } else if (type === 'branch') {
                        // Для branch показываем кэш если есть
                        if (fullListsCache[type] && fullListsCache[type].length > 0) {
                            displayDropdownResults(dropdown, fullListsCache[type], type);
                        } else {
                            loadBranches();
                        }
                    } else if (type === 'calendar') {
                        // Для календарей показываем пустой список если нет branch
                        if (selectedValues.branch && selectedValues.branch.id) {
                            loadCalendarsForBranch();
                        } else {
                            displayDropdownResults(dropdown, [], type);
                        }
                                            } else {
                            // Для фильтров (group, teacher, room, subject) загружаем только если список пустой
                            if (selectedValues.branch && selectedValues.branch.id && selectedValues.calendar && selectedValues.calendar.id) {
                                // Загружаем только если кэш пустой
                                if (!fullListsCache[type] || fullListsCache[type].length === 0) {
                                    loadAllObjects(type, dropdown, loading);
                                } else {
                                    // Показываем кэшированные данные
                                    displayDropdownResults(dropdown, fullListsCache[type], type);
                                }
                            } else {
                                // Не показываем dropdown и не загружаем данные если нет зависимостей
                                hideDropdown(dropdown);
                            }
                        }
                    // Не очищаем selectedValues сразу, только при клике вне поля
                    return;
                }

                // Задержка поиска 300ms
                searchTimeouts[type] = setTimeout(() => {
                    if (type === 'calendar') {
                        searchCalendars(query, dropdown, loading);
                    } else if (type === 'branch') {
                        searchBranches(query, dropdown, loading);
                    } else {
                        searchObjects(type, query, dropdown, loading);
                    }
                }, 300);
            });

            input.addEventListener('focus', function() {
                // Проверяем, доступно ли поле
                if (this.hasAttribute('readonly')) {
                    console.log('Field is disabled (focus):', type);
                    return;
                }
                
                // Для фильтров (group, teacher, room, subject) проверяем наличие branch И calendar
                if (type === 'group' || type === 'teacher' || type === 'room' || type === 'subject') {
                    if (!selectedValues.branch || !selectedValues.branch.id) {
                        console.log('Branch not selected for filter (focus):', type);
                        return;
                    }
                    if (!selectedValues.calendar || !selectedValues.calendar.id) {
                        console.log('Calendar not selected for filter (focus):', type);
                        return;
                    }
                }
                
                // Закрываем другие dropdown при фокусе на новое поле
                hideOtherDropdowns(dropdownId);
                activeInput = inputId;
                
                // Показываем список при фокусе только если кэш уже есть
                setTimeout(() => {
                    if (type === 'calendar') {
                        // Для календарей всегда показываем список
                        if (fullListsCache[type] && fullListsCache[type].length > 0) {
                            displayDropdownResults(dropdown, fullListsCache[type], type);
                        } else {
                            // Если кэш пуст или нет календарей, показываем пустой список
                            displayDropdownResults(dropdown, [], type);
                        }
                    } else if (type === 'branch') {
                        // Для branch показываем кэш если есть
                        if (fullListsCache[type] && fullListsCache[type].length > 0) {
                            displayDropdownResults(dropdown, fullListsCache[type], type);
                        } else {
                            hideDropdown(dropdown);
                        }
                    } else {
                        // Для фильтров (group, teacher, room, subject) НЕ показываем кэш при фокусе
                        // Данные будут загружены только при клике
                        hideDropdown(dropdown);
                    }
                }, 100);
            });
            
            // Добавляем обработчик клика для показа списка даже если поле уже заполнено
            input.addEventListener('click', function() {
                // Проверяем, доступно ли поле
                if (this.hasAttribute('readonly')) {
                    console.log('Field is disabled:', type);
                    return;
                }
                
                // Для фильтров (group, teacher, room, subject) проверяем наличие branch И calendar
                if (type === 'group' || type === 'teacher' || type === 'room' || type === 'subject') {
                    if (!selectedValues.branch || !selectedValues.branch.id) {
                        console.log('Branch not selected for filter:', type);
                        return;
                    }
                    if (!selectedValues.calendar || !selectedValues.calendar.id) {
                        console.log('Calendar not selected for filter:', type);
                        return;
                    }
                }
                
                // Проверяем, не загружается ли уже запрос для этого типа
                if (loadingRequests[type]) {
                    console.log('Request already loading for type:', type);
                    return;
                }
                
                console.log('Calendar input clicked, type:', type);
                console.log('fullListsCache[type]:', fullListsCache[type]);
                
                // Закрываем другие dropdown при клике на новое поле
                hideOtherDropdowns(dropdownId);
                activeInput = inputId;
                
                // Показываем список при клике
                setTimeout(() => {
                    console.log('Showing dropdown for type:', type);
                    if (type === 'calendar') {
                        // Для календарей всегда показываем список
                        if (fullListsCache[type] && fullListsCache[type].length > 0) {
                            displayDropdownResults(dropdown, fullListsCache[type], type);
                        } else {
                            // Если кэш пуст или нет календарей, показываем пустой список
                            displayDropdownResults(dropdown, [], type);
                        }
                    } else if (type === 'branch') {
                        // Для branch загружаем данные
                        loadBranches();
                    } else if (type === 'calendar') {
                        // Для календарей показываем пустой список если нет branch
                        if (selectedValues.branch && selectedValues.branch.id) {
                            loadCalendarsForBranch();
                        } else {
                            displayDropdownResults(dropdown, [], type);
                        }
                                            } else {
                            // Для фильтров (group, teacher, room, subject) загружаем только если список пустой
                            if (selectedValues.branch && selectedValues.branch.id && selectedValues.calendar && selectedValues.calendar.id) {
                                // Проверяем, не загружается ли уже запрос
                                if (!loadingRequests[type]) {
                                    // Загружаем только если кэш пустой
                                    if (!fullListsCache[type] || fullListsCache[type].length === 0) {
                                        loadAllObjects(type, dropdown, loading);
                                    } else {
                                        // Показываем кэшированные данные
                                        displayDropdownResults(dropdown, fullListsCache[type], type);
                                    }
                                }
                            } else {
                                // Не показываем dropdown и не загружаем данные если нет зависимостей
                                hideDropdown(dropdown);
                            }
                        }
                }, 200); // Увеличиваем задержку
            });
            
            // Добавляем обработчик для закрытия других списков при фокусе
            input.addEventListener('focus', function() {
                // Проверяем, доступно ли поле
                if (this.hasAttribute('readonly')) {
                    console.log('Field is disabled (focus):', type);
                    return;
                }
                
                // Закрываем все другие dropdown при фокусе на любом поле
                const allInputs = ['branchInput', 'calendarInput', 'groupInput', 'teacherInput', 'roomInput', 'subjectInput'];
                allInputs.forEach(inputId => {
                    if (inputId !== this.id) {
                        const otherDropdownId = inputId.replace('Input', 'Dropdown');
                        const otherDropdown = document.getElementById(otherDropdownId);
                        if (otherDropdown) {
                            hideDropdown(otherDropdown);
                        }
                    }
                });
            });

            // Обработчик потери фокуса - НЕ очищаем selectedValues сразу
            input.addEventListener('blur', function() {
                // Не делаем ничего - пусть глобальный обработчик клика решает
            });
        }

        // Настройка автодополнения для модального окна
        function setupModalAutocomplete(inputId, dropdownId, type) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            input.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                filterModalDropdown(dropdown, fullListsCache[type], query, type);
            });

            input.addEventListener('focus', function() {
                // Закрываем другие dropdown при фокусе на новом поле
                hideOtherDropdowns(dropdownId);
                activeInput = inputId;
                
                // При фокусе всегда показываем список с небольшой задержкой
                setTimeout(() => {
                    if (fullListsCache[type].length > 0) {
                        displayModalDropdownResults(dropdown, fullListsCache[type], type);
                    } else {
                        // Если кэш пуст, загружаем данные
                        loadAllObjects(type, dropdown, null);
                    }
                }, 100); // Небольшая задержка
            });
        }

        function filterModalDropdown(dropdown, items, query, type) {
            dropdown.innerHTML = '';
            
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(query)
            );
            
            displayModalDropdownResults(dropdown, filteredItems, type);
        }

        function displayModalDropdownResults(dropdown, items, type) {
            dropdown.innerHTML = '';

            if (items.length === 0) {
                dropdown.innerHTML = '<div class="no-results">Ничего не найдено</div>';
            } else {
                items.forEach(item => {
                    const option = document.createElement('div');
                    option.className = 'autocomplete-item';
                    option.textContent = item.name;
                    option.dataset.itemId = item.id;
                    option.dataset.itemName = item.name;
                    
                    // Проверяем доступность для преподавателей
                    if (type === 'teacher' && item.hasOwnProperty('is_available') && !item.is_available) {
                        option.classList.add('unavailable');
                        option.textContent += ' (недоступен)';
                        option.title = 'Этот преподаватель недоступен в данное время';
                    }
                    
                                    option.addEventListener('click', () => selectModalItem(type, item));
                dropdown.appendChild(option);
            });
        }

        showDropdown(dropdown);
        }

                function selectModalItem(type, item) {
            const inputId = type === 'teacher' ? 'teacherField' : type === 'room' ? 'roomField' : 'subjectField';
            const dropdownId = type === 'teacher' ? 'modalTeacherDropdown' : type === 'room' ? 'modalRoomDropdown' : 'modalSubjectDropdown';
            
            // Проверяем доступность для преподавателей
            if (type === 'teacher' && item.hasOwnProperty('is_available') && !item.is_available) {
                showAlert('Этот преподаватель недоступен в данное время', 'warning');
                return;
            }
            
            document.getElementById(inputId).value = item.name;
            hideDropdown(document.getElementById(dropdownId));
            
            // Закрываем все другие dropdown
            hideOtherDropdowns();
        }

        // Загрузка всех объектов
        async function loadAllObjects(type, dropdown, loading) {
            console.log('loadAllObjects called for type:', type);
            console.log('selectedValues.branch:', selectedValues.branch);
            console.log('selectedValues.calendar:', selectedValues.calendar);
            
            // Проверяем, не загружается ли уже запрос для этого типа
            if (loadingRequests[type]) {
                console.log('Request already loading for type:', type);
                return;
            }
            

            
            loadingRequests[type] = true;
            
            try {
                loading.style.display = 'block';
                
                // Показываем dropdown с "searching" сразу
                dropdown.innerHTML = '<div class="no-results">Поиск...</div>';
                showDropdown(dropdown);
                
                let apiUrl;
                switch(type) {
                    case 'group':
                        apiUrl = GROUPS_API_URL;
                        break;
                    case 'teacher':
                        apiUrl = TEACHERS_API_URL;
                        break;
                    case 'room':
                        apiUrl = ROOMS_API_URL;
                        break;
                    case 'subject':
                        apiUrl = SUBJECTS_API_URL;
                        break;
                    default:
                        throw new Error(`Неизвестный тип: ${type}`);
                }
                
                // Добавляем branch_id если выбран branch
                const params = new URLSearchParams();
                params.append('disable_pagination', 'true');
                
                // Для фильтров (group, teacher, room, subject) обязательно нужен branch И calendar
                if (type === 'group' || type === 'teacher' || type === 'room' || type === 'subject') {
                    if (!selectedValues.branch || !selectedValues.branch.id) {
                        // Если нет branch, показываем пустой список
                        displayDropdownResults(dropdown, [], type);
                        return;
                    }
                    if (!selectedValues.calendar || !selectedValues.calendar.id) {
                        // Если нет calendar, показываем пустой список
                        displayDropdownResults(dropdown, [], type);
                        return;
                    }
                    params.append('branch_id', selectedValues.branch.id);
                } else if (selectedValues.branch && selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                console.log(`Making API request for ${type}:`, `${apiUrl}?${params.toString()}`);
                const response = await fetch(`${apiUrl}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }

                const data = await response.json();
                const objects = data.items || data;
                // НЕ сохраняем в кэш, чтобы после обновления страницы запросы отправлялись заново
                displayDropdownResults(dropdown, objects, type);

            } catch (error) {
                dropdown.innerHTML = '<div class="no-results">Ошибка загрузки</div>';
                showDropdown(dropdown);
            } finally {
                loading.style.display = 'none';
                loadingRequests[type] = false;
                console.log(`Request completed for type: ${type}`);
            }
        }

        // Поиск branches
        async function searchBranches(query, dropdown, loading) {
            try {
                loading.style.display = 'block';
                
                const response = await fetch(`${BRANCHES_API_URL}?disable_pagination=true&search=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }

                const data = await response.json();
                const branches = data.items || data;
                displayDropdownResults(dropdown, branches, 'branch');

            } catch (error) {
                dropdown.innerHTML = '<div class="no-results">Ошибка поиска</div>';
                dropdown.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Поиск календарей
        async function searchCalendars(query, dropdown, loading) {
            try {
                loading.style.display = 'block';
                
                // Добавляем branch_id если выбран branch
                const params = new URLSearchParams();
                params.append('disable_pagination', 'true');
                params.append('search', query);
                
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                const response = await fetch(`${ACADEMIC_CALENDARS_API_URL}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }

                const data = await response.json();
                const calendars = data.items || data;
                displayDropdownResults(dropdown, calendars, 'calendar');

            } catch (error) {
                dropdown.innerHTML = '<div class="no-results">Ошибка поиска</div>';
                dropdown.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Поиск объектов
        async function searchObjects(type, query, dropdown, loading) {
            // Проверяем, не загружается ли уже запрос для этого типа
            if (loadingRequests[type]) {
                console.log('Request already loading for type:', type);
                return;
            }
            
            loadingRequests[type] = true;
            
            try {
                loading.style.display = 'block';
                
                // Показываем dropdown с "searching" сразу
                dropdown.innerHTML = '<div class="no-results">Поиск...</div>';
                showDropdown(dropdown);
                
                let apiUrl;
                switch(type) {
                    case 'group':
                        apiUrl = GROUPS_API_URL;
                        break;
                    case 'teacher':
                        apiUrl = TEACHERS_API_URL;
                        break;
                    case 'room':
                        apiUrl = ROOMS_API_URL;
                        break;
                    case 'subject':
                        apiUrl = SUBJECTS_API_URL;
                        break;
                    default:
                        throw new Error(`Неизвестный тип: ${type}`);
                }
                
                const params = new URLSearchParams();
                params.append('search', query);
                
                // Добавляем branch_id если выбран branch
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                const response = await fetch(`${apiUrl}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }

                const data = await response.json();
                const objects = data.items || data;
                // НЕ сохраняем в кэш для поиска
                displayDropdownResults(dropdown, objects, type);

            } catch (error) {
                dropdown.innerHTML = '<div class="no-results">Ошибка поиска</div>';
                showDropdown(dropdown);
            } finally {
                loading.style.display = 'none';
                loadingRequests[type] = false;
            }
        }

        // Отображение результатов в dropdown
        function displayDropdownResults(dropdown, objects, type) {
            console.log('displayDropdownResults called with:', { type, objectsLength: objects.length });
            
            dropdown.innerHTML = '';
            
            // Показываем dropdown плавно
            showDropdown(dropdown);
            
            // Если массив пустой, показываем "Ничего не найдено" (кроме календарей)
            if (objects.length === 0 && type !== 'calendar') {
                dropdown.innerHTML = '<div class="no-results">Ничего не найдено</div>';
                return;
            }

            if (type === 'calendar') {
                // Добавляем кнопку создания нового календаря в начало списка
                const createItem = document.createElement('div');
                createItem.className = 'autocomplete-item create-calendar-item';
                createItem.innerHTML = `
                    <div class="calendar-item d-flex align-items-center justify-content-between" style="background-color: #e8f5e8; border-left: 3px solid #28a745;">
                        <div class="calendar-info" onclick="openCreateCalendarModal()">
                            <span style="color: #28a745; font-weight: bold;">➕ ${t('create_new_calendar')}</span>
                        </div>
                    </div>
                `;
                dropdown.appendChild(createItem);
                
                if (objects.length > 0) {
                    // Добавляем разделитель только если есть календари
                    const divider = document.createElement('div');
                    divider.className = 'dropdown-divider';
                    divider.style.height = '1px';
                    divider.style.backgroundColor = '#dee2e6';
                    divider.style.margin = '8px 0';
                    dropdown.appendChild(divider);
                }
                
                // Если календари пустые, показываем сообщение
                if (objects.length === 0) {
                    dropdown.innerHTML += '<div class="no-results">Нет календарей для этого филиала. Нажмите "Создать новый календарь" выше.</div>';
                }
            }

            // Показываем календари если они есть
            if (objects.length > 0) {
                objects.forEach(obj => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    
                    if (type === 'calendar') {
                        // Проверяем если это текущий календарь
                        const currentDate = new Date();
                        const startDate = new Date(obj.start_date);
                        const endDate = new Date(obj.end_date);
                        const isCurrent = currentDate >= startDate && currentDate <= endDate;
                        
                        if (isCurrent) {
                            item.classList.add('calendar-current');
                        }
                        
                        // Форматируем даты
                        const formatDate = (dateString) => {
                            const date = new Date(dateString);
                            return date.toLocaleDateString('ru-RU');
                        };
                        
                        // Для календарей показываем "academic_year --- семестр" с датами и кнопками действий
                        item.innerHTML = `
                            <div class="calendar-item d-flex align-items-center justify-content-between">
                                <div class="calendar-info" data-calendar-id="${obj.id}" data-calendar-name="${obj.academic_year} --- ${t('semester')} ${obj.semester}" data-academic-year="${obj.academic_year}" data-semester="${obj.semester}">
                                    <div class="calendar-main">
                                        <span class="calendar-year">${obj.academic_year}</span>
                                        <span class="calendar-semester">${t('semester')} ${obj.semester}</span>
                                    </div>
                                    <div class="calendar-dates">
                                        <small class="text-muted">
                                            ${formatDate(obj.start_date)} - ${formatDate(obj.end_date)}
                                        </small>
                                    </div>
                                </div>
                                <div class="calendar-actions">
                                    <button class="btn btn-sm btn-outline-warning" onclick="editCalendar('${obj.id}', event)" title="Редактировать календарь">
                                        ✏️
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Добавляем обработчик клика для выбора календаря
                        const calendarInfo = item.querySelector('.calendar-info');
                        calendarInfo.addEventListener('click', function() {
                            const calendarId = this.getAttribute('data-calendar-id');
                            const calendarName = this.getAttribute('data-calendar-name');
                            const academicYear = this.getAttribute('data-academic-year');
                            const semester = this.getAttribute('data-semester');
                            
                            selectItem(type, {
                                id: calendarId, // Используем UUID как строку
                                name: calendarName,
                                academic_year: academicYear,
                                semester: parseInt(semester)
                            });
                        });
                    } else if (type === 'branch') {
                        // Для branches показываем мультиязычное название
                        item.textContent = getBranchDisplayName(obj);
                        item.addEventListener('click', () => selectItem(type, obj));
                    } else {
                        item.textContent = obj.name;
                        item.addEventListener('click', () => selectItem(type, obj));
                    }
                    
                    dropdown.appendChild(item);
                });
            }

            dropdown.style.display = 'block';
            console.log('Dropdown displayed for type:', type, 'with', objects.length, 'items');
        }

        // Выбор элемента
        function selectItem(type, obj) {
            console.log('selectItem called with:', type, obj);
            
            const inputId = type + 'Input';
            const dropdownId = type + 'Dropdown';
            
            if (type === 'branch') {
                document.getElementById(inputId).value = getBranchDisplayName(obj);
                document.getElementById(dropdownId).style.display = 'none';
                
                selectedValues[type] = { 
                    id: obj.id, 
                    name: getBranchDisplayName(obj),
                    name_ru: obj.name?.ru || obj.name,
                    name_en: obj.name?.en || obj.name,
                    name_uz: obj.name?.uz || obj.name
                };
                
                // Сохраняем в localStorage
                saveSelectedValues();
                
                // Загружаем календари для выбранного branch
                loadCalendarsForBranch(obj.id);
                
                // Очищаем все поля при смене branch
                clearField('calendar');
                clearField('group');
                clearField('teacher');
                clearField('room');
                clearField('subject');
                
                // Очищаем расписание при смене branch
                renderTimetable({ days: [] });
                
                // Очищаем кэш данных для фильтров при смене branch
                fullListsCache.group = [];
                fullListsCache.teacher = [];
                fullListsCache.room = [];
                fullListsCache.subject = [];
                
                // Обновляем состояние полей
                updateFieldStates();
                
            } else {
                document.getElementById(inputId).value = obj.name;
                document.getElementById(dropdownId).style.display = 'none';
                
                selectedValues[type] = { 
                    id: obj.id, 
                    name: obj.name,
                    name_ru: obj.name?.ru || obj.name,
                    name_en: obj.name?.en || obj.name,
                    name_uz: obj.name?.uz || obj.name
                };
                
                // Сохраняем в localStorage
                saveSelectedValues();
                
                // Обновляем состояние полей
                updateFieldStates();
                


                // Автоматически загружаем расписание только для фильтров (group, teacher, room, subject)
                if (type === 'group' || type === 'teacher' || type === 'room' || type === 'subject') {
                    // Очищаем другие поля (кроме календаря и branch)
                    if (type === 'group') {
                        clearField('teacher');
                        clearField('room');
                        clearField('subject');
                    } else if (type === 'teacher') {
                        clearField('group');
                        clearField('room');
                        clearField('subject');
                    } else if (type === 'room') {
                        clearField('group');
                        clearField('teacher');
                        clearField('subject');
                    } else if (type === 'subject') {
                        clearField('group');
                        clearField('teacher');
                        clearField('room');
                    }
                    
                    // Автоматически загружаем расписание только если выбран календарь
                    if (selectedValues.calendar && selectedValues.calendar.id) {
                        setTimeout(() => {
                            loadTimetable();
                        }, 100);
                    }
                }
            }
        }

        // Очистка поля
        function clearField(type) {
            document.getElementById(type + 'Input').value = '';
            selectedValues[type] = { id: '', name: '' };
            saveSelectedValues();
            updateFieldStates();
        }

        // Функция отката изменений
        function revertChanges() {
            if (originalTimetableData && pendingChanges.length > 0) {
                renderTimetable(originalTimetableData);
                pendingChanges = [];
                originalTimetableState = null;
                originalTimetableData = null;
            }
        }

        async function loadTimetable() {
            const branchId = selectedValues.branch.id;
            const calendarId = selectedValues.calendar?.id;
            const groupId = selectedValues.group?.id;
            const teacherId = selectedValues.teacher?.id;
            const roomId = selectedValues.room?.id;
            const subjectId = selectedValues.subject?.id;

            console.log('loadTimetable called with:', {
                branchId, calendarId, groupId, teacherId, roomId, subjectId
            });
            console.log('Calendar ID type:', typeof calendarId, 'Value:', calendarId);

            // Проверяем что branch выбран
            if (!branchId) {
                console.log('No branch selected');
                showInfo();
                return;
            }

            // Проверяем что календарь выбран
            if (!calendarId) {
                console.log('No calendar selected');
                showInfo();
                return;
            }

            // Проверяем что хотя бы один фильтр заполнен
            if (!groupId && !teacherId && !roomId && !subjectId) {
                console.log('No filters selected');
                hideInfo();
                renderTimetable({ days: [] });
                return;
            }

            // Показываем загрузку
            showLoading(true);
            hideError();
            hideInfo();

            try {
                // Формируем параметры запроса для URL
                const params = new URLSearchParams();
                params.append('academic_calendar_id', calendarId); // Всегда передаем calendar ID
                if (groupId) params.append('group_id', groupId);
                if (teacherId) params.append('teacher_id', teacherId);
                if (roomId) params.append('room_id', roomId);
                if (subjectId) params.append('subject_id', subjectId);

                // Формируем полный URL с параметрами
                const url = `${TIMETABLES_API_URL}?${params.toString()}`;

                console.log('Fetching timetable from:', url);

                // Отправляем GET запрос
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Timetable data received:', data);
                
                // Сбрасываем originalTimetableData при загрузке нового расписания
                originalTimetableData = null;
                renderTimetable(data);

            } catch (error) {
                console.error('Error loading timetable:', error);
                showError(`Ошибка загрузки: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function renderTimetable(data) {
            
            // Сохраняем данные расписания в глобальной переменной
            window.currentTimetableData = data;
            const tbody = document.getElementById('timetable-body');
            tbody.innerHTML = '';

            // Создаем структуру для быстрого поиска уроков
            const lessonsMap = {};
            
            if (data.days) {
                data.days.forEach(day => {
                    if (day.lessons) {
                        day.lessons.forEach(lesson => {
                            const key = `${day.week_day}-${lesson.lesson_number}`;
                            lessonsMap[key] = lesson;
                        });
                    }
                });
            }

            // Генерируем строки для каждого периода
            periods.forEach(period => {
                const row = document.createElement('tr');
                
                // Ячейка времени
                const timeCell = document.createElement('td');
                timeCell.className = 'day-cell';
                timeCell.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 2px;">${period.period}</div>
                    <div style="font-size: 10px;">${period.starttime}</div>
                    <div style="font-size: 10px;">${period.endtime}</div>
                `;
                row.appendChild(timeCell);

                // Ячейки для каждого дня недели (понедельник-суббота)
                weekDays.forEach(day => {
                    const cell = document.createElement('td');
                    cell.className = 'lesson-cell';
                    
                    const key = `${day.id}-${period.period}`;
                    const lesson = lessonsMap[key];
                    
                    if (lesson) {
                        // Формируем список групп для отображения
                        let groupsDisplay = '';
                        if (lesson.groups && lesson.groups.length > 0) {
                            groupsDisplay = lesson.groups.map(group => group.name).join(', ');
                        }
                        
                        // Формируем список аудиторий для отображения
                        let roomsDisplay = '';
                        if (lesson.rooms && lesson.rooms.length > 0) {
                            roomsDisplay = lesson.rooms.map(room => room.name).join(', ');
                        }
                        
                        // Формируем отображение предмета и преподавателя с проверкой на null
                        const subjectDisplay = lesson.subject?.name || 'Предмет не указан';
                        const teacherDisplay = lesson.teacher?.name || 'Преподаватель не указан';
                        
                        // Формируем отображение типа занятия
                        const lessonTypeDisplay = lesson.lesson_type && lesson.lesson_type !== 'UNKNOWN' 
                            ? getLessonTypeDisplay(lesson.lesson_type) 
                            : '';
                        
                        // Формируем отображение примечания
                        const noteDisplay = lesson.note ? `<div class="lesson-note">📝 ${lesson.note}</div>` : '';
                        
                        cell.innerHTML = `
                            <div class="lesson" data-lesson-id="${lesson.id}">
                                <button class="delete-btn" onclick="deleteLessonFromUI('${lesson.id}')" title="Удалить урок">×</button>
                                <div class="lesson-subject">${subjectDisplay}</div>
                                <div class="lesson-teacher">👨‍🏫 ${teacherDisplay}</div>
                                ${lessonTypeDisplay ? `<div class="lesson-type">📚 ${lessonTypeDisplay}</div>` : ''}
                                <div class="lesson-room">🏢 ${roomsDisplay}</div>
                                <div class="lesson-groups">👥 ${groupsDisplay}</div>
                                ${noteDisplay}
                                <div class="lesson-ids" style="display: none;" 
                                     data-subject-id="${lesson.subject?.id || ''}" 
                                     data-teacher-id="${lesson.teacher?.id || ''}" 
                                     data-rooms='${JSON.stringify(lesson.rooms || [])}'
                                     data-groups='${JSON.stringify(lesson.groups || [])}'
                                     data-week-day="${day.id}"
                                     data-lesson-number="${period.period}"
                                     data-lesson-type="${lesson.lesson_type || ''}"
                                     data-note="${lesson.note || ''}">
                                </div>
                            </div>
                        `;
                        
                        // Добавляем обработчик клика для редактирования
                        const lessonElement = cell.querySelector('.lesson');
                        lessonElement.addEventListener('click', (e) => {
                            if (e.target.classList.contains('delete-btn')) return;
                            
                            // Проверяем, есть ли незавершенные изменения перемещения
                            if (pendingChanges.length > 0) {
                                showAlert('Сначала сохраните или отмените изменения перемещения');
                                return;
                            }
                            
                            
                            
                            // Получаем дополнительные данные из элемента
                            const lessonIds = lessonElement.querySelector('.lesson-ids');
                            const enhancedLesson = { ...lesson };
                            
                            // Убеждаемся, что lessonId присутствует
                            if (!enhancedLesson.id && lessonElement.dataset.lessonId) {
                                enhancedLesson.id = lessonElement.dataset.lessonId;
                            }
                            
                            // Если lessonId все еще нет, пробуем использовать сохраненный currentLessonId
                            if (!enhancedLesson.id && lessonElement.dataset.currentLessonId) {
                                enhancedLesson.id = lessonElement.dataset.currentLessonId;
                            }
                            
                            // Проверяем, что lessonId действительно есть
                            if (!enhancedLesson.id) {
                                showAlert('Ошибка: не удалось определить урок для редактирования');
                                return;
                            }
                            
                            if (lessonIds) {
                                enhancedLesson.week_day = parseInt(lessonIds.dataset.weekDay);
                                enhancedLesson.lesson_number = parseInt(lessonIds.dataset.lessonNumber);
                                
                                // Получаем данные о группах и аудиториях
                                try {
                                    const groups = JSON.parse(lessonIds.dataset.groups || '[]');
                                    if (groups.length > 0) {
                                        enhancedLesson.groups = groups;
                                    }
                                } catch (e) {
                                }
                                
                                try {
                                    const rooms = JSON.parse(lessonIds.dataset.rooms || '[]');
                                    if (rooms.length > 0) {
                                        enhancedLesson.rooms = rooms;
                                    }
                                } catch (e) {
                                }
                                
                                // Получаем тип занятия и примечание
                                if (lessonIds.dataset.lessonType) {
                                    enhancedLesson.lesson_type = lessonIds.dataset.lessonType;
                                }
                                if (lessonIds.dataset.note) {
                                    enhancedLesson.note = lessonIds.dataset.note;
                                }
                                
                                
                            }
                            
                            // Проверяем, что у нас есть id для редактирования
                            if (!enhancedLesson.id) {
                                showAlert('Ошибка: не удалось определить урок для редактирования');
                                return;
                            }
                            
                            openModal(enhancedLesson);
                        });
                    } else {
                        cell.classList.add('empty-cell');
                        cell.style.cursor = 'pointer';
                        cell.addEventListener('click', () => {
                            // Проверяем, есть ли незавершенные изменения перемещения
                            if (pendingChanges.length > 0) {
                                showAlert('Сначала сохраните или отмените изменения перемещения');
                                return;
                            }
                            
                            if (canEdit()) {
                                const position = getCellPosition(cell);
                                openModal(null, position);
                            } else {
                            showAlert('Для добавления урока необходимо выбрать академический календарь и группу, преподавателя или аудиторию');
                            }
                        });
                    }
                    
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
            
            // Очищаем индикацию доступности
            clearDropAvailability();
            
            // Очищаем pendingChanges при загрузке нового расписания
            if (pendingChanges.length > 0) {
                pendingChanges = [];
                originalTimetableState = null;
                // Не сбрасываем originalTimetableData здесь, так как он может понадобиться для отмены
                hideDragDropControls();
            }
            
            // Очищаем все сохраненные currentLessonId при загрузке нового расписания
            document.querySelectorAll('[data-current-lesson-id]').forEach(element => {
                delete element.dataset.currentLessonId;
            });
            
            // Настраиваем drag & drop для всех уроков
            setupDragAndDrop();
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('timetable').style.display = show ? 'none' : 'table';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showInfo() {
            document.getElementById('info').style.display = 'block';
        }

        function hideInfo() {
            document.getElementById('info').style.display = 'none';
        }

        // Переменная для отслеживания активного поля
        let activeInput = null;

        // Функция для плавного показа dropdown
        function showDropdown(dropdown) {
            dropdown.style.display = 'block';
            // Небольшая задержка для применения display: block
            setTimeout(() => {
                dropdown.classList.add('show');
            }, 10);
        }
        
        // Функция для плавного скрытия dropdown
        function hideDropdown(dropdown) {
            dropdown.classList.remove('show');
            setTimeout(() => {
                dropdown.style.display = 'none';
            }, 150); // Время должно совпадать с transition
        }

        // Функция для скрытия всех dropdown кроме указанного
        function hideOtherDropdowns(exceptDropdownId = null) {
            
            const allDropdowns = [
                'calendarDropdown', 'groupDropdown', 'teacherDropdown', 'roomDropdown', 'subjectDropdown',
                'modalTeacherDropdown', 'modalSubjectDropdown', // для модального окна
                'groupsDropdown', 'roomsDropdown' // для множественного выбора
            ];
            
            allDropdowns.forEach(dropdownId => {
                if (dropdownId !== exceptDropdownId) {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown && dropdown.style.display !== 'none') {
                        hideDropdown(dropdown);
                    }
                }
            });
        }

        // Функция для восстановления значений полей
        function restoreFieldValues() {
            let restored = false;
            
            // Проверяем каждое поле и восстанавливаем значение если поле пустое, но есть сохраненное значение
            const fields = [
                { inputId: 'branchInput', type: 'branch' },
                { inputId: 'calendarInput', type: 'calendar' },
                { inputId: 'groupInput', type: 'group' },
                { inputId: 'teacherInput', type: 'teacher' },
                { inputId: 'roomInput', type: 'room' },
                { inputId: 'subjectInput', type: 'subject' }
            ];
            
            fields.forEach(field => {
                const input = document.getElementById(field.inputId);
                
                if (input && input.value.trim() === '' && selectedValues[field.type].name) {
                    input.value = selectedValues[field.type].name;
                    restored = true;
                }
            });
            
            // Проверяем модальные поля
            const modalFields = [
                { inputId: 'teacherField', type: 'teacher' },
                { inputId: 'roomField', type: 'room' },
                { inputId: 'subjectField', type: 'subject' }
            ];
            
            modalFields.forEach(field => {
                const input = document.getElementById(field.inputId);
                if (input && input.value.trim() === '' && selectedValues[field.type].name) {
                    input.value = selectedValues[field.type].name;
                    restored = true;
                }
            });
            
            return restored;
        }

        // Функция для очистки selectedValues для пустых полей
        function clearEmptyFieldValues() {
            const fields = [
                { inputId: 'branchInput', type: 'branch' },
                { inputId: 'calendarInput', type: 'calendar' },
                { inputId: 'groupInput', type: 'group' },
                { inputId: 'teacherInput', type: 'teacher' },
                { inputId: 'roomInput', type: 'room' },
                { inputId: 'subjectInput', type: 'subject' }
            ];
            
            fields.forEach(field => {
                const input = document.getElementById(field.inputId);
                if (input && input.value.trim() === '') {
                    selectedValues[field.type] = { id: '', name: '' };
                }
            });
        }

        // Функция для автоматической загрузки всех фильтров после выбора календаря
        function loadAllFiltersAfterCalendar() {
            if (selectedValues.branch && selectedValues.branch.id && selectedValues.calendar && selectedValues.calendar.id) {
                console.log('Loading all filters after calendar selection...');
                
                // Загружаем все фильтры параллельно
                const filterTypes = ['group', 'teacher', 'room', 'subject'];
                const dropdowns = ['groupDropdown', 'teacherDropdown', 'roomDropdown', 'subjectDropdown'];
                const loadings = ['loadingGroups', 'loadingTeachers', 'loadingRooms', 'loadingSubjects'];
                
                filterTypes.forEach((type, index) => {
                    const dropdown = document.getElementById(dropdowns[index]);
                    const loading = document.getElementById(loadings[index]);
                    if (dropdown && loading) {
                        loadAllObjects(type, dropdown, loading);
                    }
                });
            }
        }

        // Функция для управления состоянием полей в зависимости от зависимостей
        function updateFieldStates() {
            const branchSelected = selectedValues.branch && selectedValues.branch.id;
            const calendarSelected = selectedValues.calendar && selectedValues.calendar.id;
            
            // Поле календаря - доступно только при выбранном branch
            const calendarInput = document.getElementById('calendarInput');
            if (calendarInput) {
                if (branchSelected) {
                    calendarInput.removeAttribute('readonly');
                    calendarInput.placeholder = 'Выберите академический календарь...';
                    calendarInput.style.cursor = 'text';
                } else {
                    calendarInput.setAttribute('readonly', 'readonly');
                    calendarInput.placeholder = 'Выберите филиал сначала...';
                    calendarInput.value = '';
                    calendarInput.style.cursor = 'not-allowed';
                }
            }
            
            // Поля фильтров (groups, teachers, rooms, subjects) - доступны только при выбранном branch И calendar
            const filterInputs = [
                { id: 'groupInput', placeholder: 'Введите название группы...' },
                { id: 'teacherInput', placeholder: 'Введите имя преподавателя...' },
                { id: 'roomInput', placeholder: 'Введите номер аудитории...' },
                { id: 'subjectInput', placeholder: 'Введите название предмета...' }
            ];
            
            filterInputs.forEach(filter => {
                const input = document.getElementById(filter.id);
                if (input) {
                    if (branchSelected && calendarSelected) {
                        input.removeAttribute('readonly');
                        input.placeholder = filter.placeholder;
                        input.style.cursor = 'text';
                    } else {
                        input.setAttribute('readonly', 'readonly');
                        if (!branchSelected) {
                            input.placeholder = 'Выберите филиал сначала...';
                        } else {
                            input.placeholder = 'Выберите академический календарь сначала...';
                        }
                        input.value = '';
                        input.style.cursor = 'not-allowed';
                    }
                }
            });
        }


        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            renderTimetable({ days: [] });
            
            // Обновляем даты в заголовках таблицы
            updateWeekDates();
            
            // Инициализируем состояние полей
            updateFieldStates();
            
            // Загружаем branches
            loadBranches();
            
            // Настраиваем автодополнение для всех полей
            setupAutocomplete('branchInput', 'branchDropdown', 'loadingBranches', 'branch');
            setupAutocomplete('calendarInput', 'calendarDropdown', 'loadingCalendars', 'calendar');
            setupAutocomplete('groupInput', 'groupDropdown', 'loadingGroups', 'group');
            setupAutocomplete('teacherInput', 'teacherDropdown', 'loadingTeachers', 'teacher');
            setupAutocomplete('roomInput', 'roomDropdown', 'loadingRooms', 'room');
            setupAutocomplete('subjectInput', 'subjectDropdown', 'loadingSubjects', 'subject');

            // Загружаем данные для выпадающих списков
            loadDropdownData();
            
            // Глобальный обработчик клика для закрытия выпадающих списков
            document.addEventListener('click', function(event) {
                const target = event.target;
                
                // Проверяем, не является ли цель элементом выпадающего списка или полем ввода
                const isDropdown = target.closest('.autocomplete-dropdown');
                const isInput = target.closest('input[type="text"]');
                const isAutocompleteItem = target.closest('.autocomplete-item');
                
                if (!isDropdown && !isInput && !isAutocompleteItem) {
                    // Закрываем все выпадающие списки
                    hideOtherDropdowns();
                }
            });

            // Настраиваем селектор групп
            setupGroupSelector();
            
            // Настраиваем селектор аудиторий
            setupRoomSelector();

            // Настраиваем автодополнение для модального окна
            setupModalAutocomplete('teacherField', 'modalTeacherDropdown', 'teacher');
            setupModalAutocomplete('subjectField', 'modalSubjectDropdown', 'subject');

            // Закрытие модальных окон при клике вне их
            window.addEventListener('click', function(e) {
                const lessonModal = document.getElementById('lessonModal');
                const confirmModal = document.getElementById('confirmModal');
                const importModal = document.getElementById('importModal');
                
                if (e.target === lessonModal) {
                    closeModal();
                }
                if (e.target === confirmModal) {
                    closeConfirmModal();
                }
                if (e.target === importModal) {
                    closeImportModal();
                }
            });

            

            // Глобальный обработчик для скрытия dropdown при клике вне элемента
            document.addEventListener('click', function(e) {
                // Список всех dropdown элементов
                const dropdowns = [
                    'branchDropdown', 'calendarDropdown', 'groupDropdown', 'teacherDropdown', 'roomDropdown', 'subjectDropdown',
                    'modalTeacherDropdown', 'modalSubjectDropdown', // для модального окна
                    'groupsDropdown', 'roomsDropdown' // для множественного выбора
                ];
                
                // Список всех input элементов
                const inputs = [
                    'branchInput', 'calendarInput', 'groupInput', 'teacherInput', 'roomInput', 'subjectInput',
                    'groupSearch', 'roomSearch', // для множественного выбора
                    'teacherField', 'subjectField' // для модального окна
                ];
                
                // Проверяем, кликнули ли мы вне input и dropdown
                const clickedOnInput = inputs.some(inputId => {
                    const input = document.getElementById(inputId);
                    return input && input.contains(e.target);
                });
                
                const clickedOnDropdown = dropdowns.some(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    return dropdown && dropdown.contains(e.target);
                });
                
                // Если кликнули вне input и dropdown, скрываем все dropdown
                if (!clickedOnInput && !clickedOnDropdown) {
                    console.log('Closing dropdowns - clicked outside');
                    dropdowns.forEach(dropdownId => {
                        const dropdown = document.getElementById(dropdownId);
                        if (dropdown && dropdown.style.display !== 'none') {
                            hideDropdown(dropdown);
                        }
                    });
                    activeInput = null;
                    
                    // Восстанавливаем значения полей если они были очищены
                    const wasRestored = restoreFieldValues();
                    
                    // Очищаем selectedValues для пустых полей только если ничего не было восстановлено
                    if (!wasRestored) {
                        clearEmptyFieldValues();
                    }
                }
            });

            // Обработка клавиши Escape для закрытия модальных окон
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeConfirmModal();
                    closeImportModal();
                }
            });

            // Предупреждение о несохраненных изменениях при закрытии страницы
            window.addEventListener('beforeunload', function(e) {
                if (pendingChanges.length > 0) {
                    e.preventDefault();
                    e.returnValue = 'У вас есть несохраненные изменения. Вы уверены, что хотите покинуть страницу?';
                    return e.returnValue;
                }
            });
            
            // Очищаем уведомления при закрытии страницы
            window.addEventListener('beforeunload', function() {
                clearAllNotifications();
            });
            
            // Обработчики для кнопок drag-and-drop
            document.getElementById('saveChangesBtn').addEventListener('click', saveDragDropChanges);
            document.getElementById('cancelChangesBtn').addEventListener('click', cancelDragDropChanges);
            
            // Настраиваем обработчики для импорта
            setupImportCalendarHandler();
        });
    </script>
</body>
</html>

