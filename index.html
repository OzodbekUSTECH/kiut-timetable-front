<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="origin" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0096db 0%, #0077cc 100%);
            color: white;
            padding: 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-text {
            text-align: left;
        }

        .header-text h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .form-hint {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .language-selector {
            display: flex;
            gap: 5px;
        }

        .language-selector .btn {
            padding: 5px 10px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }

        .language-selector .btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .language-selector .btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .filters {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            align-items: start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .filter-group label {
            font-weight: 500;
            color: #495057;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-input {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .autocomplete-input:focus {
            outline: none;
            border-color: #0096db;
            box-shadow: 0 0 0 0.2rem rgba(0, 150, 219, 0.25);
        }

        .autocomplete-input.current {
            background-color: #e3f2fd;
            border-color: #0096db;
        }

        .search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            pointer-events: none;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-5px);
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        
        .autocomplete-dropdown.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö dropdown */
        #modalTeacherDropdown,
        #modalRoomDropdown,
        #modalSubjectDropdown {
            z-index: 9999;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s;
        }

        .autocomplete-item:hover,
        .autocomplete-item.active {
            background-color: #e3f2fd;
        }
        
        .autocomplete-item.unavailable {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .autocomplete-item.unavailable:hover {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .calendar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .calendar-info {
            flex: 1;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .calendar-info:hover {
            background-color: #f8f9fa;
        }
        
        .calendar-main {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }
        
        .calendar-dates {
            font-size: 0.8em;
            color: #6c757d;
        }
        
        .calendar-actions {
            display: flex;
            gap: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .calendar-item:hover .calendar-actions {
            opacity: 1;
        }
        
        .calendar-actions .btn {
            padding: 2px 6px;
            font-size: 0.8em;
            border-radius: 3px;
        }

        .calendar-year {
            font-weight: 600;
        }

        .calendar-semester {
            color: #6c757d;
            font-size: 12px;
        }

        .calendar-current {
            background-color: #e8f5e8 !important;
            border-left: 3px solid #28a745;
        }

        .no-results {
            padding: 10px 12px;
            color: #6c757d;
            font-style: italic;
        }

        .loading-indicator {
            color: #0096db;
            font-size: 12px;
            margin-top: 4px;
        }

        .current-calendar-label {
            color: #0096db;
            font-size: 12px;
            font-weight: 500;
        }



        .timetable-container {
            overflow-x: auto;
            padding: 20px;
        }
        
        .drag-drop-controls {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .drag-drop-info {
            color: #495057;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .drag-drop-buttons {
            display: flex;
            gap: 10px;
        }
        
        .drag-drop-buttons button {
            min-width: 140px;
        }
        
        @media (max-width: 768px) {
            .drag-drop-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .drag-drop-buttons {
                justify-content: center;
            }
        }

        .timetable {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .timetable th,
        .timetable td {
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
            position: relative;
        }

        .timetable th {
            background-color: #0096db;
            color: white;
            font-weight: 600;
            padding: 12px 8px;
        }

        .time-header {
            background-color: #0077cc !important;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            width: 60px;
            font-size: 12px;
            line-height: 1.2;
        }

        .day-header {
            background-color: #0096db !important;
            color: white;
            padding: 15px 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .day-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .day-date {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
        }

        .day-cell {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            width: 100px;
            padding: 15px 8px;
            font-size: 13px;
        }

        .lesson-cell {
            width: 180px;
            height: 80px;
            padding: 5px;
            background-color: #ffffff;
            transition: background-color 0.3s;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö/–Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ */
        .lesson-cell.available-drop {
            background-color: #d4edda !important;
            border: 2px solid #28a745 !important;
            position: relative;
        }
        
        .lesson-cell.available-drop::after {
            content: "‚úì –î–æ—Å—Ç—É–ø–Ω–æ";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .lesson-cell.unavailable-drop {
            background-color: #f8d7da !important;
            border: 2px solid #dc3545 !important;
            position: relative;
        }
        
        .lesson-cell.unavailable-drop::after {
            content: "‚úó –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .lesson-cell.checking-drop {
            background-color: #fff3cd !important;
            border: 2px solid #ffc107 !important;
            position: relative;
        }
        
        .lesson-cell.checking-drop::after {
            content: "‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ffc107;
            color: #212529;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .lesson-cell:hover {
            background-color: #f8f9fa;
        }

        .lesson {
            background: linear-gradient(135deg, #0096db 0%, #0077cc 100%);
            color: white;
            padding: 8px;
            border-radius: 6px;
            font-size: 11px;
            line-height: 1.3;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 150, 219, 0.2);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .lesson:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 150, 219, 0.3);
        }

        .lesson-subject {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 12px;
        }

        .lesson-teacher {
            font-size: 10px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .lesson-room {
            font-size: 10px;
            opacity: 0.8;
        }

        .lesson-groups {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 2px;
        }

        .lesson-type {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 2px;
            color: #28a745;
            font-weight: 500;
        }

        .lesson-note {
            font-size: 9px;
            opacity: 0.9;
            margin-top: 3px;
            color: #ffc107;
            font-style: italic;
            word-wrap: break-word;
            max-height: 20px;
            overflow: hidden;
        }

        .empty-cell {
            background-color: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #0096db;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #e3f2fd;
            color: #0c5460;
            padding: 15px;
            margin: 20px;
            border-radius: 4px;
            border: 1px solid #0096db;
            text-align: center;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #0096db;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #0096db;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0096db;
            box-shadow: 0 0 0 0.2rem rgba(0, 150, 219, 0.25);
        }

        .form-group select {
            margin-bottom: 5px;
        }

        .form-group input[disabled] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .form-group select[disabled] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .required-field {
            color: #dc3545;
            font-weight: bold;
        }

        .optional-field {
            color: #6c757d;
            font-size: 12px;
            font-weight: normal;
        }

        .field-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            color: #495057;
        }

        .field-input:focus {
            outline: none;
            border-color: #0096db;
            box-shadow: 0 0 0 0.2rem rgba(0, 150, 219, 0.25);
        }

        .field-input[disabled] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            position: sticky;
            bottom: 0;
            background: white;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #0096db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0077cc;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Drag and drop styles */
        .lesson.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .lesson-cell.drag-over {
            background-color: #e3f2fd;
            border: 2px dashed #0096db;
        }

        .delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .lesson:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: #c82333;
        }



        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø */
        .multi-select-container {
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        #notificationContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .notification {
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
            max-height: 100px;
        }

        .notification.hide {
            transform: translateX(100%);
            opacity: 0;
            max-height: 0;
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .notification.info {
            background: linear-gradient(135deg, #0096db, #0077cc);
        }

        .notification-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-message {
            flex: 1;
            word-wrap: break-word;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin: 0;
            opacity: 0.8;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è drag & drop –∑–æ–Ω—ã */
        .drop-zone {
            border: 2px dashed #0096db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drop-zone:hover {
            background: #e3f2fd;
            border-color: #0077cc;
        }

        .drop-zone.drag-over {
            background: #e3f2fd;
            border-color: #28a745;
            transform: scale(1.02);
        }

        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #0096db;
        }

        .drop-zone-text {
            font-size: 16px;
            color: #495057;
            margin-bottom: 10px;
        }

        .drop-zone-hint {
            font-size: 14px;
            color: #6c757d;
        }

        .file-input {
            display: none;
        }

        .import-progress {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #495057;
            text-align: center;
        }

        .import-results {
            margin-top: 20px;
            display: none;
        }

        .result-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .result-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .selected-groups {
            padding: 8px 12px;
            min-height: 40px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .no-groups-selected {
            color: #6c757d;
            font-style: italic;
        }

        .selected-group-tag {
            background: #0096db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-group {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin: 0;
        }
        
        .selected-group-tag.unavailable-tag {
            background: #dc3545;
            opacity: 0.8;
        }

        .group-selector {
            position: relative;
        }

        .groups-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .group-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s;
        }

        .group-option:hover {
            background-color: #e3f2fd;
        }

        .group-option.selected {
            background-color: #0096db;
            color: white;
        }
        
        .group-option.unavailable {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .group-option.unavailable:hover {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .group-option:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
            }

            .time-header {
                writing-mode: horizontal-tb;
                text-orientation: upright;
                width: 80px;
                font-size: 10px;
            }

            .lesson-cell {
                width: 140px;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                max-height: 95vh;
            }
            
            .modal-buttons {
                position: static;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>üìÖ <span data-translate="timetable_title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π</span></h1>
                    <p data-translate="timetable_subtitle">–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</p>
                </div>
                <div class="header-actions">
                    <div class="language-selector">
                        <button class="btn btn-sm" onclick="setLanguage('ru')" id="langRu">üá∑üá∫ RU</button>
                        <button class="btn btn-sm" onclick="setLanguage('en')" id="langEn">üá∫üá∏ EN</button>
                        <button class="btn btn-sm" onclick="setLanguage('uz')" id="langUz">üá∫üáø UZ</button>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="openCreateCalendarModal()" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å">
                        ‚ûï
                    </button>
                    <button class="btn btn-primary" onclick="openImportModal()">
                        üì§ <span data-translate="import">–ò–º–ø–æ—Ä—Ç XML</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="branchInput" data-translate="branch">–§–∏–ª–∏–∞–ª:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="branchInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_branch"
                        placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª..."
                        autocomplete="off"
                    >
                    <span class="search-icon">üè¢</span>
                    <div id="branchDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingBranches" class="loading-indicator" style="display: none;">‚è≥ <span data-translate="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
            </div>

            <div class="filter-group">
                <label for="calendarInput" data-translate="academic_calendar">–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="calendarInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_calendar"
                        placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª —Å–Ω–∞—á–∞–ª–∞..."
                        autocomplete="off"
                        readonly
                    >
                    <span class="search-icon">üìÖ</span>
                    <div id="calendarDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingCalendars" class="loading-indicator" style="display: none;">‚è≥ <span data-translate="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
            </div>

            <div class="filter-group">
                <label for="groupInput" data-translate="group">–ì—Ä—É–ø–ø–∞:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="groupInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_group"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã..."
                        autocomplete="off"
                    >
                    <span class="search-icon">üë•</span>
                    <div id="groupDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingGroups" class="loading-indicator" style="display: none;">‚è≥ <span data-translate="searching">–ü–æ–∏—Å–∫...</span></div>
            </div>

            <div class="filter-group">
                <label for="teacherInput" data-translate="teacher">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="teacherInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_teacher"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è..."
                        autocomplete="off"
                    >
                    <span class="search-icon">üë®‚Äçüè´</span>
                    <div id="teacherDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingTeachers" class="loading-indicator" style="display: none;">‚è≥ <span data-translate="searching">–ü–æ–∏—Å–∫...</span></div>
            </div>

            <div class="filter-group">
                <label for="roomInput" data-translate="room">–ê—É–¥–∏—Ç–æ—Ä–∏—è:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="roomInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_room"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏..."
                        autocomplete="off"
                    >
                    <span class="search-icon">üè¢</span>
                    <div id="roomDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingRooms" class="loading-indicator" style="display: none;">‚è≥ –ü–æ–∏—Å–∫...</div>
            </div>

            <div class="filter-group">
                <label for="subjectInput" data-translate="subject">–ü—Ä–µ–¥–º–µ—Ç:</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="subjectInput" 
                        class="autocomplete-input"
                        data-translate-placeholder="select_subject"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞..."
                        autocomplete="off"
                    >
                    <span class="search-icon">üìö</span>
                    <div id="subjectDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="loadingSubjects" class="loading-indicator" style="display: none;">‚è≥ <span data-translate="searching">–ü–æ–∏—Å–∫...</span></div>
            </div>


            

        </div>





        <div class="timetable-container">
            <div id="loading" class="loading" style="display: none;">
                –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...
            </div>
            <div id="info" class="info">
                –í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –≥—Ä—É–ø–ø—É, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            </div>
            <div id="error" class="error" style="display: none;"></div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–æ—Ç–º–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
            <div id="dragDropControls" class="drag-drop-controls" style="display: none;">
                <div class="drag-drop-info">
                    <i class="fas fa-hand-paper"></i> –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —É—Ä–æ–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
                </div>
                <div class="drag-drop-buttons">
                    <button id="saveChangesBtn" class="btn btn-success">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                    <button id="cancelChangesBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
            <table class="timetable" id="timetable">
                <thead>
                    <tr>
                        <th class="time-header" data-translate="time">–í—Ä–µ–º—è</th>
                        <th class="day-header">
                            <div class="day-name" data-translate="monday">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</div>
                            <div class="day-date" id="monday-date"></div>
                        </th>
                        <th class="day-header">
                            <div class="day-name" data-translate="tuesday">–í—Ç–æ—Ä–Ω–∏–∫</div>
                            <div class="day-date" id="tuesday-date"></div>
                        </th>
                        <th class="day-header">
                            <div class="day-name" data-translate="wednesday">–°—Ä–µ–¥–∞</div>
                            <div class="day-date" id="wednesday-date"></div>
                        </th>
                        <th class="day-header">
                            <div class="day-name" data-translate="thursday">–ß–µ—Ç–≤–µ—Ä–≥</div>
                            <div class="day-date" id="thursday-date"></div>
                        </th>
                        <th class="day-header">
                            <div class="day-name" data-translate="friday">–ü—è—Ç–Ω–∏—Ü–∞</div>
                            <div class="day-date" id="friday-date"></div>
                        </th>
                        <th class="day-header">
                            <div class="day-name" data-translate="saturday">–°—É–±–±–æ—Ç–∞</div>
                            <div class="day-date" id="saturday-date"></div>
                        </th>
                    </tr>
                </thead>
                <tbody id="timetable-body">
                    <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∑–¥–µ—Å—å -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for adding/editing lessons -->
    <div id="lessonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle" data-translate="create_lesson">–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="lessonForm" style="max-height: calc(90vh - 120px); overflow-y: auto;">
                <div class="form-group">
                    <label for="subjectField" data-translate="subject">–ü—Ä–µ–¥–º–µ—Ç: <span class="required-field">*</span></label>
                    <div class="autocomplete-container">
                        <input type="text" id="subjectField" name="subject_name" data-translate-placeholder="select_subject_or_enter" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" class="field-input" required>
                        <span class="search-icon">üìö</span>
                        <div id="modalSubjectDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="teacherField" data-translate="teacher">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: <span class="required-field">*</span></label>
                    <div class="autocomplete-container">
                        <input type="text" id="teacherField" name="teacher_name" data-translate-placeholder="select_teacher_or_enter" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è" class="field-input" required>
                        <span class="search-icon">üë®‚Äçüè´</span>
                        <div id="modalTeacherDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="roomField" data-translate="room">–ê—É–¥–∏—Ç–æ—Ä–∏–∏: <span class="optional-field" data-translate="optional">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
                    <div class="multi-select-container">
                        <div class="selected-groups" id="selectedRooms">
                            <div class="no-groups-selected" data-translate="select_rooms">–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏...</div>
                        </div>
                        <div class="group-selector">
                            <input type="text" id="roomSearch" data-translate-placeholder="search_rooms" placeholder="–ü–æ–∏—Å–∫ –∞—É–¥–∏—Ç–æ—Ä–∏–π..." class="field-input">
                            <div class="groups-dropdown" id="roomsDropdown">
                                <!-- –ê—É–¥–∏—Ç–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelectedRooms()" style="margin-top: 5px; font-size: 11px;">
                        üóëÔ∏è <span data-translate="clear_rooms">–û—á–∏—Å—Ç–∏—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏</span>
                    </button>
                </div>
                <div class="form-group">
                    <label for="groupField" data-translate="group">–ì—Ä—É–ø–ø—ã: <span class="optional-field" data-translate="optional">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
                    <div class="multi-select-container">
                        <div class="selected-groups" id="selectedGroups">
                            <div class="no-groups-selected" data-translate="select_groups">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã...</div>
                        </div>
                        <div class="group-selector">
                            <input type="text" id="groupSearch" data-translate-placeholder="search_groups" placeholder="–ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø..." class="field-input">
                            <div class="groups-dropdown" id="groupsDropdown">
                                <!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelectedGroups()" style="margin-top: 5px; font-size: 11px;">
                        üóëÔ∏è <span data-translate="clear_groups">–û—á–∏—Å—Ç–∏—Ç—å –≥—Ä—É–ø–ø—ã</span>
                    </button>
                </div>
                <div class="form-group">
                    <label for="lessonNumber" data-translate="lesson_number">–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞: <span class="required-field">*</span></label>
                    <select id="lessonNumber" name="lessonNumber" required>
                        <option value="" data-translate="select_lesson_number">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞</option>
                        <option value="1">1 (9:00-9:50)</option>
                        <option value="2">2 (10:00-10:50)</option>
                        <option value="3">3 (11:00-11:50)</option>
                        <option value="4">4 (12:00-12:50)</option>
                        <option value="5">5 (13:00-13:50)</option>
                        <option value="6">6 (14:00-14:50)</option>
                        <option value="7">7 (15:00-15:50)</option>
                        <option value="8">8 (16:00-16:50)</option>
                        <option value="9">9 (17:00-17:50)</option>
                        <option value="10">10 (18:00-18:50)</option>
                        <option value="11">11 (19:00-19:50)</option>
                        <option value="12">12 (20:00-20:50)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="weekDay" data-translate="week_day">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: <span class="required-field">*</span></label>
                    <select id="weekDay" name="weekDay" required>
                        <option value="" data-translate="select_week_day">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏</option>
                        <option value="0" data-translate="monday">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
                        <option value="1" data-translate="tuesday">–í—Ç–æ—Ä–Ω–∏–∫</option>
                        <option value="2" data-translate="wednesday">–°—Ä–µ–¥–∞</option>
                        <option value="3" data-translate="thursday">–ß–µ—Ç–≤–µ—Ä–≥</option>
                        <option value="4" data-translate="friday">–ü—è—Ç–Ω–∏—Ü–∞</option>
                        <option value="5" data-translate="saturday">–°—É–±–±–æ—Ç–∞</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="lessonType" data-translate="lesson_type">–¢–∏–ø –∑–∞–Ω—è—Ç–∏—è: <span class="required-field">*</span></label>
                    <select id="lessonType" name="lessonType" required>
                        <option value="" data-translate="select_lesson_type">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–Ω—è—Ç–∏—è</option>
                        <option value="LECTURE" data-translate="lecture">–õ–µ–∫—Ü–∏—è</option>
                        <option value="SEMINAR" data-translate="seminar">–°–µ–º–∏–Ω–∞—Ä</option>
                        <option value="EXAM" data-translate="exam">–≠–∫–∑–∞–º–µ–Ω</option>
                        <option value="EVENT" data-translate="event">–°–æ–±—ã—Ç–∏–µ</option>
                        <option value="UNKNOWN" data-translate="unknown">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="note">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
                    <textarea id="note" name="note" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2" style="resize: vertical; min-height: 60px;"></textarea>
                </div>
                
                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
                <input type="hidden" id="hiddenLessonNumber" name="hiddenLessonNumber">
                <input type="hidden" id="hiddenWeekDay" name="hiddenWeekDay">
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" id="saveLessonBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Academic Calendar Modal -->
    <div id="createCalendarModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createCalendarModalLabel">üìÖ <span data-translate="create_calendar">–°–æ–∑–¥–∞—Ç—å –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createCalendarForm">
                        <div class="form-group mb-3">
                            <label for="branchSelect"><span data-translate="branch">–§–∏–ª–∏–∞–ª</span>: <span class="required-field">*</span></label>
                            <select id="branchSelect" name="branchSelect" class="form-control" required>
                                <option value=""><span data-translate="select_branch">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª...</span></option>
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="academicYear"><span data-translate="academic_year">–£—á–µ–±–Ω—ã–π –≥–æ–¥</span>: <span class="required-field">*</span></label>
                            <input type="text" id="academicYear" name="academicYear" class="form-control" 
                                   placeholder="2024/2025" pattern="\d{4}/\d{4}" required>
                            <small class="form-hint"><span data-translate="academic_year_placeholder">–Ω–∞–ø—Ä–∏–º–µ—Ä: 2024/2025</span></small>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="semesterSelect"><span data-translate="semester">–°–µ–º–µ—Å—Ç—Ä</span>: <span class="required-field">*</span></label>
                            <select id="semesterSelect" name="semester" class="form-control" required>
                                <option value=""><span data-translate="select_semester">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–º–µ—Å—Ç—Ä</span></option>
                                <option value="1"><span data-translate="first_semester">1 —Å–µ–º–µ—Å—Ç—Ä</span></option>
                                <option value="2"><span data-translate="second_semester">2 —Å–µ–º–µ—Å—Ç—Ä</span></option>
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="startDateInput"><span data-translate="start_date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</span>: <span class="required-field">*</span></label>
                            <input type="date" id="startDateInput" name="startDate" class="form-control" required>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="endDateInput"><span data-translate="end_date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</span>: <span class="required-field">*</span></label>
                            <input type="date" id="endDateInput" name="endDate" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span data-translate="cancel">–û—Ç–º–µ–Ω–∞</span></button>
                    <button type="button" class="btn btn-primary" onclick="createAcademicCalendar()"><span data-translate="create">–°–æ–∑–¥–∞—Ç—å</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üì§ <span data-translate="import_timetable">–ò–º–ø–æ—Ä—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏–∑ XML</span></h2>
                <span class="close" onclick="closeImportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="importBranchSelect" data-translate="branch">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª:</label>
                    <select id="importBranchSelect" class="field-input" onchange="loadCalendarsForImport()">
                        <option value="" data-translate="select_branch">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="importCalendarSelect" data-translate="academic_calendar">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å:</label>
                    <select id="importCalendarSelect" class="field-input" disabled>
                        <option value="" data-translate="select_branch_first">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª...</option>
                    </select>
                </div>
                
                <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="drop-zone-icon">üìÅ</div>
                    <div class="drop-zone-text" data-translate="drag_drop_file">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ XML —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
                    <div class="drop-zone-hint" data-translate="supported_files">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã .xml</div>
                    <input type="file" id="fileInput" class="file-input" accept=".xml" onchange="testFileSelect(this)">
                </div>
                
                <div class="import-progress" id="importProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText" data-translate="preparing_import">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∏–º–ø–æ—Ä—Ç—É...</div>
                </div>
                
                <div class="import-results" id="importResults">
                    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–º–ø–æ—Ä—Ç–∞:</h4>
                    <div id="resultsList"></div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="importBtn" onclick="startImport()" disabled>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
                <span class="close" onclick="closeConfirmModal()">&times;</span>
            </div>
            <p id="confirmMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ?</p>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" id="confirmBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notificationContainer"></div>

    <script>
        // –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
        const translations = {
            ru: {
                // –ó–∞–≥–æ–ª–æ–≤–∫–∏
                'timetable_title': '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π',
                'create_calendar': '–°–æ–∑–¥–∞—Ç—å –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å',
                'import_timetable': '–ò–º–ø–æ—Ä—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏–∑ XML',
                'create_lesson': '–°–æ–∑–¥–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ',
                'edit_lesson': '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ',
                
                // –§–∏–ª—å—Ç—Ä—ã
                'branch': '–§–∏–ª–∏–∞–ª',
                'academic_calendar': '–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å',
                'group': '–ì—Ä—É–ø–ø–∞',
                'teacher': '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å',
                'room': '–ê—É–¥–∏—Ç–æ—Ä–∏—è',
                'subject': '–ü—Ä–µ–¥–º–µ—Ç',
                
                // –ö–Ω–æ–ø–∫–∏
                'create': '–°–æ–∑–¥–∞—Ç—å',
                'edit': '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
                'delete': '–£–¥–∞–ª–∏—Ç—å',
                'save': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                'cancel': '–û—Ç–º–µ–Ω–∞',
                'import': '–ò–º–ø–æ—Ä—Ç',
                'export': '–≠–∫—Å–ø–æ—Ä—Ç',
                'search': '–ü–æ–∏—Å–∫',
                'clear': '–û—á–∏—Å—Ç–∏—Ç—å',
                
                // –§–æ—Ä–º—ã
                'academic_year': '–£—á–µ–±–Ω—ã–π –≥–æ–¥',
                'semester': '–°–µ–º–µ—Å—Ç—Ä',
                'first_semester': '1 —Å–µ–º–µ—Å—Ç—Ä',
                'second_semester': '2 —Å–µ–º–µ—Å—Ç—Ä',
                'start_date': '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞',
                'end_date': '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è',
                'select_branch': '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª...',
                'select_calendar': '–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å...',
                'select_group': '–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É...',
                'select_teacher': '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è...',
                'select_room': '–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é...',
                'select_subject': '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...',
                
                // –°–æ–æ–±—â–µ–Ω–∏—è
                'calendar_created': '–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!',
                'calendar_updated': '–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!',
                'lesson_created': '–ó–∞–Ω—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!',
                'lesson_updated': '–ó–∞–Ω—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!',
                'lesson_deleted': '–ó–∞–Ω—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!',
                'import_success': '–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!',
                'error_loading': '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏',
                'error_creating': '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
                'error_updating': '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è',
                'error_deleting': '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è',
                
                // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
                'academic_year_placeholder': '–Ω–∞–ø—Ä–∏–º–µ—Ä: 2024/2025',
                'drag_drop_file': '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ XML —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞',
                'supported_files': '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã .xml',
                'preparing_import': '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∏–º–ø–æ—Ä—Ç—É...',
                'select_semester': '–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–º–µ—Å—Ç—Ä',
                'loading': '–ó–∞–≥—Ä—É–∑–∫–∞...',
                'searching': '–ü–æ–∏—Å–∫...',
                'timetable_subtitle': '–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ',
                'error_invalid_year_format': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —É—á–µ–±–Ω–æ–≥–æ –≥–æ–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: 2024/2025',
                'select_branch_first': '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª...',
                'select_calendar_first': '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å',
                'update_calendar': '–û–±–Ω–æ–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å',

                'edit_calendar': '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å',
                'create_new_calendar': '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å',
                'calendar_updated': '–ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ–±–Ω–æ–≤–ª–µ–Ω',
                'error_updating': '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è',
                'error_loading_calendar': '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è',
                'time': '–í—Ä–µ–º—è',
                'optional': '(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',
                'select_subject_or_enter': '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ',
                'select_teacher_or_enter': '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è',
                'select_rooms': '–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏...',
                'search_rooms': '–ü–æ–∏—Å–∫ –∞—É–¥–∏—Ç–æ—Ä–∏–π...',
                'clear_rooms': '–û—á–∏—Å—Ç–∏—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏',
                'select_groups': '–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã...',
                'search_groups': '–ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø...',
                'clear_groups': '–û—á–∏—Å—Ç–∏—Ç—å –≥—Ä—É–ø–ø—ã',
                'lesson_number': '–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞',
                'select_lesson_number': '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞',
                'week_day': '–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏',
                'select_week_day': '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏',
                'lesson_type': '–¢–∏–ø –∑–∞–Ω—è—Ç–∏—è',
                'select_lesson_type': '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–Ω—è—Ç–∏—è',
                'lecture': '–õ–µ–∫—Ü–∏—è',
                'seminar': '–°–µ–º–∏–Ω–∞—Ä',
                'exam': '–≠–∫–∑–∞–º–µ–Ω',
                'event': '–°–æ–±—ã—Ç–∏–µ',
                'unknown': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                
                // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
                'monday': '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
                'tuesday': '–í—Ç–æ—Ä–Ω–∏–∫',
                'wednesday': '–°—Ä–µ–¥–∞',
                'thursday': '–ß–µ—Ç–≤–µ—Ä–≥',
                'friday': '–ü—è—Ç–Ω–∏—Ü–∞',
                'saturday': '–°—É–±–±–æ—Ç–∞',
                'sunday': '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
            },
            en: {
                // Headers
                'timetable_title': 'Class Schedule',
                'create_calendar': 'Create Academic Calendar',
                'import_timetable': 'Import Schedule from XML',
                'create_lesson': 'Create Lesson',
                'edit_lesson': 'Edit Lesson',
                
                // Filters
                'branch': 'Branch',
                'academic_calendar': 'Academic Calendar',
                'group': 'Group',
                'teacher': 'Teacher',
                'room': 'Room',
                'subject': 'Subject',
                
                // Buttons
                'create': 'Create',
                'edit': 'Edit',
                'delete': 'Delete',
                'save': 'Save',
                'cancel': 'Cancel',
                'import': 'Import',
                'export': 'Export',
                'search': 'Search',
                'clear': 'Clear',
                
                // Forms
                'academic_year': 'Academic Year',
                'semester': 'Semester',
                'first_semester': '1st Semester',
                'second_semester': '2nd Semester',
                'start_date': 'Start Date',
                'end_date': 'End Date',
                'select_branch': 'Select branch...',
                'select_calendar': 'Select academic calendar...',
                'select_group': 'Select group...',
                'select_teacher': 'Select teacher...',
                'select_room': 'Select room...',
                'select_subject': 'Select subject...',
                
                // Messages
                'calendar_created': 'Academic calendar created successfully!',
                'calendar_updated': 'Academic calendar updated successfully!',
                'lesson_created': 'Lesson created successfully!',
                'lesson_updated': 'Lesson updated successfully!',
                'lesson_deleted': 'Lesson deleted successfully!',
                'import_success': 'Import completed successfully!',
                'error_loading': 'Error loading',
                'error_creating': 'Error creating',
                'error_updating': 'Error updating',
                'error_deleting': 'Error deleting',
                
                // Placeholders
                'academic_year_placeholder': 'e.g.: 2024/2025',
                'drag_drop_file': 'Drag and drop XML file here or click to select',
                'supported_files': 'Supported files: .xml',
                'preparing_import': 'Preparing import...',
                'select_semester': 'Select semester',
                'loading': 'Loading...',
                'searching': 'Searching...',
                'timetable_subtitle': 'University Schedule',
                'error_invalid_year_format': 'Invalid academic year format. Use format: 2024/2025',
                'select_branch_first': 'Select branch first...',
                'select_calendar_first': 'Select calendar first',
                'update_calendar': 'Update calendar',

                'edit_calendar': 'Edit calendar',
                'create_new_calendar': 'Create new calendar',
                'calendar_updated': 'Calendar updated',
                'error_updating': 'Error updating',
                'error_loading_calendar': 'Error loading calendar',
                'time': 'Time',
                'optional': '(optional)',
                'select_subject_or_enter': 'Select subject or enter name',
                'select_teacher_or_enter': 'Select teacher or enter name',
                'select_rooms': 'Select rooms...',
                'search_rooms': 'Search rooms...',
                'clear_rooms': 'Clear rooms',
                'select_groups': 'Select groups...',
                'search_groups': 'Search groups...',
                'clear_groups': 'Clear groups',
                'lesson_number': 'Lesson number',
                'select_lesson_number': 'Select lesson number',
                'week_day': 'Week day',
                'select_week_day': 'Select week day',
                'lesson_type': 'Lesson type',
                'select_lesson_type': 'Select lesson type',
                'lecture': 'Lecture',
                'seminar': 'Seminar',
                'exam': 'Exam',
                'event': 'Event',
                'unknown': 'Unknown',
                
                // Days of week
                'monday': 'Monday',
                'tuesday': 'Tuesday',
                'wednesday': 'Wednesday',
                'thursday': 'Thursday',
                'friday': 'Friday',
                'saturday': 'Saturday',
                'sunday': 'Sunday'
            },
            uz: {
                // Sarlavhalar
                'timetable_title': 'Dars jadvali',
                'create_calendar': 'Akademik kalendar yaratish',
                'import_timetable': 'XML dan jadvalni import qilish',
                'create_lesson': 'Dars yaratish',
                'edit_lesson': 'Darsni tahrirlash',
                
                // Filtrlar
                'branch': 'Filial',
                'academic_calendar': 'Akademik kalendar',
                'group': 'Guruh',
                'teacher': 'O\'qituvchi',
                'room': 'Xona',
                'subject': 'Fan',
                
                // Tugmalar
                'create': 'Yaratish',
                'edit': 'Tahrirlash',
                'delete': 'O\'chirish',
                'save': 'Saqlash',
                'cancel': 'Bekor qilish',
                'import': 'Import',
                'export': 'Eksport',
                'search': 'Qidirish',
                'clear': 'Tozalash',
                
                // Formalar
                'academic_year': 'O\'quv yili',
                'semester': 'Semestr',
                'first_semester': '1-semestr',
                'second_semester': '2-semestr',
                'start_date': 'Boshlanish sanasi',
                'end_date': 'Tugash sanasi',
                'select_branch': 'Filialni tanlang...',
                'select_calendar': 'Akademik kalendarni tanlang...',
                'select_group': 'Guruhni tanlang...',
                'select_teacher': 'O\'qituvchini tanlang...',
                'select_room': 'Xonani tanlang...',
                'select_subject': 'Fanni tanlang...',
                
                // Xabarlar
                'calendar_created': 'Akademik kalendar muvaffaqiyatli yaratildi!',
                'calendar_updated': 'Akademik kalendar muvaffaqiyatli yangilandi!',
                'lesson_created': 'Dars muvaffaqiyatli yaratildi!',
                'lesson_updated': 'Dars muvaffaqiyatli yangilandi!',
                'lesson_deleted': 'Dars muvaffaqiyatli o\'chirildi!',
                'import_success': 'Import muvaffaqiyatli yakunlandi!',
                'error_loading': 'Yuklash xatosi',
                'error_creating': 'Yaratish xatosi',
                'error_updating': 'Yangilash xatosi',
                'error_deleting': 'O\'chirish xatosi',
                
                // Placeholderlar
                'academic_year_placeholder': 'masalan: 2024/2025',
                'drag_drop_file': 'XML faylni bu yerga tashlang yoki tanlash uchun bosing',
                'supported_files': 'Qo\'llab-quvvatlanadigan fayllar: .xml',
                'preparing_import': 'Import tayyorlanmoqda...',
                'select_semester': 'Semestrni tanlang',
                'loading': 'Yuklanmoqda...',
                'searching': 'Qidirilmoqda...',
                'timetable_subtitle': 'Universitet jadvali',
                'error_invalid_year_format': 'Noto\'g\'ri o\'quv yili formati. Formatni ishlating: 2024/2025',
                'select_branch_first': 'Avval filialni tanlang...',
                'select_calendar_first': 'Avval kalendarni tanlang',
                'update_calendar': 'Kalendarni yangilash',

                'edit_calendar': 'Kalendarni tahrirlash',
                'create_new_calendar': 'Yangi kalendar yaratish',
                'calendar_updated': 'Kalendar yangilandi',
                'error_updating': 'Yangilash xatosi',
                'error_loading_calendar': 'Kalendarni yuklash xatosi',
                'time': 'Vaqt',
                'optional': '(ixtiyoriy)',
                'select_subject_or_enter': 'Fanni tanlang yoki nomini kiriting',
                'select_teacher_or_enter': 'O\'qituvchini tanlang yoki ismini kiriting',
                'select_rooms': 'Xonalarni tanlang...',
                'search_rooms': 'Xonalarni qidirish...',
                'clear_rooms': 'Xonalarni tozalash',
                'select_groups': 'Guruhlarni tanlang...',
                'search_groups': 'Guruhlarni qidirish...',
                'clear_groups': 'Guruhlarni tozalash',
                'lesson_number': 'Dars raqami',
                'select_lesson_number': 'Dars raqamini tanlang',
                'week_day': 'Hafta kuni',
                'select_week_day': 'Hafta kunini tanlang',
                'lesson_type': 'Dars turi',
                'select_lesson_type': 'Dars turini tanlang',
                'lecture': 'Ma\'ruza',
                'seminar': 'Seminar',
                'exam': 'Imtihon',
                'event': 'Tadbir',
                'unknown': 'Noma\'lum',
                
                // Hafta kunlari
                'monday': 'Dushanba',
                'tuesday': 'Seshanba',
                'wednesday': 'Chorshanba',
                'thursday': 'Payshanba',
                'friday': 'Juma',
                'saturday': 'Shanba',
                'sunday': 'Yakshanba'
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞
        function t(key) {
            return translations[currentLanguage]?.[key] || translations.ru[key] || key;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö —Ç–∞–±–ª–∏—Ü—ã
        function updateWeekDates() {
            const today = new Date();
            const currentDay = today.getDay(); // 0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, ...
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
            const monday = new Date(today);
            const daysToMonday = currentDay === 0 ? 6 : currentDay - 1; // –ï—Å–ª–∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, —Ç–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –±—ã–ª 6 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
            monday.setDate(today.getDate() - daysToMonday);
            
            // –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
            const weekDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
            weekDays.forEach((day, index) => {
                const date = new Date(monday);
                date.setDate(monday.getDate() + index);
                
                const dateElement = document.getElementById(`${day}-date`);
                console.log(`Looking for element: ${day}-date`, dateElement); // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                
                if (dateElement) {
                    const dayOfMonth = date.getDate();
                    const month = date.getMonth() + 1;
                    const dateText = `${dayOfMonth.toString().padStart(2, '0')}.${month.toString().padStart(2, '0')}`;
                    dateElement.textContent = dateText;
                    console.log(`Updated ${day}-date with: ${dateText}`); // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
                    if (date.toDateString() === today.toDateString()) {
                        dateElement.style.color = '#ffd700';
                        dateElement.style.fontWeight = 'bold';
                    } else {
                        dateElement.style.color = 'rgba(255, 255, 255, 0.8)';
                        dateElement.style.fontWeight = '400';
                    }
                } else {
                    console.log(`Element ${day}-date not found!`); // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        async function updateAcademicCalendar(calendarId, updateData) {
            try {
                const response = await fetch(`${ACADEMIC_CALENDARS_API_URL}${calendarId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                showNotification(t('calendar_updated'), 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (selectedValues.branch.id) {
                    loadCalendarsForBranch();
                }
                
                return result;
            } catch (error) {
                showNotification(`${t('error_updating')}: ${error.message}`, 'error');
                throw error;
            }
        }



        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        async function editCalendar(calendarId, event) {
            event.stopPropagation();
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                const response = await fetch(`${ACADEMIC_CALENDARS_API_URL}${calendarId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const calendar = await response.json();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∏–ª–∏–∞–ª—ã –∏ –≤—ã–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
                await loadBranchesForCreate();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const modalLabel = document.getElementById('createCalendarModalLabel');
                if (modalLabel) {
                    modalLabel.textContent = t('edit_calendar');
                }
                document.getElementById('academicYear').value = calendar.academic_year;
                document.getElementById('semesterSelect').value = calendar.semester;
                document.getElementById('startDateInput').value = calendar.start_date;
                document.getElementById('endDateInput').value = calendar.end_date;
                
                // –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–∏–ª–∏–∞–ª
                const branchSelect = document.getElementById('branchSelect');
                if (branchSelect && calendar.branch_id) {
                    branchSelect.value = calendar.branch_id;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = new bootstrap.Modal(document.getElementById('createCalendarModal'));
                modal.show();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                document.getElementById('createCalendarModal').setAttribute('data-edit-id', calendarId);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                showNotification(t('error_loading_calendar'), 'error');
            }
        }



        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
        let notificationCounter = 0;
        
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const currentId = ++notificationCounter;
            notification.dataset.id = currentId;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <span class="notification-icon">${icons[type] || icons.info}</span>
                <span class="notification-message">${message}</span>
                <button class="notification-close" onclick="removeNotification(${currentId})">√ó</button>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Å–≤–µ—Ä—Ö—É)
            container.insertBefore(notification, container.firstChild);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            if (duration > 0) {
                setTimeout(() => {
                    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É
                    if (notification.parentElement) {
                        notification.classList.remove('show');
                        notification.classList.add('hide');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }
            
            return currentId;
        }
        
        function removeNotification(id) {
            const notification = document.querySelector(`[data-id="${id}"]`);
            if (notification) {
                notification.classList.remove('show');
                notification.classList.add('hide');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }
        

        
        function clearAllNotifications() {
            const container = document.getElementById('notificationContainer');
            const notifications = container.querySelectorAll('.notification');
            notifications.forEach(notification => {
                notification.classList.remove('show');
                notification.classList.add('hide');
            });
            setTimeout(() => {
                container.innerHTML = '';
            }, 300);
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
        let selectedFile = null;
        let selectedCalendarId = null;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function openCreateCalendarModal() {
            const modal = document.getElementById('createCalendarModal');
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            loadBranchesForCreate();
        }

        function closeCreateCalendarModal() {
            const modal = document.getElementById('createCalendarModal');
            const bootstrapModal = bootstrap.Modal.getInstance(modal);
            if (bootstrapModal) {
                bootstrapModal.hide();
            }
            document.getElementById('createCalendarForm').reset();
            
            // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            modal.removeAttribute('data-edit-id');
            const modalLabel = document.getElementById('createCalendarModalLabel');
            if (modalLabel) {
                modalLabel.textContent = t('create_calendar');
            }
        }

        async function loadBranchesForCreate() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if (fullListsCache.branch && fullListsCache.branch.length > 0) {
                    const select = document.getElementById('branchSelect');
                    select.innerHTML = `<option value="">${t('select_branch')}</option>`;
                    
                    fullListsCache.branch.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.id;
                        option.textContent = getBranchDisplayName(branch);
                        select.appendChild(option);
                    });
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª–∏–∞–ª –µ—Å–ª–∏ –æ–Ω –≤—ã–±—Ä–∞–Ω
                    if (selectedValues.branch && selectedValues.branch.id) {
                        select.value = selectedValues.branch.id;
                    }
                } else {
                    // –ï—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    const response = await fetch(`${BRANCHES_API_URL}?disable_pagination=true`);
                    if (response.ok) {
                        const data = await response.json();
                        const branches = data.items || data;
                        const select = document.getElementById('branchSelect');
                        select.innerHTML = `<option value="">${t('select_branch')}</option>`;
                        
                        branches.forEach(branch => {
                            const option = document.createElement('option');
                            option.value = branch.id;
                            option.textContent = getBranchDisplayName(branch);
                            select.appendChild(option);
                        });
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª–∏–∞–ª –µ—Å–ª–∏ –æ–Ω –≤—ã–±—Ä–∞–Ω
                        if (selectedValues.branch && selectedValues.branch.id) {
                            select.value = selectedValues.branch.id;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading branches for create:', error);
                showNotification(t('error_loading'), 'error');
            }
        }


        

        

        

        


        async function createAcademicCalendar() {
            const form = document.getElementById('createCalendarForm');
            const formData = new FormData(form);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —É—á–µ–±–Ω–æ–≥–æ –≥–æ–¥–∞
            const academicYear = formData.get('academicYear');
            if (!/^\d{4}\/\d{4}$/.test(academicYear)) {
                showNotification(t('error_invalid_year_format'), 'error');
                return;
            }
            
            const calendarData = {
                branch_id: formData.get('branchSelect'), // –ò—Å–ø–æ–ª—å–∑—É–µ–º UUID –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
                academic_year: academicYear,
                semester: parseInt(formData.get('semester')),
                start_date: formData.get('startDate'),
                end_date: formData.get('endDate')
            };

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ª–∏ –º—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            const editId = document.getElementById('createCalendarModal').getAttribute('data-edit-id');
            const isEditing = editId !== null;

            try {
                const url = isEditing ? `${ACADEMIC_CALENDARS_API_URL}${editId}` : ACADEMIC_CALENDARS_API_URL;
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(calendarData)
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                showNotification(isEditing ? t('calendar_updated') : t('calendar_created'), 'success');
                closeCreateCalendarModal();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (selectedValues.branch.id) {
                    loadCalendarsForBranch();
                }
            } catch (error) {
                showNotification(`${isEditing ? t('error_updating') : t('error_creating')}: ${error.message}`, 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–º–ø–æ—Ä—Ç–æ–º
        function openImportModal() {
            console.log('openImportModal called');
            const modal = document.getElementById('importModal');
            modal.style.display = 'block';
            loadBranchesForImport();
            console.log('Setting up drag and drop...');
            setupFileDragAndDrop();
            console.log('Drag and drop setup complete');
        }

        function closeImportModal() {
            const modal = document.getElementById('importModal');
            modal.style.display = 'none';
            resetImportForm();
        }

        function resetImportForm() {
            selectedFile = null;
            document.getElementById('dropZone').classList.remove('drag-over');
            document.getElementById('dropZone').innerHTML = `
                <div class="drop-zone-icon">üìÅ</div>
                <div class="drop-zone-text" data-translate="drag_drop_file">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ XML —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
                <div class="drop-zone-hint" data-translate="supported_files">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã .xml</div>
                <input type="file" id="fileInput" class="file-input" accept=".xml">
            `;
            document.getElementById('importBranchSelect').value = '';
            document.getElementById('importCalendarSelect').innerHTML = `<option value="">${t('select_branch_first')}</option>`;
            document.getElementById('importCalendarSelect').disabled = true;
            document.getElementById('importBtn').disabled = true;
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importResults').style.display = 'none';
            setupFileDragAndDrop();
        }

        async function loadBranchesForImport() {
            try {
                const response = await fetch(`${BRANCHES_API_URL}?disable_pagination=true`);
                if (response.ok) {
                    const data = await response.json();
                    const branches = data.items || data;
                    const select = document.getElementById('importBranchSelect');
                    select.innerHTML = `<option value="">${t('select_branch')}</option>`;
                    
                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.id;
                        option.textContent = getBranchDisplayName(branch);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                showNotification(t('error_loading'), 'error');
            }
        }



        function setupFileDragAndDrop() {
            console.log('=== SETUP FILE DRAG AND DROP ===');
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            console.log('Drop zone found:', dropZone);
            console.log('File input found:', fileInput);
            console.log('Drop zone HTML:', dropZone ? dropZone.outerHTML : 'NOT FOUND');
            
            if (!dropZone || !fileInput) {
                console.error('Drop zone or file input not found!');
                return;
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
                console.log('=== DRAG OVER ===');
                console.log('Event target:', e.target);
                console.log('Drop zone:', dropZone);
            });

            dropZone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
                console.log('Drag enter drop zone');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∏–¥–∞–µ–º drop zone
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('drag-over');
                    console.log('Drag leave drop zone');
                }
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
                console.log('=== FILE DROPPED ===');
                console.log('Event target:', e.target);
                console.log('DataTransfer files:', e.dataTransfer.files);
                console.log('Files length:', e.dataTransfer.files.length);
                
                const files = e.dataTransfer.files;
                console.log('Files in drop event:', files.length);
                
                if (files.length > 0) {
                    const file = files[0];
                    console.log('File dropped:', file.name, file.type);
                    
                    if (file.type === 'text/xml' || file.name.endsWith('.xml')) {
                        console.log('Valid XML file, processing...');
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        showNotification(`–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${file.name}`, 'success');

                        // –û–±–Ω–æ–≤–ª—è–µ–º drop zone
                        const dropZone = document.getElementById('dropZone');
                        dropZone.innerHTML = `
                            <div class="drop-zone-icon">‚úÖ</div>
                            <div class="drop-zone-text">–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${file.name}</div>
                            <div class="drop-zone-hint">–†–∞–∑–º–µ—Ä: ${(file.size / 1024).toFixed(1)} KB</div>
                            <button class="btn btn-sm btn-secondary" onclick="resetFileSelection()">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª</button>
                            <input type="file" id="fileInput" class="file-input" accept=".xml" onchange="testFileSelect(this)">
                        `;
                        // –£–±–∏—Ä–∞–µ–º onclick —Å drop zone, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞
                        dropZone.removeAttribute('onclick');

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
                        selectedFile = file;
                        console.log('File saved to selectedFile:', selectedFile);

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∏–º–ø–æ—Ä—Ç–∞
                        checkImportReady();
                    } else {
                        console.log('Invalid file type:', file.type);
                        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ XML —Ñ–∞–π–ª', 'warning');
                    }
                } else {
                    console.log('No files in drop event');
                }
            });
            
            console.log('File drag and drop setup complete');
        }

        function handleFileSelect(file) {
            console.log('handleFileSelect called with file:', file);
            selectedFile = file;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const dropZone = document.getElementById('dropZone');
            console.log('Updating drop zone display');
            
            dropZone.innerHTML = `
                <div class="drop-zone-icon">‚úÖ</div>
                <div class="drop-zone-text">–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${file.name}</div>
                <div class="drop-zone-hint">–†–∞–∑–º–µ—Ä: ${(file.size / 1024).toFixed(1)} KB</div>
                <button class="btn btn-sm btn-secondary" onclick="resetFileSelection()">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª</button>
                <input type="file" id="fileInput" class="file-input" accept=".xml">
            `;
            
            console.log('Drop zone updated, calling checkImportReady');
            checkImportReady();
        }

        function resetFileSelection() {
            console.log('resetFileSelection called');
            selectedFile = null;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º drop zone
            const dropZone = document.getElementById('dropZone');
            dropZone.innerHTML = `
                <div class="drop-zone-icon">üìÅ</div>
                <div class="drop-zone-text" data-translate="drag_drop_file">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ XML —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
                <div class="drop-zone-hint" data-translate="supported_files">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã .xml</div>
                <input type="file" id="fileInput" class="file-input" accept=".xml" onchange="testFileSelect(this)">
            `;
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º onclick
            dropZone.onclick = function() {
                document.getElementById('fileInput').click();
            };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∏–º–ø–æ—Ä—Ç–∞
            checkImportReady();
        }

        // –ü—Ä–æ—Å—Ç–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        function testFileSelect(input) {
            console.log('=== TEST FILE SELECT ===');
            console.log('Input element:', input);
            console.log('Input files:', input.files);
            console.log('Files length:', input.files ? input.files.length : 'no files');
            
            if (input.files && input.files.length > 0) {
                const file = input.files[0];
                console.log('File selected:', file);
                console.log('File name:', file.name);
                console.log('File type:', file.type);
                console.log('File size:', file.size);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification(`–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${file.name}`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º drop zone
                const dropZone = document.getElementById('dropZone');
                dropZone.innerHTML = `
                    <div class="drop-zone-icon">‚úÖ</div>
                    <div class="drop-zone-text">–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${file.name}</div>
                    <div class="drop-zone-hint">–†–∞–∑–º–µ—Ä: ${(file.size / 1024).toFixed(1)} KB</div>
                    <button class="btn btn-sm btn-secondary" onclick="resetFileSelection()">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª</button>
                    <input type="file" id="fileInput" class="file-input" accept=".xml" onchange="testFileSelect(this)">
                `;
                // –£–±–∏—Ä–∞–µ–º onclick —Å drop zone, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞
                dropZone.removeAttribute('onclick');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
                selectedFile = file;
                console.log('File saved to selectedFile:', selectedFile);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∏–º–ø–æ—Ä—Ç–∞
                checkImportReady();
            } else {
                console.log('No file selected - this is normal when just opening the dialog');
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ñ–∞–π–ª –ø—Ä–æ—Å—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
            }
        }

        function checkImportReady() {
            console.log('checkImportReady called');
            const branchSelect = document.getElementById('importBranchSelect');
            const calendarSelect = document.getElementById('importCalendarSelect');
            const importBtn = document.getElementById('importBtn');
            
            console.log('selectedFile:', selectedFile);
            console.log('branchSelect.value:', branchSelect.value);
            console.log('calendarSelect.value:', calendarSelect.value);
            
            if (selectedFile && branchSelect.value && calendarSelect.value) {
                console.log('All conditions met, enabling import button');
                importBtn.disabled = false;
            } else {
                console.log('Some conditions not met, disabling import button');
                importBtn.disabled = true;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function setupImportCalendarHandler() {
            const calendarSelect = document.getElementById('importCalendarSelect');
            if (calendarSelect) {
                calendarSelect.addEventListener('change', function() {
                    checkImportReady();
                });
            }
        }

        async function startImport() {
            const branchSelect = document.getElementById('importBranchSelect');
            const calendarSelect = document.getElementById('importCalendarSelect');
            
            if (!selectedFile || !branchSelect.value || !calendarSelect.value) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª, —Ñ–∏–ª–∏–∞–ª –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å', 'warning');
                return;
            }

            const progressDiv = document.getElementById('importProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const resultsDiv = document.getElementById('importResults');
            const resultsList = document.getElementById('resultsList');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            progressDiv.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...';

            try {
                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
                const formData = new FormData();
                formData.append('file', selectedFile);

                progressFill.style.width = '30%';
                progressText.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...';

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch(`${TIMETABLES_API_URL}parse?academic_calendar_id=${calendarSelect.value}`, {
                    method: 'POST',
                    body: formData
                });

                progressFill.style.width = '60%';
                progressText.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                progressFill.style.width = '100%';
                progressText.textContent = '–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                resultsDiv.style.display = 'block';
                resultsList.innerHTML = '';

                if (result.success) {
                    showNotification('–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    if (result.imported_lessons) {
                        const successItem = document.createElement('div');
                        successItem.className = 'result-item result-success';
                        successItem.textContent = `‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —É—Ä–æ–∫–æ–≤: ${result.imported_lessons}`;
                        resultsList.appendChild(successItem);
                    }

                    if (result.errors && result.errors.length > 0) {
                        const errorItem = document.createElement('div');
                        errorItem.className = 'result-item result-error';
                        errorItem.textContent = `‚ùå –û—à–∏–±–æ–∫: ${result.errors.length}`;
                        resultsList.appendChild(errorItem);
                    }

                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                    setTimeout(() => {
                        loadTimetable();
                    }, 1000);
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ', 'error');
                    
                    if (result.errors) {
                        result.errors.forEach(error => {
                            const errorItem = document.createElement('div');
                            errorItem.className = 'result-item result-error';
                            errorItem.textContent = `‚ùå ${error}`;
                            resultsList.appendChild(errorItem);
                        });
                    }
                }

            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
                
                progressFill.style.width = '0%';
                progressText.textContent = '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞';
                
                resultsDiv.style.display = 'block';
                resultsList.innerHTML = `
                    <div class="result-item result-error">
                        ‚ùå –û—à–∏–±–∫–∞: ${error.message}
                    </div>
                `;
            }
        }



        // –ó–∞–º–µ–Ω—è–µ–º alert –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showAlert(message, type = 'info') {
            showNotification(message, type, 8000); // 8 —Å–µ–∫—É–Ω–¥ –¥–ª—è alert-—Å–æ–æ–±—â–µ–Ω–∏–π
        }

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —É—Ä–æ–∫–æ–≤
        const periods = [
            { period: 1, starttime: "9:00", endtime: "9:50" },
            { period: 2, starttime: "10:00", endtime: "10:50" },
            { period: 3, starttime: "11:00", endtime: "11:50" },
            { period: 4, starttime: "12:00", endtime: "12:50" },
            { period: 5, starttime: "13:00", endtime: "13:50" },
            { period: 6, starttime: "14:00", endtime: "14:50" },
            { period: 7, starttime: "15:00", endtime: "15:50" },
            { period: 8, starttime: "16:00", endtime: "16:50" },
            { period: 9, starttime: "17:00", endtime: "17:50" },
            { period: 10, starttime: "18:00", endtime: "18:50" },
            { period: 11, starttime: "19:00", endtime: "19:50" },
            { period: 12, starttime: "20:00", endtime: "20:50" }
        ];

        // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ (0-5: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-—Å—É–±–±–æ—Ç–∞)
        const weekDays = [
            { id: 0, name: "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" },
            { id: 1, name: "–í—Ç–æ—Ä–Ω–∏–∫" },
            { id: 2, name: "–°—Ä–µ–¥–∞" },
            { id: 3, name: "–ß–µ—Ç–≤–µ—Ä–≥" },
            { id: 4, name: "–ü—è—Ç–Ω–∏—Ü–∞" },
            { id: 5, name: "–°—É–±–±–æ—Ç–∞" }
        ];

        // URL –≤–∞—à–µ–≥–æ API
        const API_URL = 'http://172.16.3.77:8000/api';
        const BRANCHES_API_URL = `${API_URL}/branches/`;
        const TIMETABLES_API_URL = `${API_URL}/timetables/`;
        const ACADEMIC_CALENDARS_API_URL = `${API_URL}/academic-calendars/`;
        const GROUPS_API_URL = `${API_URL}/groups/`;
        const TEACHERS_API_URL = `${API_URL}/teachers/`;
        const ROOMS_API_URL = `${API_URL}/rooms/`;
        const SUBJECTS_API_URL = `${API_URL}/subjects/`;

        // –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        let selectedValues = {
            branch: { id: '', name: '' },
            calendar: { id: '', name: '' },
            group: { id: '', name: '', name_ru: '', name_en: '', name_uz: '' },
            teacher: { id: '', name: '', name_ru: '', name_en: '', name_uz: '' },
            room: { id: '', name: '', name_ru: '', name_en: '', name_uz: '' },
            subject: { id: '', name: '', name_ru: '', name_en: '', name_uz: '' }
        };

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage
        function saveSelectedValues() {
            localStorage.setItem('timetableSelectedValues', JSON.stringify(selectedValues));
        }

        function loadSelectedValues() {
            const saved = localStorage.getItem('timetableSelectedValues');
            if (saved) {
                selectedValues = JSON.parse(saved);
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
                Object.keys(selectedValues).forEach(type => {
                    const input = document.getElementById(type + 'Input');
                    if (input && selectedValues[type].name) {
                        if (type === 'branch') {
                            input.value = selectedValues[type].name;
                        } else {
                            input.value = selectedValues[type].name;
                        }
                    }
                });
                

            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–µ–π
            updateFieldStates();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö —Ç–∞–±–ª–∏—Ü—ã
            updateWeekDates();
            
            // –Ø–∑—ã–∫ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        }

        // –ö—ç—à –¥–ª—è –ø–æ–ª–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
        let fullListsCache = {
            branch: [],
            calendar: [],
            group: [],
            teacher: [],
            room: [],
            subject: []
        };

        // –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ–∏—Å–∫–∞
        let searchTimeouts = {};
        
        // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—â–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤
        let loadingRequests = {
            branch: false,
            calendar: false,
            group: false,
            teacher: false,
            room: false,
            subject: false
        };
        
        // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å dropdown
        let dropdownActionInProgress = {
            branch: false,
            calendar: false,
            group: false,
            teacher: false,
            room: false,
            subject: false
        };

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let currentLessonId = null;
        let draggedLesson = null;
        let pendingChanges = [];
        let originalTimetableState = null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        let originalTimetableData = null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø
        let selectedGroups = [];
        let allGroups = [];
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–π
        let selectedRooms = [];
        let allRooms = [];
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        async function getAvailableSlots(lessonId) {
            try {
                const params = new URLSearchParams();
                
                // –î–æ–±–∞–≤–ª—è–µ–º branch_id –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω branch
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                const response = await fetch(`${TIMETABLES_API_URL}${lessonId}/available-slots?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                return [];
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–ª–æ—Ç–∞
        async function checkSlotAvailability(lessonId, position) {
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const lessonElement = document.querySelector(`[data-lesson-id="${lessonId}"]`);
                let availableSlots = [];
                
                if (lessonElement && lessonElement.dataset.availableSlots) {
                    availableSlots = JSON.parse(lessonElement.dataset.availableSlots);
    
                } else {
                    // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
                    availableSlots = await getAvailableSlots(lessonId);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–∑–∏—Ü–∏—è –≤ —Å–ø–∏—Å–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
                const isAvailable = availableSlots.some(slot => 
                    slot.week_day === position.weekDay && 
                    slot.lesson_number === position.lessonNumber
                );
                


                
                return isAvailable;
            } catch (error) {

                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                return true;
            }
        }
        

        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö —Å–ª–æ—Ç–æ–≤
        async function showDropAvailability() {
            if (!draggedLesson) return;
            
            const lessonId = draggedLesson.dataset.lessonId;
            if (!lessonId) return;
            
            
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–≥–æ —É—Ä–æ–∫–∞
            try {
                const availableSlots = await getAvailableSlots(lessonId);

                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ —É—Ä–æ–∫–∞ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
                draggedLesson.dataset.availableSlots = JSON.stringify(availableSlots);
                
                const cells = document.querySelectorAll('.lesson-cell');
                
                for (const cell of cells) {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —è—á–µ–π–∫—É, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º
                    if (cell.contains(draggedLesson)) continue;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏
                    cell.classList.add('checking-drop');
                    
                    const position = getCellPosition(cell);
                    if (position) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑—É—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        const isAvailable = availableSlots.some(slot => 
                            slot.week_day === position.weekDay && 
                            slot.lesson_number === position.lessonNumber
                        );
                        
                        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏
                        cell.classList.remove('checking-drop');
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å
                        if (isAvailable) {
                            cell.classList.add('available-drop');
                        } else {
                            cell.classList.add('unavailable-drop');
                        }
                    }
                }
            } catch (error) {

                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–ª–æ—Ç—ã –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ
                const cells = document.querySelectorAll('.lesson-cell');
                cells.forEach(cell => {
                    if (!cell.contains(draggedLesson)) {
                        cell.classList.add('unavailable-drop');
                    }
                });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
        function clearDropAvailability() {
            const cells = document.querySelectorAll('.lesson-cell');
            cells.forEach(cell => {
                cell.classList.remove('available-drop', 'unavailable-drop', 'checking-drop');
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –ø–æ–∫–∞–∑–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª–æ—Ç–∞
        function checkAndShowSlotAvailability(cell) {
            if (!draggedLesson) return;
            
            const lessonId = draggedLesson.dataset.lessonId;
            if (!lessonId) return;
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —è—á–µ–π–∫—É, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º
            if (cell.contains(draggedLesson)) return;
            
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã
            cell.classList.remove('available-drop', 'unavailable-drop', 'checking-drop');
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
            const availableSlotsData = draggedLesson.dataset.availableSlots;
            if (availableSlotsData) {
                try {
                    const availableSlots = JSON.parse(availableSlotsData);
                    const position = getCellPosition(cell);
                    
                    if (position) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑—É—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        const isAvailable = availableSlots.some(slot => 
                            slot.week_day === position.weekDay && 
                            slot.lesson_number === position.lessonNumber
                        );
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å
                        if (isAvailable) {
                            cell.classList.add('available-drop');
                        } else {
                            cell.classList.add('unavailable-drop');
                        }
                    }
                } catch (error) {
                    cell.classList.add('unavailable-drop');
                }
            } else {
                // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π
                cell.classList.add('unavailable-drop');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        async function getAvailableItems(type, academicCalendarId, weekDay, lessonNumber, excludeLessonId = null) {
            try {
                let apiUrl;
                switch (type) {
                    case 'teachers':
                        apiUrl = TEACHERS_API_URL;
                        break;
                    case 'groups':
                        apiUrl = GROUPS_API_URL;
                        break;
                    case 'rooms':
                        apiUrl = ROOMS_API_URL;
                        break;
                    default:
                        throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø: ${type}`);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                const params = new URLSearchParams({
                    academic_calendar_id: academicCalendarId,
                    week_day: weekDay,
                    lesson_number: lessonNumber
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º branch_id –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω branch
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                if (excludeLessonId) {
                    params.append('exclude_lesson_id', excludeLessonId);
                }
                
                const response = await fetch(`${apiUrl}?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ${type}: ${response.status}`);
                }
                
                const data = await response.json();
                return data.items || data;
            } catch (error) {
                return [];
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        async function loadAvailableItemsForModal(weekDay, lessonNumber, excludeLessonId = null) {
            if (!selectedValues.calendar.id || weekDay === undefined || lessonNumber === undefined) {

                return Promise.resolve();
            }
            
            try {

                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
                const availableTeachers = await getAvailableItems('teachers', selectedValues.calendar.id, weekDay, lessonNumber, excludeLessonId);

                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–ø–ø—ã
                const availableGroups = await getAvailableItems('groups', selectedValues.calendar.id, weekDay, lessonNumber, excludeLessonId);

                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
                const availableRooms = await getAvailableItems('rooms', selectedValues.calendar.id, weekDay, lessonNumber, excludeLessonId);

                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                fullListsCache.teacher = availableTeachers;
                fullListsCache.group = availableGroups;
                fullListsCache.room = availableRooms;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
                allGroups = availableGroups;
                allRooms = availableRooms;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ

                updateModalAvailability();
                
                return Promise.resolve();
                
            } catch (error) {
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                return Promise.resolve();
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        function updateModalAvailability() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
            const teacherField = document.getElementById('teacherField');
            if (teacherField) {
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                const currentTeacher = fullListsCache.teacher.find(t => t.name === teacherField.value);
                if (teacherField.value && !currentTeacher) {
                    teacherField.value = '';
                    teacherField.style.backgroundColor = '#ffebee';
                    teacherField.title = '–≠—Ç–æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è';
                } else if (teacherField.value && currentTeacher) {
                    teacherField.style.backgroundColor = 'white';
                    teacherField.title = '';
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä—É–ø–ø
            updateGroupsDropdownAvailability();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–π
            updateRoomsDropdownAvailability();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø –∏ –∞—É–¥–∏—Ç–æ—Ä–∏–π
            updateSelectedGroupsDisplay();
            updateSelectedRoomsDisplay();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ dropdown –≥—Ä—É–ø–ø
        function updateGroupsDropdownAvailability() {
            const dropdown = document.getElementById('groupsDropdown');
            if (!dropdown) return;
            

            
            dropdown.innerHTML = '';
            
            fullListsCache.group.forEach(group => {
                const option = document.createElement('div');
                option.className = 'group-option';
                option.textContent = group.name;
                
                if (group.hasOwnProperty('is_available') && !group.is_available) {
                    option.classList.add('unavailable');
                    option.textContent += ' (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)';
                    option.title = '–≠—Ç–∞ –≥—Ä—É–ø–ø–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è';

                }
                
                option.onclick = () => toggleGroup(group);
                dropdown.appendChild(option);
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ dropdown –∞—É–¥–∏—Ç–æ—Ä–∏–π
        function updateRoomsDropdownAvailability() {
            const dropdown = document.getElementById('roomsDropdown');
            if (!dropdown) return;
            

            
            dropdown.innerHTML = '';
            
            fullListsCache.room.forEach(room => {
                const option = document.createElement('div');
                option.className = 'group-option';
                option.textContent = room.name;
                
                if (room.hasOwnProperty('is_available') && !room.is_available) {
                    option.classList.add('unavailable');
                    option.textContent += ' (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)';
                    option.title = '–≠—Ç–∞ –∞—É–¥–∏—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è';

                }
                
                option.onclick = () => toggleRoom(room);
                dropdown.appendChild(option);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
        async function loadDropdownData() {
            try {
                // –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ–º branches –∑–¥–µ—Å—å, –æ–Ω–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ loadBranches()
                // fullListsCache.branch —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω
                
                // –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã (groups, teachers, rooms, subjects) –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                // –û–Ω–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ branch –∏ calendar
                
                console.log('loadDropdownData: –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ branches –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ loadDropdownData:', error);
            }
        }



        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã–±–æ—Ä–æ–º –≥—Ä—É–ø–ø
        async function loadAllGroups() {
            try {
                const params = new URLSearchParams();
                params.append('disable_pagination', 'true');
                
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                const response = await fetch(`${GROUPS_API_URL}?${params.toString()}`);
                if (response.ok) {
                    const data = await response.json();
                    const groups = data.items || data;
                    allGroups = groups;
                    fullListsCache.group = groups;
                    filterGroups(document.getElementById('groupSearch').value.trim().toLowerCase());
                }
            } catch (error) {
            }
        }

        function setupGroupSelector() {
            const groupSearch = document.getElementById('groupSearch');
            const groupsDropdown = document.getElementById('groupsDropdown');
            
            groupSearch.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                if (allGroups.length > 0) {
                    filterGroups(query);
                }
            });
            
            groupSearch.addEventListener('focus', function() {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ dropdown –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –Ω–æ–≤–æ–º –ø–æ–ª–µ
                hideOtherDropdowns('groupsDropdown');
                activeInput = 'groupSearch';
                
                setTimeout(() => {
                    if (allGroups.length > 0) {
                        showGroupsDropdown();
                        filterGroups(this.value.trim().toLowerCase());
                } else {
                        // –ï—Å–ª–∏ –≥—Ä—É–ø–ø—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
                        loadAllGroups();
                    }
                }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
            });
        }

        function filterGroups(query) {
            const groupsDropdown = document.getElementById('groupsDropdown');
            groupsDropdown.innerHTML = '';
            
            const filteredGroups = allGroups.filter(group => 
                group.name.toLowerCase().includes(query)
            );
            
            if (filteredGroups.length === 0) {
                groupsDropdown.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            } else {
                filteredGroups.forEach(group => {
                    const option = document.createElement('div');
                    option.className = 'group-option';
                    option.textContent = group.name;
                    option.dataset.groupId = group.id;
                    option.dataset.groupName = group.name;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≥—Ä—É–ø–ø—ã
                    if (group.hasOwnProperty('is_available') && !group.is_available) {
                        option.classList.add('unavailable');
                        option.textContent += ' (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)';
                        option.title = '–≠—Ç–∞ –≥—Ä—É–ø–ø–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è';
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ —É–∂–µ —ç—Ç–∞ –≥—Ä—É–ø–ø–∞
                    if (selectedGroups.some(sg => sg.id === group.id)) {
                        option.classList.add('selected');
                    }
                    
                    option.addEventListener('click', () => toggleGroup(group));
                    groupsDropdown.appendChild(option);
                });
            }
            
            showGroupsDropdown();
        }

        function showGroupsDropdown() {
            const groupsDropdown = document.getElementById('groupsDropdown');
            groupsDropdown.style.display = 'block';
        }

        function toggleGroup(group) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≥—Ä—É–ø–ø—ã
            if (!group.is_available) {
                showAlert('–≠—Ç–∞ –≥—Ä—É–ø–ø–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è', 'warning');
                return;
            }
            
            const existingIndex = selectedGroups.findIndex(sg => sg.id === group.id);
            
            if (existingIndex >= 0) {
                // –£–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É
                selectedGroups.splice(existingIndex, 1);
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É
                selectedGroups.push(group);
            }
            
            updateSelectedGroupsDisplay();
            // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≥—Ä—É–ø–ø—ã
            filterGroups(document.getElementById('groupSearch').value);
        }

        function updateSelectedGroupsDisplay() {
            const selectedGroupsContainer = document.getElementById('selectedGroups');
            
            if (selectedGroups.length === 0) {
                selectedGroupsContainer.innerHTML = '<div class="no-groups-selected">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã...</div>';
            } else {
                selectedGroupsContainer.innerHTML = '';
                selectedGroups.forEach(group => {
                    const tag = document.createElement('div');
                    tag.className = 'selected-group-tag';
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≥—Ä—É–ø–ø—ã
                    const isAvailable = group.is_available !== false; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ—Å—Ç—É–ø–Ω–∞
                    if (!isAvailable) {
                        tag.classList.add('unavailable-tag');
                        tag.title = '–≠—Ç–∞ –≥—Ä—É–ø–ø–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è';
                    }
                    
                    tag.innerHTML = `
                        ${group.name}${!isAvailable ? ' (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)' : ''}
                        <button class="remove-group" onclick="removeGroup('${group.id}')">√ó</button>
                    `;
                    selectedGroupsContainer.appendChild(tag);
                });
            }
        }

        function removeGroup(groupId) {
            selectedGroups = selectedGroups.filter(group => group.id !== groupId);
            updateSelectedGroupsDisplay();
            filterGroups(document.getElementById('groupSearch').value);
        }

        function clearSelectedGroups() {
            selectedGroups = [];
            updateSelectedGroupsDisplay();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã–±–æ—Ä–æ–º –∞—É–¥–∏—Ç–æ—Ä–∏–π
        async function loadAllRooms() {
            try {
                const params = new URLSearchParams();
                params.append('disable_pagination', 'true');
                
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                const response = await fetch(`${ROOMS_API_URL}?${params.toString()}`);
                if (response.ok) {
                    const data = await response.json();
                    const rooms = data.items || data;
                    allRooms = rooms;
                    fullListsCache.room = rooms;
                    filterRooms(document.getElementById('roomSearch').value.trim().toLowerCase());
                }
            } catch (error) {
            }
        }

        function setupRoomSelector() {
            const roomSearch = document.getElementById('roomSearch');
            const roomsDropdown = document.getElementById('roomsDropdown');
            
            roomSearch.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                if (allRooms.length > 0) {
                    filterRooms(query);
                }
            });
            
            roomSearch.addEventListener('focus', function() {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ dropdown –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –Ω–æ–≤–æ–º –ø–æ–ª–µ
                hideOtherDropdowns('roomsDropdown');
                activeInput = 'roomSearch';
                
                setTimeout(() => {
                    if (allRooms.length > 0) {
                        showRoomsDropdown();
                        filterRooms(this.value.trim().toLowerCase());
                    } else {
                        // –ï—Å–ª–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
                        loadAllRooms();
                    }
                }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
            });
        }

        function filterRooms(query) {
            const roomsDropdown = document.getElementById('roomsDropdown');
            roomsDropdown.innerHTML = '';
            
            const filteredRooms = allRooms.filter(room => 
                room.name.toLowerCase().includes(query)
            );
            
            if (filteredRooms.length === 0) {
                roomsDropdown.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            } else {
                filteredRooms.forEach(room => {
                    const option = document.createElement('div');
                    option.className = 'group-option';
                    option.textContent = room.name;
                    option.dataset.roomId = room.id;
                    option.dataset.roomName = room.name;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏
                    if (room.hasOwnProperty('is_available') && !room.is_available) {
                        option.classList.add('unavailable');
                        option.textContent += ' (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)';
                        option.title = '–≠—Ç–∞ –∞—É–¥–∏—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è';
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ —É–∂–µ —ç—Ç–∞ –∞—É–¥–∏—Ç–æ—Ä–∏—è
                    if (selectedRooms.some(sr => sr.id === room.id)) {
                        option.classList.add('selected');
                    }
                    
                    option.addEventListener('click', () => toggleRoom(room));
                    roomsDropdown.appendChild(option);
                });
            }
            
            showRoomsDropdown();
        }

        function showRoomsDropdown() {
            const roomsDropdown = document.getElementById('roomsDropdown');
            roomsDropdown.style.display = 'block';
        }

        function toggleRoom(room) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏
            if (!room.is_available) {
                showAlert('–≠—Ç–∞ –∞—É–¥–∏—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è', 'warning');
                return;
            }

            const existingIndex = selectedRooms.findIndex(sr => sr.id === room.id);
            
            if (existingIndex >= 0) {
                // –£–¥–∞–ª—è–µ–º –∞—É–¥–∏—Ç–æ—Ä–∏—é
                selectedRooms.splice(existingIndex, 1);
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏—Ç–æ—Ä–∏—é
                selectedRooms.push(room);
            }
            
            updateSelectedRoomsDisplay();
            // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
            filterRooms(document.getElementById('roomSearch').value);
        }

        function updateSelectedRoomsDisplay() {
            const selectedRoomsContainer = document.getElementById('selectedRooms');
            
            if (selectedRooms.length === 0) {
                selectedRoomsContainer.innerHTML = '<div class="no-groups-selected">–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏...</div>';
            } else {
                selectedRoomsContainer.innerHTML = '';
                selectedRooms.forEach(room => {
                    const tag = document.createElement('div');
                    tag.className = 'selected-group-tag';
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏
                    const isAvailable = room.is_available !== false; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ—Å—Ç—É–ø–Ω–∞
                    if (!isAvailable) {
                        tag.classList.add('unavailable-tag');
                        tag.title = '–≠—Ç–∞ –∞—É–¥–∏—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è';
                    }
                    
                    tag.innerHTML = `
                        ${room.name}${!isAvailable ? ' (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)' : ''}
                        <button class="remove-group" onclick="removeRoom('${room.id}')">√ó</button>
                    `;
                    selectedRoomsContainer.appendChild(tag);
                });
            }
        }

        function removeRoom(roomId) {
            selectedRooms = selectedRooms.filter(room => room.id !== roomId);
            updateSelectedRoomsDisplay();
            filterRooms(document.getElementById('roomSearch').value);
        }

        function clearSelectedRooms() {
            selectedRooms = [];
            updateSelectedRoomsDisplay();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
        function clearField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = '';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∏–ø–∞ –∑–∞–Ω—è—Ç–∏—è
        function getLessonTypeDisplay(lessonType) {
            const typeMap = {
                'LECTURE': '–õ–µ–∫—Ü–∏—è',
                'SEMINAR': '–°–µ–º–∏–Ω–∞—Ä',
                'EXAM': '–≠–∫–∑–∞–º–µ–Ω',
                'EVENT': '–°–æ–±—ã—Ç–∏–µ',
                'UNKNOWN': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
            };
            return typeMap[lessonType] || lessonType;
        }



        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ drag & drop
        function setupDragAndDrop() {
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ drag & drop
            if (!originalTimetableData && window.currentTimetableData) {
                originalTimetableData = JSON.parse(JSON.stringify(window.currentTimetableData));
            }
            
            document.querySelectorAll('.lesson').forEach(lesson => {
                lesson.draggable = true;
                lesson.addEventListener('dragstart', handleDragStart);
                lesson.addEventListener('dragend', handleDragEnd);
            });
            
            document.querySelectorAll('.lesson-cell').forEach(cell => {
                cell.addEventListener('dragover', handleDragOver);
                cell.addEventListener('drop', handleDrop);
                cell.addEventListener('dragenter', handleDragEnter);
                cell.addEventListener('dragleave', handleDragLeave);
            });
        }



        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞
        function getCurrentLessonData(lessonId) {
            const lessonElement = document.querySelector(`[data-lesson-id="${lessonId}"]`);
            if (!lessonElement) return {};
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            const lessonIds = lessonElement.querySelector('.lesson-ids');
            if (!lessonIds) return {};
            
            const currentData = {};
            
            // –ü–æ–ª—É—á–∞–µ–º subject_id
            const subjectId = lessonIds.dataset.subjectId;
            if (subjectId) currentData.subject_id = subjectId;
            
            // –ü–æ–ª—É—á–∞–µ–º teacher_id
            const teacherId = lessonIds.dataset.teacherId;
            if (teacherId) currentData.teacher_id = teacherId;
            
            // –ü–æ–ª—É—á–∞–µ–º rooms
            try {
                const rooms = JSON.parse(lessonIds.dataset.rooms || '[]');
                if (rooms.length > 0) {
                    currentData.room_ids = rooms.map(room => room.id);
                }
            } catch (e) {
            }
            
            // –ü–æ–ª—É—á–∞–µ–º groups
            try {
                const groups = JSON.parse(lessonIds.dataset.groups || '[]');
                if (groups.length > 0) {
                    currentData.group_ids = groups.map(group => group.id);
                }
            } catch (e) {
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const weekDay = lessonIds.dataset.weekDay;
            if (weekDay !== undefined) currentData.week_day = parseInt(weekDay);
            
            const lessonNumber = lessonIds.dataset.lessonNumber;
            if (lessonNumber !== undefined) currentData.lesson_number = parseInt(lessonNumber);
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –∑–∞–Ω—è—Ç–∏—è
            const lessonType = lessonIds.dataset.lessonType;
            if (lessonType) currentData.lesson_type = lessonType;
            
            // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
            const note = lessonIds.dataset.note;
            if (note) currentData.note = note;
            
            return currentData;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ —Ç–æ–ª—å–∫–æ —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
        function createPartialUpdateData(newData, originalData = {}) {
            const updateData = {};
            
            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ
            Object.keys(newData).forEach(key => {
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –º–∞—Å—Å–∏–≤–æ–≤
                if (Array.isArray(newData[key]) && Array.isArray(originalData[key])) {
                    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤—ã –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
                    const newArray = newData[key].sort();
                    const originalArray = originalData[key].sort();
                    const arraysEqual = newArray.length === originalArray.length && 
                        newArray.every((val, index) => val === originalArray[index]);
                    
                    if (!arraysEqual) {
                        updateData[key] = newData[key];
                    }
                } else if (newData[key] !== originalData[key]) {
                    // –í–∫–ª—é—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è, –Ω–æ –Ω–µ null –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                    if (key === 'subject_id' || key === 'teacher_id') {
                        // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º null –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                        if (newData[key] !== null) {
                            updateData[key] = newData[key];
                        }
                    } else {
                        updateData[key] = newData[key];
                    }
                }
            });
            
            return updateData;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        function createMoveUpdateData(lessonData) {
            const moveData = {};
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (lessonData.lesson_number !== undefined && lessonData.lesson_number !== null) {
                moveData.lesson_number = lessonData.lesson_number;
            }
            if (lessonData.week_day !== undefined && lessonData.week_day !== null) {
                moveData.week_day = lessonData.week_day;
            }
            
            return moveData;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function canEdit() {
            // –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω branch, –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∏–ª—å—Ç—Ä
            return selectedValues.branch.id && selectedValues.calendar.id && (selectedValues.group.id || selectedValues.teacher.id || selectedValues.room.id || selectedValues.subject.id);
        }



        // Drag and Drop —Ñ—É–Ω–∫—Ü–∏–∏
        function handleDragStart(e) {
            if (!canEdit()) {
                e.preventDefault();
                showAlert('–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –≥—Ä—É–ø–ø—É, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é');
                return;
            }
            
            draggedLesson = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö —Å–ª–æ—Ç–æ–≤
            showDropAvailability();
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            
            // –û—á–∏—â–∞–µ–º –∫—ç—à –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
            if (draggedLesson && draggedLesson.dataset.availableSlots) {
                delete draggedLesson.dataset.availableSlots;
            }
            
            draggedLesson = null;
            
            // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            clearDropAvailability();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–ª–æ—Ç–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
            if (e.target.classList.contains('lesson-cell') && draggedLesson) {
                checkAndShowSlotAvailability(e.target);
            }
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            if (draggedLesson && e.target.classList.contains('lesson-cell')) {
                const newPosition = getCellPosition(e.target);
                const oldPosition = getLessonPosition(draggedLesson);
                const lessonId = draggedLesson.dataset.lessonId;
                
                if (newPosition && oldPosition) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–æ–≤–æ–≥–æ —Å–ª–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const availableSlotsData = draggedLesson.dataset.availableSlots;
                    let isAvailable = false;
                    
                    if (availableSlotsData) {
                        try {
                            const availableSlots = JSON.parse(availableSlotsData);
                            isAvailable = availableSlots.some(slot => 
                                slot.week_day === newPosition.weekDay && 
                                slot.lesson_number === newPosition.lessonNumber
                            );
                        } catch (error) {
                            
                            isAvailable = true; // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                        }
                    } else {
                        isAvailable = true;
                    }
                    
                    if (isAvailable) {
                    moveLesson(draggedLesson, oldPosition, newPosition);
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–æ—Ç–º–µ–Ω—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        if (pendingChanges.length > 0) {
                            showDragDropControls();
                        }
                    } else {
                        showAlert('–≠—Ç–æ—Ç —Å–ª–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è');
                    }
                    
                    // –û—á–∏—â–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                    clearDropAvailability();
                }
            }
        }

        function getCellPosition(cell) {
            const row = cell.parentElement;
            const dayIndex = Array.from(row.children).indexOf(cell) - 1; // -1 –¥–ª—è —É—á–µ—Ç–∞ —è—á–µ–π–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
            const periodIndex = Array.from(row.parentElement.children).indexOf(row);
            
            return {
                weekDay: dayIndex,
                lessonNumber: periodIndex + 1
            };
        }

        function getLessonPosition(lesson) {
            const cell = lesson.closest('.lesson-cell');
            return getCellPosition(cell);
        }

        function moveLesson(lesson, oldPos, newPos) {
            const oldCell = document.querySelector(`tr:nth-child(${oldPos.lessonNumber}) td:nth-child(${oldPos.weekDay + 2})`);
            const newCell = document.querySelector(`tr:nth-child(${newPos.lessonNumber}) td:nth-child(${newPos.weekDay + 2})`);
            
            if (oldCell && newCell) {
                newCell.appendChild(lesson);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º lessonId
                const lessonId = lesson.dataset.lessonId;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–∫—Ä—ã—Ç–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ —É—Ä–æ–∫–∞
                const lessonIds = lesson.querySelector('.lesson-ids');
                if (lessonIds) {
                    lessonIds.dataset.lessonNumber = newPos.lessonNumber;
                    lessonIds.dataset.weekDay = newPos.weekDay;
                }
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ lessonId —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ
                if (lessonId) {
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ lessonId –æ—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                    setTimeout(() => {
                        const movedLesson = document.querySelector(`[data-lesson-id="${lessonId}"]`);
                        if (movedLesson) {
                            // LessonId –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
                        } else {
                            // LessonId –ø–æ—Ç–µ—Ä—è–Ω
                        }
                    }, 100);
                } else {
                    // LessonId –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                }
                
                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ç–æ–ª—å–∫–æ —Å –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                const lessonData = {};
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (oldPos.lessonNumber !== newPos.lessonNumber) {
                    lessonData.lesson_number = newPos.lessonNumber;
                }
                if (oldPos.weekDay !== newPos.weekDay) {
                    lessonData.week_day = newPos.weekDay;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
                if (Object.keys(lessonData).length > 0) {
                    const changeData = {
                        lessonId: lesson.dataset.lessonId,
                        lessonData: lessonData
                    };
                    
                    addPendingChange('move', changeData);
                } else {
                    // –ü–æ–∑–∏—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è drag-and-drop –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
        function showDragDropControls() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if (pendingChanges.length > 0) {
                const controls = document.getElementById('dragDropControls');
                if (controls) {
                    controls.style.display = 'flex';
                }
            }
        }
        
        function hideDragDropControls() {
            const controls = document.getElementById('dragDropControls');
            if (controls) {
                controls.style.display = 'none';
            }
        }
        
        function saveDragDropChanges() {
            if (pendingChanges.length === 0) {
                hideDragDropControls();
                clearDropAvailability();
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            saveChangesAsync();
        }
        
        function cancelDragDropChanges() {
            if (pendingChanges.length > 0) {
                const shouldCancel = confirm('–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è? –≠—Ç–æ –≤–µ—Ä–Ω–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é.');
                if (shouldCancel) {
                    let dataRestored = false;
                    
                    if (originalTimetableData) {
                        renderTimetable(originalTimetableData);
                        originalTimetableData = null; // –°–±—Ä–æ—Å–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                        dataRestored = true;
                    } else if (window.currentTimetableData) {
                        // –ï—Å–ª–∏ originalTimetableData –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                        renderTimetable(window.currentTimetableData);
                        dataRestored = true;
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤–æ–æ–±—â–µ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                        loadTimetable();
                        dataRestored = true;
                    }
                    
                    
                    if (dataRestored) {
                        pendingChanges = [];
                        hideDragDropControls();
                        clearDropAvailability();
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º drag & drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
                        setupDragAndDrop();
                    }
                }
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã
                hideDragDropControls();
                clearDropAvailability();
            }
        }
        
        async function saveChangesAsync() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                if (pendingChanges.length === 0) {
                    return;
                }
                
                for (const change of pendingChanges) {
                    switch (change.type) {
                        case 'move':
                            // –î–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                            const moveData = createMoveUpdateData(change.data.lessonData);
                            
                            if (Object.keys(moveData).length > 0) {
                                // –î–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º
                                await updateLessonDirect(change.data.lessonId, moveData);
                            }
                            break;
                        case 'delete':
                            await deleteLesson(change.data.lessonId);
                            break;
                    }
                }
                
                pendingChanges = [];
                originalTimetableState = null;
                originalTimetableData = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                hideDragDropControls();
                
                // –û—á–∏—â–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                clearDropAvailability();
                
                showAlert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                await loadTimetable();
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: ' + error.message, 'error');
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        function openModal(lessonData = null, cellPosition = null) {
            
            if (!canEdit()) {
                showAlert('–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –≥—Ä—É–ø–ø—É, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è, –∞—É–¥–∏—Ç–æ—Ä–∏—é –∏–ª–∏ –ø—Ä–µ–¥–º–µ—Ç');
                return;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            let weekDay, lessonNumber;
            if (lessonData) {
                weekDay = lessonData.week_day;
                lessonNumber = lessonData.lesson_number;
            } else if (cellPosition) {
                weekDay = cellPosition.weekDay;
                lessonNumber = cellPosition.lessonNumber;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
            loadAvailableItemsForModal(weekDay, lessonNumber, lessonData?.id).then(() => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                showModal();
            });

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            function showModal() {
            const modal = document.getElementById('lessonModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('lessonForm');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            form.reset();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è
                ['subject', 'teacher'].forEach(field => {
                const input = document.getElementById(`${field}Field`);
                input.value = '';
                input.disabled = false;
                input.style.backgroundColor = 'white';
            });

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è
                document.getElementById('lessonType').value = '';
                document.getElementById('note').value = '';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—ã –∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
                clearSelectedGroups();
                clearSelectedRooms();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—è –Ω–æ–º–µ—Ä–∞ —É—Ä–æ–∫–∞ –∏ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
                document.getElementById('lessonNumber').disabled = false;
                document.getElementById('weekDay').disabled = false;
                document.getElementById('lessonNumber').style.backgroundColor = 'white';
                document.getElementById('weekDay').style.backgroundColor = 'white';

                if (lessonData && lessonData.id) {
                    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —É—Ä–æ–∫–∞
                    
                title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫';
                currentLessonId = lessonData.id;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –¥–∞–Ω–Ω—ã–º–∏ —É—Ä–æ–∫–∞
                    document.getElementById('subjectField').value = lessonData.subject?.name || '';
                    document.getElementById('teacherField').value = lessonData.teacher?.name || '';
                    document.getElementById('lessonType').value = lessonData.lesson_type || '';
                    document.getElementById('note').value = lessonData.note || '';
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∞—É–¥–∏—Ç–æ—Ä–∏–∏
                    if (lessonData.rooms && lessonData.rooms.length > 0) {
                        selectedRooms = lessonData.rooms.map(room => ({
                            id: room.id,
                            name: room.name
                        }));
                        updateSelectedRoomsDisplay();
                    }
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const lessonNumberField = document.getElementById('lessonNumber');
                    const weekDayField = document.getElementById('weekDay');
                    const hiddenLessonNumberField = document.getElementById('hiddenLessonNumber');
                    const hiddenWeekDayField = document.getElementById('hiddenWeekDay');
                    
                    if (lessonNumberField && weekDayField) {
                        // –î–ª—è select –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å value –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
                        lessonNumberField.value = String(lessonData.lesson_number || '');
                        weekDayField.value = String(lessonData.week_day ?? ''); // –ò—Å–ø–æ–ª—å–∑—É–µ–º ?? –¥–ª—è 0
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
                        if (hiddenLessonNumberField && hiddenWeekDayField) {
                            hiddenLessonNumberField.value = String(lessonData.lesson_number || '');
                            hiddenWeekDayField.value = String(lessonData.week_day ?? '');
                        }
                        
                    } else {
                        // –ü–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                    }
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –≥—Ä—É–ø–ø—ã
                    if (lessonData.groups && lessonData.groups.length > 0) {
                        selectedGroups = lessonData.groups.map(group => ({
                            id: group.id,
                            name: group.name
                        }));
                        updateSelectedGroupsDisplay();
                    }
                    
                    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    
                    // –î–µ–ª–∞–µ–º –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞ –∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–º–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                    document.getElementById('lessonNumber').disabled = true;
                    document.getElementById('weekDay').disabled = true;
                    document.getElementById('lessonNumber').style.backgroundColor = '#f8f9fa';
                    document.getElementById('weekDay').style.backgroundColor = '#f8f9fa';
                    
                    // –ü—Ä–µ–¥–º–µ—Ç –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞—é—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º–∏, –Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏
                            } else {
                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—Ä–æ–∫–∞



                    
                title.textContent = '–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫';
                currentLessonId = null;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±–æ—Ä–∞
                if (selectedValues.teacher.id) {
                    document.getElementById('teacherField').value = selectedValues.teacher.name;
                    document.getElementById('teacherField').disabled = true;
                    document.getElementById('teacherField').style.backgroundColor = '#f8f9fa';

                }
                
                if (selectedValues.room.id) {
                        // –î–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–π –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—É–¥–∏—Ç–æ—Ä–∏–π
                }

                if (selectedValues.subject.id) {
                    document.getElementById('subjectField').value = selectedValues.subject.name;
                    document.getElementById('subjectField').disabled = true;
                    document.getElementById('subjectField').style.backgroundColor = '#f8f9fa';

                    }
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –≥—Ä—É–ø–ø—ã –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø–ø–µ
                    if (selectedValues.group.id) {
                        // –ò—â–µ–º –≥—Ä—É–ø–ø—É –≤ –∫—ç—à–µ
                        const groupInCache = fullListsCache.group.find(g => g.id === selectedValues.group.id);
                        if (groupInCache) {
                            selectedGroups = [groupInCache];
                            updateSelectedGroupsDisplay();
    
                        }
                    }
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
                    if (selectedValues.room.id) {
                        // –ò—â–µ–º –∞—É–¥–∏—Ç–æ—Ä–∏—é –≤ –∫—ç—à–µ
                        const roomInCache = fullListsCache.room.find(r => r.id === selectedValues.room.id);
                        if (roomInCache) {
                            selectedRooms = [roomInCache];
                            updateSelectedRoomsDisplay();
    
                        }
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞ –∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–∏ —è—á–µ–π–∫–∏
                if (cellPosition) {
                        document.getElementById('lessonNumber').value = String(cellPosition.lessonNumber);
                        document.getElementById('weekDay').value = String(cellPosition.weekDay ?? '');
                        document.getElementById('hiddenLessonNumber').value = String(cellPosition.lessonNumber);
                        document.getElementById('hiddenWeekDay').value = String(cellPosition.weekDay ?? '');
                        
                        // –î–µ–ª–∞–µ–º –ø–æ–ª—è –Ω–æ–º–µ—Ä–∞ —É—Ä–æ–∫–∞ –∏ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–º–∏
                        document.getElementById('lessonNumber').disabled = true;
                        document.getElementById('weekDay').disabled = true;
                        document.getElementById('lessonNumber').style.backgroundColor = '#f8f9fa';
                        document.getElementById('weekDay').style.backgroundColor = '#f8f9fa';
                    }
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modal.style.display = 'block';
            }
        }

        function closeModal() {
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º currentLessonId –≤ DOM —ç–ª–µ–º–µ–Ω—Ç–µ —É—Ä–æ–∫–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (currentLessonId) {
                const lessonElement = document.querySelector(`[data-lesson-id="${currentLessonId}"]`);
                if (lessonElement) {
                    lessonElement.dataset.currentLessonId = currentLessonId;
                    
                } else {

                }
            }
            
            document.getElementById('lessonModal').style.display = 'none';
            currentLessonId = null;
            

        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞ –≤ DOM
        function updateLessonDataInDOM(lessonId, lessonData) {
            
            const lessonElement = document.querySelector(`[data-lesson-id="${lessonId}"]`);
            if (!lessonElement) {

                return;
            }
            
            const lessonIds = lessonElement.querySelector('.lesson-ids');
            if (lessonIds) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (lessonData.lesson_number !== undefined) {
                    lessonIds.dataset.lessonNumber = lessonData.lesson_number;

                }
                if (lessonData.week_day !== undefined) {
                    lessonIds.dataset.weekDay = lessonData.week_day;

                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–¥–º–µ—Ç–µ –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ
                if (lessonData.subject_id) {
                    lessonIds.dataset.subjectId = lessonData.subject_id;

                }
                if (lessonData.teacher_id) {
                    lessonIds.dataset.teacherId = lessonData.teacher_id;

                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∏–ø –∑–∞–Ω—è—Ç–∏—è –∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
                if (lessonData.lesson_type) {
                    lessonIds.dataset.lessonType = lessonData.lesson_type;

                }
                if (lessonData.note !== undefined) {
                    lessonIds.dataset.note = lessonData.note;

                }
                
    
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Ä–æ–∫–∞
                updateLessonDisplay(lessonElement, lessonData);
            } else {

            }
                }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Ä–æ–∫–∞
        function updateLessonDisplay(lessonElement, lessonData) {


            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
            const subjectDisplay = lessonElement.querySelector('.lesson-subject');
            if (subjectDisplay && lessonData.subject_name) {
                subjectDisplay.textContent = lessonData.subject_name;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
            const teacherDisplay = lessonElement.querySelector('.lesson-teacher');
            if (teacherDisplay && lessonData.teacher_name) {
                teacherDisplay.textContent = `üë®‚Äçüè´ ${lessonData.teacher_name}`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–Ω—è—Ç–∏—è
            const lessonTypeDisplay = lessonElement.querySelector('.lesson-type');
            if (lessonData.lesson_type) {
                const typeDisplay = getLessonTypeDisplay(lessonData.lesson_type);
                if (lessonTypeDisplay) {
                    lessonTypeDisplay.textContent = `üìö ${typeDisplay}`;
                } else {
                    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ç–∏–ø–∞ –∑–∞–Ω—è—Ç–∏—è –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    const newTypeElement = document.createElement('div');
                    newTypeElement.className = 'lesson-type';
                    newTypeElement.textContent = `üìö ${typeDisplay}`;
                    lessonElement.appendChild(newTypeElement);
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è
            const noteDisplay = lessonElement.querySelector('.lesson-note');
            if (lessonData.note) {
                if (noteDisplay) {
                    noteDisplay.textContent = `üìù ${lessonData.note}`;
                } else {
                    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    const newNoteElement = document.createElement('div');
                    newNoteElement.className = 'lesson-note';
                    newNoteElement.textContent = `üìù ${lessonData.note}`;
                    lessonElement.appendChild(newNoteElement);
                }
            } else if (noteDisplay) {
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –µ—Å–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –Ω–µ—Ç
                noteDisplay.remove();
            }
            
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —É—Ä–æ–∫–∞
        document.getElementById('lessonForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const lessonData = {};

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            let lessonNumber, weekDay;
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π
            lessonNumber = parseInt(formData.get('hiddenLessonNumber'));
            weekDay = parseInt(formData.get('hiddenWeekDay'));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            lessonData.lesson_number = lessonNumber;
            lessonData.week_day = weekDay;

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤—ã–±–æ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
            ['subject', 'teacher'].forEach(field => {
                const input = document.getElementById(`${field}Field`);
                const value = input.value.trim();
                
                if (!value) {
                    throw new Error(`${field === 'subject' ? '–ü—Ä–µ–¥–º–µ—Ç' : '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å'} –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω`);
                }
                
                // –ò—â–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫—ç—à–µ
                const cachedItem = fullListsCache[field].find(item => item.name === value);
                
                if (cachedItem) {
                    // –ó–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∫—ç—à–µ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º ID
                    lessonData[`${field}_id`] = cachedItem.id;
                    } else {
                        // –ó–Ω–∞—á–µ–Ω–∏–µ –≤–≤–µ–¥–µ–Ω–æ –≤—Ä—É—á–Ω—É—é - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ name
                        lessonData[`${field}_name`] = value;
                }
            });
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)
            if (selectedGroups.length > 0) {
                lessonData.group_ids = selectedGroups.map(group => group.id);
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)
            if (selectedRooms.length > 0) {
                lessonData.room_ids = selectedRooms.map(room => room.id);
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–∏–ø –∑–∞–Ω—è—Ç–∏—è
            const lessonType = formData.get('lessonType');
            if (lessonType) {
                lessonData.lesson_type = lessonType;
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
            const note = formData.get('note');
            if (note && note.trim()) {
                lessonData.note = note.trim();
            }

            try {
                if (currentLessonId) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —É—Ä–æ–∫–∞
                    await updateLesson(currentLessonId, lessonData);
                } else {
                    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—Ä–æ–∫–∞
                    await createLesson(lessonData);
                }
                
                closeModal();
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å pendingChanges, –æ—á–∏—â–∞–µ–º –∏—Ö –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                if (pendingChanges.length > 0) {
                    pendingChanges = [];
                    originalTimetableState = null;
                    originalTimetableData = null;
                    hideDragDropControls();
                    clearDropAvailability();
                }
                
                // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–Ω—ã–π —É—Ä–æ–∫, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –≤ DOM
                if (currentLessonId) {
                    updateLessonDataInDOM(currentLessonId, lessonData);
                    
                    // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π currentLessonId –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    const lessonElement = document.querySelector(`[data-lesson-id="${currentLessonId}"]`);
                    if (lessonElement && lessonElement.dataset.currentLessonId) {
                        delete lessonElement.dataset.currentLessonId;
                    }
                }
                
                loadTimetable(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            } catch (error) {

                showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Ä–æ–∫–∞: ' + error.message, 'error');
            }
        });

        // API —Ñ—É–Ω–∫—Ü–∏–∏
        async function createLesson(lessonData) {
            const branchId = selectedValues.branch.id;
            const calendarId = selectedValues.calendar.id;

            const requestData = {
                ...lessonData,
                branch_id: branchId,
                academic_calendar_id: calendarId
            };

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if (!requestData.lesson_type) {
                requestData.lesson_type = 'UNKNOWN';
            }
            if (!requestData.lesson_number) {
                throw new Error('–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
            }
            if (requestData.week_day === undefined || requestData.week_day === null) {
                throw new Error('–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
            }
            if (!requestData.subject_id && !requestData.subject_name) {
                throw new Error('–ü—Ä–µ–¥–º–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
            }
            if (!requestData.teacher_id && !requestData.teacher_name) {
                throw new Error('–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
            }


            const response = await fetch(TIMETABLES_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);
            }

            return await response.json();
        }

        async function updateLesson(lessonId, lessonData) {
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const currentLesson = getCurrentLessonData(lessonId);
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ç–æ–ª—å–∫–æ —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
            const updateData = createPartialUpdateData(lessonData, currentLesson);

            // –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            if (Object.keys(updateData).length === 0) {
                return;
            }


            const response = await fetch(`${TIMETABLES_API_URL}${lessonId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });


            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const result = await response.json();

            return result;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä—è–º–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Ä–æ–∫–∞ (–¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è)
        async function updateLessonDirect(lessonId, lessonData) {


            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            if (Object.keys(lessonData).length === 0) {

                return;
            }



            const response = await fetch(`${TIMETABLES_API_URL}${lessonId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(lessonData)
            });



            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const result = await response.json();
            return result;
        }

        async function deleteLesson(lessonId) {
            const response = await fetch(`${TIMETABLES_API_URL}${lessonId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);
            }

            return await response.json();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
        function addPendingChange(type, data) {

            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º originalTimetableData –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            if (!originalTimetableData && window.currentTimetableData) {
                originalTimetableData = JSON.parse(JSON.stringify(window.currentTimetableData));
            }
            
            const change = { type, data, timestamp: Date.now() };
            pendingChanges.push(change);

        }



        // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —É—Ä–æ–∫–∞
        function deleteLessonFromUI(lessonId) {
            showConfirmModal(
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —É—Ä–æ–∫?',
                async () => {
                    try {
                        await deleteLesson(lessonId);
                        loadTimetable();
                    } catch (error) {

                        showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—Ä–æ–∫–∞: ' + error.message, 'error');
                    }
                }
            );
        }

        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmBtn').onclick = () => {
                onConfirm();
                closeConfirmModal();
            };
            document.getElementById('confirmModal').style.display = 'block';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ branches
        async function loadBranches() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è branches
            if (loadingRequests.branch) {
                console.log('Branch request already loading');
                return;
            }
            
            loadingRequests.branch = true;
            
            try {
                document.getElementById('loadingBranches').style.display = 'block';
                
                const response = await fetch(`${BRANCHES_API_URL}?disable_pagination=true`);
                if (response.ok) {
                    const data = await response.json();
                    const branches = data.items || data;
                    fullListsCache.branch = branches;
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π branch –µ—Å–ª–∏ –µ—Å—Ç—å
                    const savedBranch = selectedValues.branch;
                    if (savedBranch && savedBranch.id) {
                        const branchInCache = branches.find(b => b.id === savedBranch.id);
                        if (branchInCache) {
                            const branchInput = document.getElementById('branchInput');
                            branchInput.value = getBranchDisplayName(branchInCache);
                            selectedValues.branch = {
                                id: branchInCache.id,
                                name: getBranchDisplayName(branchInCache)
                            };
                        }
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ branches:', error);
            } finally {
                document.getElementById('loadingBranches').style.display = 'none';
                loadingRequests.branch = false;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ branches
                loadSelectedValues();
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π branch, –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–∏
                if (selectedValues.branch.id) {
                    loadCalendarsForBranch();
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const savedLanguage = localStorage.getItem('timetableLanguage');
                if (savedLanguage) {
                    setTimeout(() => {
                        setLanguage(savedLanguage);
                    }, 100);
                } else {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    document.getElementById('langRu').classList.add('active');
                }
            }
            }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏ branch —Å —É—á–µ—Ç–æ–º —è–∑—ã–∫–∞
        function getBranchDisplayName(branch) {
            const currentLang = getCurrentLanguage();
            if (branch.name && typeof branch.name === 'object') {
                return branch.name[currentLang] || branch.name.ru || branch.name.en || branch.name.uz || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            }
            return branch.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞
        let currentLanguage = 'ru';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞
        function getCurrentLanguage() {
            return currentLanguage;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —è–∑—ã–∫–∞
        function setLanguage(lang) {
            currentLanguage = lang;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.language-selector .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const langButton = document.getElementById(`lang${lang.toUpperCase()}`);
            if (langButton) {
                langButton.classList.add('active');
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —è–∑—ã–∫ –≤ localStorage
            localStorage.setItem('timetableLanguage', lang);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            updateLanguageDisplay();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º —è–∑—ã–∫–∞
        function updateLanguageDisplay() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏, –∫—Ä–æ–º–µ –¥–∞—Ç –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
            document.querySelectorAll('[data-translate]').forEach(element => {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å –¥–∞—Ç–∞–º–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö —Ç–∞–±–ª–∏—Ü—ã
                if (element.id && element.id.endsWith('-date')) {
                    return;
                }
                const key = element.getAttribute('data-translate');
                element.textContent = t(key);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                element.placeholder = t(key);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –≤ —Å–µ–ª–µ–∫—Ç–∞—Ö
            document.querySelectorAll('option[data-translate]').forEach(option => {
                const key = option.getAttribute('data-translate');
                option.textContent = t(key);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö —Ç–∞–±–ª–∏—Ü—ã
            updateWeekDates();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ branches
            if (selectedValues.branch && selectedValues.branch.id) {
                const branchInput = document.getElementById('branchInput');
                if (branchInput) {
                    const branchInCache = fullListsCache.branch.find(b => b.id === selectedValues.branch.id);
                    if (branchInCache) {
                        branchInput.value = getBranchDisplayName(branchInCache);
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            Object.keys(selectedValues).forEach(type => {
                if (type !== 'branch' && selectedValues[type] && selectedValues[type].id) {
                    const input = document.getElementById(type + 'Input');
                    if (input) {
                        const langKey = `name_${currentLanguage}`;
                        if (selectedValues[type][langKey]) {
                            input.value = selectedValues[type][langKey];
                        }
                    }
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–º–ø–æ—Ä—Ç–∞
        async function loadCalendarsForImport() {
            console.log('loadCalendarsForImport called');
            const branchSelect = document.getElementById('importBranchSelect');
            const calendarSelect = document.getElementById('importCalendarSelect');
            
            console.log('Branch select value:', branchSelect.value);
            
            if (!branchSelect.value) {
                console.log('No branch selected, disabling calendar select');
                calendarSelect.innerHTML = '<option value="" data-translate="select_branch_first">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª...</option>';
                calendarSelect.disabled = true;
                checkImportReady();
                return;
            }
            
            try {
                calendarSelect.disabled = true;
                calendarSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π...</option>';
                
                console.log('Fetching calendars for branch:', branchSelect.value);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ branch
                const response = await fetch(`${ACADEMIC_CALENDARS_API_URL}?branch_id=${branchSelect.value}&disable_pagination=true`);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    const calendars = data.items || data;
                    
                    console.log('Calendars loaded:', calendars.length);
                    
                    calendarSelect.innerHTML = '<option value="" data-translate="select_calendar">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å...</option>';
                    
                    calendars.forEach(calendar => {
                        const option = document.createElement('option');
                        option.value = calendar.id;
                        option.textContent = `${calendar.academic_year} | –°–µ–º–µ—Å—Ç—Ä ${calendar.semester}`;
                        calendarSelect.appendChild(option);
                    });
                    
                    calendarSelect.disabled = false;
                    console.log('Calendar select enabled');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                    calendarSelect.addEventListener('change', function() {
                        console.log('Calendar selection changed:', this.value);
                        checkImportReady();
                    });
                } else {
                    console.error('Failed to load calendars, status:', response.status);
                    calendarSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π</option>';
                }
                
                checkImportReady();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:', error);
                calendarSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π</option>';
                checkImportReady();
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ branch
        async function loadCalendarsForBranch(branchId = null) {
            if (!branchId && !selectedValues.branch.id) {
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
            if (loadingRequests.calendar) {
                console.log('Calendar request already loading');
                return;
            }
            
            loadingRequests.calendar = true;
            
            const targetBranchId = branchId || selectedValues.branch.id;
            
            try {
                document.getElementById('loadingCalendars').style.display = 'block';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ branch
                const response = await fetch(`${ACADEMIC_CALENDARS_API_URL}?branch_id=${targetBranchId}&disable_pagination=true`);
                if (response.ok) {
                    const data = await response.json();
                    const calendars = data.items || data;
                    fullListsCache.calendar = calendars;
                    
                    console.log('Calendars loaded for branch:', targetBranchId, 'Count:', calendars.length);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
                    fullListsCache.calendar = calendars;
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ —Å–º–µ–Ω–µ branch
                    const calendarInput = document.getElementById('calendarInput');
                    calendarInput.value = '';
                    calendarInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å...';
                    calendarInput.removeAttribute('readonly');
                    calendarInput.classList.remove('current');
                    
                    // –û—á–∏—â–∞–µ–º selectedValues –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                    selectedValues.calendar = null;
                    saveSelectedValues();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                    const calendarDropdown = document.getElementById('calendarDropdown');
                    if (calendarDropdown && calendarDropdown.style.display === 'block') {
                        displayDropdownResults(calendarDropdown, calendars, 'calendar');
                    }
                    
                    // –ï—Å–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ placeholder
                    if (calendars.length === 0) {
                        const calendarInput = document.getElementById('calendarInput');
                        calendarInput.placeholder = '–ù–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞';
                    }
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è —ç—Ç–æ–≥–æ branch —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–∏
                    if (calendars.length > 0) {
                        try {
                            const currentResponse = await fetch(`${ACADEMIC_CALENDARS_API_URL}${targetBranchId}/current`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            if (currentResponse.ok) {
                                const currentCalendar = await currentResponse.json();
                                
                                // –ò—â–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤ —Å–ø–∏—Å–∫–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –ø–æ academic_year –∏ semester
                                const matchingCalendar = calendars.find(cal => 
                                    cal.academic_year === currentCalendar.academic_year && 
                                    cal.semester === currentCalendar.semester
                                );
                                
                                if (matchingCalendar) {
                                    const displayName = `${matchingCalendar.academic_year} | ${t('semester')} ${matchingCalendar.semester}`;
                                    
                                    const calendarInput = document.getElementById('calendarInput');
                                    calendarInput.value = displayName;
                                    calendarInput.classList.add('current');
                                    calendarInput.placeholder = '–¢–µ–∫—É—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å';
                                    calendarInput.removeAttribute('readonly');
                                    
                                    selectedValues.calendar = { 
                                        id: matchingCalendar.id, // –ò—Å–ø–æ–ª—å–∑—É–µ–º UUID –∏–∑ —Å–ø–∏—Å–∫–∞
                                        name: displayName 
                                    };
                                    
                                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                                    saveSelectedValues();
                                    
                                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–µ–π –ø–æ—Å–ª–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                                    updateFieldStates();
                                } else {
                                    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–µ –ø—É—Å—Ç—ã–º
                                    const calendarInput = document.getElementById('calendarInput');
                                    calendarInput.value = '';
                                    calendarInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å...';
                                    calendarInput.removeAttribute('readonly');
                                    calendarInput.classList.remove('current');
                                }
                            } else {
                                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–µ –ø—É—Å—Ç—ã–º
                                const calendarInput = document.getElementById('calendarInput');
                                calendarInput.value = '';
                                calendarInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å...';
                                calendarInput.removeAttribute('readonly');
                                calendarInput.classList.remove('current');
                            }
                        } catch (currentError) {
                            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–µ –ø—É—Å—Ç—ã–º
                            const calendarInput = document.getElementById('calendarInput');
                            calendarInput.value = '';
                            calendarInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å...';
                            calendarInput.removeAttribute('readonly');
                            calendarInput.classList.remove('current');
                        }
                    } else {
                        // –ï—Å–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –Ω–µ—Ç, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–µ –ø—É—Å—Ç—ã–º
                        console.log('No calendars found for branch:', targetBranchId);
                        const calendarInput = document.getElementById('calendarInput');
                        calendarInput.value = '';
                        calendarInput.placeholder = '–ù–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞';
                        calendarInput.removeAttribute('readonly');
                        calendarInput.classList.remove('current');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                        const calendarDropdown = document.getElementById('calendarDropdown');
                        if (calendarDropdown && calendarDropdown.style.display === 'block') {
                            displayDropdownResults(calendarDropdown, [], 'calendar');
                        }
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π:', error);
                document.getElementById('calendarInput').placeholder = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π';
                document.getElementById('calendarInput').removeAttribute('readonly');
            } finally {
                document.getElementById('loadingCalendars').style.display = 'none';
                loadingRequests.calendar = false;
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã, branch –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                if (selectedValues.branch.id && selectedValues.calendar && selectedValues.calendar.id && (selectedValues.group.id || selectedValues.teacher.id || selectedValues.room.id || selectedValues.subject.id)) {
                    loadTimetable();
                }
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—è
        function setupAutocomplete(inputId, dropdownId, loadingId, type) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const loading = document.getElementById(loadingId);

            input.addEventListener('input', function() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω–æ –ª–∏ –ø–æ–ª–µ
                if (this.hasAttribute('readonly')) {
                    return;
                }
                
                // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (group, teacher, room, subject) –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ branch –ò calendar
                if (type === 'group' || type === 'teacher' || type === 'room' || type === 'subject') {
                    if (!selectedValues.branch || !selectedValues.branch.id) {
                        return;
                    }
                    if (!selectedValues.calendar || !selectedValues.calendar.id) {
                        return;
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
                if (loadingRequests[type]) {
                    console.log('Request already loading for type:', type);
                    return;
                }
                
                const query = this.value.trim();
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
                if (searchTimeouts[type]) {
                    clearTimeout(searchTimeouts[type]);
                }

                // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ –∫—ç—à–∞
                if (!query) {
                    if (type === 'calendar') {
                        // –î–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                        if (fullListsCache[type] && fullListsCache[type].length > 0) {
                            displayDropdownResults(dropdown, fullListsCache[type], type);
                        } else {
                            // –ï—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç –∏–ª–∏ –Ω–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
                            displayDropdownResults(dropdown, [], type);
                        }
                    } else if (type === 'branch') {
                        // –î–ª—è branch –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—ç—à –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (fullListsCache[type] && fullListsCache[type].length > 0) {
                            displayDropdownResults(dropdown, fullListsCache[type], type);
                        } else {
                            loadBranches();
                        }
                    } else if (type === 'calendar') {
                        // –î–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –µ—Å–ª–∏ –Ω–µ—Ç branch
                        if (selectedValues.branch && selectedValues.branch.id) {
                            loadCalendarsForBranch();
                        } else {
                            displayDropdownResults(dropdown, [], type);
                        }
                                            } else {
                            // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (group, teacher, room, subject) –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π
                            if (selectedValues.branch && selectedValues.branch.id && selectedValues.calendar && selectedValues.calendar.id) {
                                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç–æ–π
                                if (!fullListsCache[type] || fullListsCache[type].length === 0) {
                                    loadAllObjects(type, dropdown, loading);
                                } else {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                                    displayDropdownResults(dropdown, fullListsCache[type], type);
                                }
                            } else {
                                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º dropdown –∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
                                hideDropdown(dropdown);
                            }
                        }
                    // –ù–µ –æ—á–∏—â–∞–µ–º selectedValues —Å—Ä–∞–∑—É, —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
                    return;
                }

                // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–∏—Å–∫–∞ 300ms
                searchTimeouts[type] = setTimeout(() => {
                    if (type === 'calendar') {
                        searchCalendars(query, dropdown, loading);
                    } else if (type === 'branch') {
                        searchBranches(query, dropdown, loading);
                    } else {
                        searchObjects(type, query, dropdown, loading);
                    }
                }, 300);
            });

            input.addEventListener('focus', function() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω–æ –ª–∏ –ø–æ–ª–µ
                if (this.hasAttribute('readonly')) {
                    console.log('Field is disabled (focus):', type);
                    return;
                }
                
                // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (group, teacher, room, subject) –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ branch –ò calendar
                if (type === 'group' || type === 'teacher' || type === 'room' || type === 'subject') {
                    if (!selectedValues.branch || !selectedValues.branch.id) {
                        console.log('Branch not selected for filter (focus):', type);
                        return;
                    }
                    if (!selectedValues.calendar || !selectedValues.calendar.id) {
                        console.log('Calendar not selected for filter (focus):', type);
                        return;
                    }
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ dropdown –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –Ω–æ–≤–æ–µ –ø–æ–ª–µ
                hideOtherDropdowns(dropdownId);
                activeInput = inputId;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—ç—à —É–∂–µ –µ—Å—Ç—å
                setTimeout(() => {
                    if (type === 'calendar') {
                        // –î–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                        if (fullListsCache[type] && fullListsCache[type].length > 0) {
                            displayDropdownResults(dropdown, fullListsCache[type], type);
                        } else {
                            // –ï—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç –∏–ª–∏ –Ω–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
                            displayDropdownResults(dropdown, [], type);
                        }
                    } else if (type === 'branch') {
                        // –î–ª—è branch –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—ç—à –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (fullListsCache[type] && fullListsCache[type].length > 0) {
                            displayDropdownResults(dropdown, fullListsCache[type], type);
                        } else {
                            hideDropdown(dropdown);
                        }
                    } else {
                        // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (group, teacher, room, subject) –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—ç—à –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
                        // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ
                        hideDropdown(dropdown);
                    }
                }, 100);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª–µ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
            input.addEventListener('click', function() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω–æ –ª–∏ –ø–æ–ª–µ
                if (this.hasAttribute('readonly')) {
                    console.log('Field is disabled:', type);
                    return;
                }
                
                // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (group, teacher, room, subject) –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ branch –ò calendar
                if (type === 'group' || type === 'teacher' || type === 'room' || type === 'subject') {
                    if (!selectedValues.branch || !selectedValues.branch.id) {
                        console.log('Branch not selected for filter:', type);
                        return;
                    }
                    if (!selectedValues.calendar || !selectedValues.calendar.id) {
                        console.log('Calendar not selected for filter:', type);
                        return;
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
                if (loadingRequests[type]) {
                    console.log('Request already loading for type:', type);
                    return;
                }
                
                console.log('Calendar input clicked, type:', type);
                console.log('fullListsCache[type]:', fullListsCache[type]);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –Ω–æ–≤–æ–µ –ø–æ–ª–µ
                hideOtherDropdowns(dropdownId);
                activeInput = inputId;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ
                setTimeout(() => {
                    console.log('Showing dropdown for type:', type);
                    if (type === 'calendar') {
                        // –î–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                        if (fullListsCache[type] && fullListsCache[type].length > 0) {
                            displayDropdownResults(dropdown, fullListsCache[type], type);
                        } else {
                            // –ï—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç –∏–ª–∏ –Ω–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
                            displayDropdownResults(dropdown, [], type);
                        }
                    } else if (type === 'branch') {
                        // –î–ª—è branch –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                        loadBranches();
                    } else if (type === 'calendar') {
                        // –î–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –µ—Å–ª–∏ –Ω–µ—Ç branch
                        if (selectedValues.branch && selectedValues.branch.id) {
                            loadCalendarsForBranch();
                        } else {
                            displayDropdownResults(dropdown, [], type);
                        }
                                            } else {
                            // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (group, teacher, room, subject) –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π
                            if (selectedValues.branch && selectedValues.branch.id && selectedValues.calendar && selectedValues.calendar.id) {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å
                                if (!loadingRequests[type]) {
                                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç–æ–π
                                    if (!fullListsCache[type] || fullListsCache[type].length === 0) {
                                        loadAllObjects(type, dropdown, loading);
                                    } else {
                                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                                        displayDropdownResults(dropdown, fullListsCache[type], type);
                                    }
                                }
                            } else {
                                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º dropdown –∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
                                hideDropdown(dropdown);
                            }
                        }
                }, 200); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –¥—Ä—É–≥–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
            input.addEventListener('focus', function() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω–æ –ª–∏ –ø–æ–ª–µ
                if (this.hasAttribute('readonly')) {
                    console.log('Field is disabled (focus):', type);
                    return;
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ dropdown –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –ª—é–±–æ–º –ø–æ–ª–µ
                const allInputs = ['branchInput', 'calendarInput', 'groupInput', 'teacherInput', 'roomInput', 'subjectInput'];
                allInputs.forEach(inputId => {
                    if (inputId !== this.id) {
                        const otherDropdownId = inputId.replace('Input', 'Dropdown');
                        const otherDropdown = document.getElementById(otherDropdownId);
                        if (otherDropdown) {
                            hideDropdown(otherDropdown);
                        }
                    }
                });
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ - –ù–ï –æ—á–∏—â–∞–µ–º selectedValues —Å—Ä–∞–∑—É
            input.addEventListener('blur', function() {
                // –ù–µ –¥–µ–ª–∞–µ–º –Ω–∏—á–µ–≥–æ - –ø—É—Å—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ —Ä–µ—à–∞–µ—Ç
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function setupModalAutocomplete(inputId, dropdownId, type) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            input.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                filterModalDropdown(dropdown, fullListsCache[type], query, type);
            });

            input.addEventListener('focus', function() {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ dropdown –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –Ω–æ–≤–æ–º –ø–æ–ª–µ
                hideOtherDropdowns(dropdownId);
                activeInput = inputId;
                
                // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                setTimeout(() => {
                    if (fullListsCache[type].length > 0) {
                        displayModalDropdownResults(dropdown, fullListsCache[type], type);
                    } else {
                        // –ï—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                        loadAllObjects(type, dropdown, null);
                    }
                }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
            });
        }

        function filterModalDropdown(dropdown, items, query, type) {
            dropdown.innerHTML = '';
            
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(query)
            );
            
            displayModalDropdownResults(dropdown, filteredItems, type);
        }

        function displayModalDropdownResults(dropdown, items, type) {
            dropdown.innerHTML = '';

            if (items.length === 0) {
                dropdown.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            } else {
                items.forEach(item => {
                    const option = document.createElement('div');
                    option.className = 'autocomplete-item';
                    option.textContent = item.name;
                    option.dataset.itemId = item.id;
                    option.dataset.itemName = item.name;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
                    if (type === 'teacher' && item.hasOwnProperty('is_available') && !item.is_available) {
                        option.classList.add('unavailable');
                        option.textContent += ' (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)';
                        option.title = '–≠—Ç–æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è';
                    }
                    
                                    option.addEventListener('click', () => selectModalItem(type, item));
                dropdown.appendChild(option);
            });
        }

        showDropdown(dropdown);
        }

                function selectModalItem(type, item) {
            const inputId = type === 'teacher' ? 'teacherField' : type === 'room' ? 'roomField' : 'subjectField';
            const dropdownId = type === 'teacher' ? 'modalTeacherDropdown' : type === 'room' ? 'modalRoomDropdown' : 'modalSubjectDropdown';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
            if (type === 'teacher' && item.hasOwnProperty('is_available') && !item.is_available) {
                showAlert('–≠—Ç–æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è', 'warning');
                return;
            }
            
            document.getElementById(inputId).value = item.name;
            hideDropdown(document.getElementById(dropdownId));
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ dropdown
            hideOtherDropdowns();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        async function loadAllObjects(type, dropdown, loading) {
            console.log('loadAllObjects called for type:', type);
            console.log('selectedValues.branch:', selectedValues.branch);
            console.log('selectedValues.calendar:', selectedValues.calendar);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
            if (loadingRequests[type]) {
                console.log('Request already loading for type:', type);
                return;
            }
            

            
            loadingRequests[type] = true;
            
            try {
                loading.style.display = 'block';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º dropdown —Å "searching" —Å—Ä–∞–∑—É
                dropdown.innerHTML = '<div class="no-results">–ü–æ–∏—Å–∫...</div>';
                showDropdown(dropdown);
                
                let apiUrl;
                switch(type) {
                    case 'group':
                        apiUrl = GROUPS_API_URL;
                        break;
                    case 'teacher':
                        apiUrl = TEACHERS_API_URL;
                        break;
                    case 'room':
                        apiUrl = ROOMS_API_URL;
                        break;
                    case 'subject':
                        apiUrl = SUBJECTS_API_URL;
                        break;
                    default:
                        throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø: ${type}`);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º branch_id –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω branch
                const params = new URLSearchParams();
                params.append('disable_pagination', 'true');
                
                // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (group, teacher, room, subject) –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–µ–Ω branch –ò calendar
                if (type === 'group' || type === 'teacher' || type === 'room' || type === 'subject') {
                    if (!selectedValues.branch || !selectedValues.branch.id) {
                        // –ï—Å–ª–∏ –Ω–µ—Ç branch, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
                        displayDropdownResults(dropdown, [], type);
                        return;
                    }
                    if (!selectedValues.calendar || !selectedValues.calendar.id) {
                        // –ï—Å–ª–∏ –Ω–µ—Ç calendar, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
                        displayDropdownResults(dropdown, [], type);
                        return;
                    }
                    params.append('branch_id', selectedValues.branch.id);
                } else if (selectedValues.branch && selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                console.log(`Making API request for ${type}:`, `${apiUrl}?${params.toString()}`);
                const response = await fetch(`${apiUrl}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
                }

                const data = await response.json();
                const objects = data.items || data;
                // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –∑–∞–Ω–æ–≤–æ
                displayDropdownResults(dropdown, objects, type);

            } catch (error) {
                dropdown.innerHTML = '<div class="no-results">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                showDropdown(dropdown);
            } finally {
                loading.style.display = 'none';
                loadingRequests[type] = false;
                console.log(`Request completed for type: ${type}`);
            }
        }

        // –ü–æ–∏—Å–∫ branches
        async function searchBranches(query, dropdown, loading) {
            try {
                loading.style.display = 'block';
                
                const response = await fetch(`${BRANCHES_API_URL}?disable_pagination=true&search=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
                }

                const data = await response.json();
                const branches = data.items || data;
                displayDropdownResults(dropdown, branches, 'branch');

            } catch (error) {
                dropdown.innerHTML = '<div class="no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
                dropdown.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // –ü–æ–∏—Å–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
        async function searchCalendars(query, dropdown, loading) {
            try {
                loading.style.display = 'block';
                
                // –î–æ–±–∞–≤–ª—è–µ–º branch_id –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω branch
                const params = new URLSearchParams();
                params.append('disable_pagination', 'true');
                params.append('search', query);
                
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                const response = await fetch(`${ACADEMIC_CALENDARS_API_URL}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
                }

                const data = await response.json();
                const calendars = data.items || data;
                displayDropdownResults(dropdown, calendars, 'calendar');

            } catch (error) {
                dropdown.innerHTML = '<div class="no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
                dropdown.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤
        async function searchObjects(type, query, dropdown, loading) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
            if (loadingRequests[type]) {
                console.log('Request already loading for type:', type);
                return;
            }
            
            loadingRequests[type] = true;
            
            try {
                loading.style.display = 'block';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º dropdown —Å "searching" —Å—Ä–∞–∑—É
                dropdown.innerHTML = '<div class="no-results">–ü–æ–∏—Å–∫...</div>';
                showDropdown(dropdown);
                
                let apiUrl;
                switch(type) {
                    case 'group':
                        apiUrl = GROUPS_API_URL;
                        break;
                    case 'teacher':
                        apiUrl = TEACHERS_API_URL;
                        break;
                    case 'room':
                        apiUrl = ROOMS_API_URL;
                        break;
                    case 'subject':
                        apiUrl = SUBJECTS_API_URL;
                        break;
                    default:
                        throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø: ${type}`);
                }
                
                const params = new URLSearchParams();
                params.append('search', query);
                
                // –î–æ–±–∞–≤–ª—è–µ–º branch_id –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω branch
                if (selectedValues.branch.id) {
                    params.append('branch_id', selectedValues.branch.id);
                }
                
                const response = await fetch(`${apiUrl}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
                }

                const data = await response.json();
                const objects = data.items || data;
                // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –¥–ª—è –ø–æ–∏—Å–∫–∞
                displayDropdownResults(dropdown, objects, type);

            } catch (error) {
                dropdown.innerHTML = '<div class="no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
                showDropdown(dropdown);
            } finally {
                loading.style.display = 'none';
                loadingRequests[type] = false;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ dropdown
        function displayDropdownResults(dropdown, objects, type) {
            console.log('displayDropdownResults called with:', { type, objectsLength: objects.length });
            
            dropdown.innerHTML = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º dropdown –ø–ª–∞–≤–Ω–æ
            showDropdown(dropdown);
            
            // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" (–∫—Ä–æ–º–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π)
            if (objects.length === 0 && type !== 'calendar') {
                dropdown.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }

            if (type === 'calendar') {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
                const createItem = document.createElement('div');
                createItem.className = 'autocomplete-item create-calendar-item';
                createItem.innerHTML = `
                    <div class="calendar-item d-flex align-items-center justify-content-between" style="background-color: #e8f5e8; border-left: 3px solid #28a745;">
                        <div class="calendar-info" onclick="openCreateCalendarModal()">
                            <span style="color: #28a745; font-weight: bold;">‚ûï ${t('create_new_calendar')}</span>
                        </div>
                    </div>
                `;
                dropdown.appendChild(createItem);
                
                if (objects.length > 0) {
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–∏
                    const divider = document.createElement('div');
                    divider.className = 'dropdown-divider';
                    divider.style.height = '1px';
                    divider.style.backgroundColor = '#dee2e6';
                    divider.style.margin = '8px 0';
                    dropdown.appendChild(divider);
                }
                
                // –ï—Å–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–∏ –ø—É—Å—Ç—ã–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (objects.length === 0) {
                    dropdown.innerHTML += '<div class="no-results">–ù–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å" –≤—ã—à–µ.</div>';
                }
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if (objects.length > 0) {
                objects.forEach(obj => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    
                    if (type === 'calendar') {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                        const currentDate = new Date();
                        const startDate = new Date(obj.start_date);
                        const endDate = new Date(obj.end_date);
                        const isCurrent = currentDate >= startDate && currentDate <= endDate;
                        
                        if (isCurrent) {
                            item.classList.add('calendar-current');
                        }
                        
                        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
                        const formatDate = (dateString) => {
                            const date = new Date(dateString);
                            return date.toLocaleDateString('ru-RU');
                        };
                        
                        // –î–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "academic_year --- —Å–µ–º–µ—Å—Ç—Ä" —Å –¥–∞—Ç–∞–º–∏ –∏ –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π
                        item.innerHTML = `
                            <div class="calendar-item d-flex align-items-center justify-content-between">
                                <div class="calendar-info" data-calendar-id="${obj.id}" data-calendar-name="${obj.academic_year} --- ${t('semester')} ${obj.semester}" data-academic-year="${obj.academic_year}" data-semester="${obj.semester}">
                                    <div class="calendar-main">
                                        <span class="calendar-year">${obj.academic_year}</span>
                                        <span class="calendar-semester">${t('semester')} ${obj.semester}</span>
                                    </div>
                                    <div class="calendar-dates">
                                        <small class="text-muted">
                                            ${formatDate(obj.start_date)} - ${formatDate(obj.end_date)}
                                        </small>
                                    </div>
                                </div>
                                <div class="calendar-actions">
                                    <button class="btn btn-sm btn-outline-warning" onclick="editCalendar('${obj.id}', event)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å">
                                        ‚úèÔ∏è
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                        const calendarInfo = item.querySelector('.calendar-info');
                        calendarInfo.addEventListener('click', function() {
                            const calendarId = this.getAttribute('data-calendar-id');
                            const calendarName = this.getAttribute('data-calendar-name');
                            const academicYear = this.getAttribute('data-academic-year');
                            const semester = this.getAttribute('data-semester');
                            
                            selectItem(type, {
                                id: calendarId, // –ò—Å–ø–æ–ª—å–∑—É–µ–º UUID –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
                                name: calendarName,
                                academic_year: academicYear,
                                semester: parseInt(semester)
                            });
                        });
                    } else if (type === 'branch') {
                        // –î–ª—è branches –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                        item.textContent = getBranchDisplayName(obj);
                        item.addEventListener('click', () => selectItem(type, obj));
                    } else {
                        item.textContent = obj.name;
                        item.addEventListener('click', () => selectItem(type, obj));
                    }
                    
                    dropdown.appendChild(item);
                });
            }

            dropdown.style.display = 'block';
            console.log('Dropdown displayed for type:', type, 'with', objects.length, 'items');
        }

        // –í—ã–±–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞
        function selectItem(type, obj) {
            console.log('selectItem called with:', type, obj);
            
            const inputId = type + 'Input';
            const dropdownId = type + 'Dropdown';
            
            if (type === 'branch') {
                document.getElementById(inputId).value = getBranchDisplayName(obj);
                document.getElementById(dropdownId).style.display = 'none';
                
                selectedValues[type] = { 
                    id: obj.id, 
                    name: getBranchDisplayName(obj),
                    name_ru: obj.name?.ru || obj.name,
                    name_en: obj.name?.en || obj.name,
                    name_uz: obj.name?.uz || obj.name
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                saveSelectedValues();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ branch
                loadCalendarsForBranch(obj.id);
                
                // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –ø—Ä–∏ —Å–º–µ–Ω–µ branch
                clearField('calendar');
                clearField('group');
                clearField('teacher');
                clearField('room');
                clearField('subject');
                
                // –û—á–∏—â–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ branch
                renderTimetable({ days: [] });
                
                // –û—á–∏—â–∞–µ–º –∫—ç—à –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ branch
                fullListsCache.group = [];
                fullListsCache.teacher = [];
                fullListsCache.room = [];
                fullListsCache.subject = [];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–µ–π
                updateFieldStates();
                
            } else {
                document.getElementById(inputId).value = obj.name;
                document.getElementById(dropdownId).style.display = 'none';
                
                selectedValues[type] = { 
                    id: obj.id, 
                    name: obj.name,
                    name_ru: obj.name?.ru || obj.name,
                    name_en: obj.name?.en || obj.name,
                    name_uz: obj.name?.uz || obj.name
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                saveSelectedValues();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–µ–π
                updateFieldStates();
                


                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (group, teacher, room, subject)
                if (type === 'group' || type === 'teacher' || type === 'room' || type === 'subject') {
                    // –û—á–∏—â–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–æ–ª—è (–∫—Ä–æ–º–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ branch)
                    if (type === 'group') {
                        clearField('teacher');
                        clearField('room');
                        clearField('subject');
                    } else if (type === 'teacher') {
                        clearField('group');
                        clearField('room');
                        clearField('subject');
                    } else if (type === 'room') {
                        clearField('group');
                        clearField('teacher');
                        clearField('subject');
                    } else if (type === 'subject') {
                        clearField('group');
                        clearField('teacher');
                        clearField('room');
                    }
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                    if (selectedValues.calendar && selectedValues.calendar.id) {
                        setTimeout(() => {
                            loadTimetable();
                        }, 100);
                    }
                }
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è
        function clearField(type) {
            document.getElementById(type + 'Input').value = '';
            selectedValues[type] = { id: '', name: '' };
            saveSelectedValues();
            updateFieldStates();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function revertChanges() {
            if (originalTimetableData && pendingChanges.length > 0) {
                renderTimetable(originalTimetableData);
                pendingChanges = [];
                originalTimetableState = null;
                originalTimetableData = null;
            }
        }

        async function loadTimetable() {
            const branchId = selectedValues.branch.id;
            const calendarId = selectedValues.calendar?.id;
            const groupId = selectedValues.group?.id;
            const teacherId = selectedValues.teacher?.id;
            const roomId = selectedValues.room?.id;
            const subjectId = selectedValues.subject?.id;

            console.log('loadTimetable called with:', {
                branchId, calendarId, groupId, teacherId, roomId, subjectId
            });
            console.log('Calendar ID type:', typeof calendarId, 'Value:', calendarId);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ branch –≤—ã–±—Ä–∞–Ω
            if (!branchId) {
                console.log('No branch selected');
                showInfo();
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤—ã–±—Ä–∞–Ω
            if (!calendarId) {
                console.log('No calendar selected');
                showInfo();
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∏–ª—å—Ç—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω
            if (!groupId && !teacherId && !roomId && !subjectId) {
                console.log('No filters selected');
                hideInfo();
                renderTimetable({ days: [] });
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            showLoading(true);
            hideError();
            hideInfo();

            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è URL
                const params = new URLSearchParams();
                params.append('academic_calendar_id', calendarId); // –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–µ–º calendar ID
                if (groupId) params.append('group_id', groupId);
                if (teacherId) params.append('teacher_id', teacherId);
                if (roomId) params.append('room_id', roomId);
                if (subjectId) params.append('subject_id', subjectId);

                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                const url = `${TIMETABLES_API_URL}?${params.toString()}`;

                console.log('Fetching timetable from:', url);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET –∑–∞–ø—Ä–æ—Å
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Timetable data received:', data);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º originalTimetableData –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
                originalTimetableData = null;
                renderTimetable(data);

            } catch (error) {
                console.error('Error loading timetable:', error);
                showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function renderTimetable(data) {
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
            window.currentTimetableData = data;
            const tbody = document.getElementById('timetable-body');
            tbody.innerHTML = '';

            // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ —É—Ä–æ–∫–æ–≤
            const lessonsMap = {};
            
            if (data.days) {
                data.days.forEach(day => {
                    if (day.lessons) {
                        day.lessons.forEach(lesson => {
                            const key = `${day.week_day}-${lesson.lesson_number}`;
                            lessonsMap[key] = lesson;
                        });
                    }
                });
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            periods.forEach(period => {
                const row = document.createElement('tr');
                
                // –Ø—á–µ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
                const timeCell = document.createElement('td');
                timeCell.className = 'day-cell';
                timeCell.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 2px;">${period.period}</div>
                    <div style="font-size: 10px;">${period.starttime}</div>
                    <div style="font-size: 10px;">${period.endtime}</div>
                `;
                row.appendChild(timeCell);

                // –Ø—á–µ–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-—Å—É–±–±–æ—Ç–∞)
                weekDays.forEach(day => {
                    const cell = document.createElement('td');
                    cell.className = 'lesson-cell';
                    
                    const key = `${day.id}-${period.period}`;
                    const lesson = lessonsMap[key];
                    
                    if (lesson) {
                        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        let groupsDisplay = '';
                        if (lesson.groups && lesson.groups.length > 0) {
                            groupsDisplay = lesson.groups.map(group => group.name).join(', ');
                        }
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∞—É–¥–∏—Ç–æ—Ä–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        let roomsDisplay = '';
                        if (lesson.rooms && lesson.rooms.length > 0) {
                            roomsDisplay = lesson.rooms.map(room => room.name).join(', ');
                        }
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ null
                        const subjectDisplay = lesson.subject?.name || '–ü—Ä–µ–¥–º–µ—Ç –Ω–µ —É–∫–∞–∑–∞–Ω';
                        const teacherDisplay = lesson.teacher?.name || '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω';
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–Ω—è—Ç–∏—è
                        const lessonTypeDisplay = lesson.lesson_type && lesson.lesson_type !== 'UNKNOWN' 
                            ? getLessonTypeDisplay(lesson.lesson_type) 
                            : '';
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è
                        const noteDisplay = lesson.note ? `<div class="lesson-note">üìù ${lesson.note}</div>` : '';
                        
                        cell.innerHTML = `
                            <div class="lesson" data-lesson-id="${lesson.id}">
                                <button class="delete-btn" onclick="deleteLessonFromUI('${lesson.id}')" title="–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–∫">√ó</button>
                                <div class="lesson-subject">${subjectDisplay}</div>
                                <div class="lesson-teacher">üë®‚Äçüè´ ${teacherDisplay}</div>
                                ${lessonTypeDisplay ? `<div class="lesson-type">üìö ${lessonTypeDisplay}</div>` : ''}
                                <div class="lesson-room">üè¢ ${roomsDisplay}</div>
                                <div class="lesson-groups">üë• ${groupsDisplay}</div>
                                ${noteDisplay}
                                <div class="lesson-ids" style="display: none;" 
                                     data-subject-id="${lesson.subject?.id || ''}" 
                                     data-teacher-id="${lesson.teacher?.id || ''}" 
                                     data-rooms='${JSON.stringify(lesson.rooms || [])}'
                                     data-groups='${JSON.stringify(lesson.groups || [])}'
                                     data-week-day="${day.id}"
                                     data-lesson-number="${period.period}"
                                     data-lesson-type="${lesson.lesson_type || ''}"
                                     data-note="${lesson.note || ''}">
                                </div>
                            </div>
                        `;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        const lessonElement = cell.querySelector('.lesson');
                        lessonElement.addEventListener('click', (e) => {
                            if (e.target.classList.contains('delete-btn')) return;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                            if (pendingChanges.length > 0) {
                                showAlert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è');
                                return;
                            }
                            
                            
                            
                            // –ü–æ–ª—É—á–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞
                            const lessonIds = lessonElement.querySelector('.lesson-ids');
                            const enhancedLesson = { ...lesson };
                            
                            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ lessonId –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                            if (!enhancedLesson.id && lessonElement.dataset.lessonId) {
                                enhancedLesson.id = lessonElement.dataset.lessonId;
                            }
                            
                            // –ï—Å–ª–∏ lessonId –≤—Å–µ –µ—â–µ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π currentLessonId
                            if (!enhancedLesson.id && lessonElement.dataset.currentLessonId) {
                                enhancedLesson.id = lessonElement.dataset.currentLessonId;
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ lessonId –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å
                            if (!enhancedLesson.id) {
                                showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—Ä–æ–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                                return;
                            }
                            
                            if (lessonIds) {
                                enhancedLesson.week_day = parseInt(lessonIds.dataset.weekDay);
                                enhancedLesson.lesson_number = parseInt(lessonIds.dataset.lessonNumber);
                                
                                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≥—Ä—É–ø–ø–∞—Ö –∏ –∞—É–¥–∏—Ç–æ—Ä–∏—è—Ö
                                try {
                                    const groups = JSON.parse(lessonIds.dataset.groups || '[]');
                                    if (groups.length > 0) {
                                        enhancedLesson.groups = groups;
                                    }
                                } catch (e) {
                                }
                                
                                try {
                                    const rooms = JSON.parse(lessonIds.dataset.rooms || '[]');
                                    if (rooms.length > 0) {
                                        enhancedLesson.rooms = rooms;
                                    }
                                } catch (e) {
                                }
                                
                                // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –∑–∞–Ω—è—Ç–∏—è –∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
                                if (lessonIds.dataset.lessonType) {
                                    enhancedLesson.lesson_type = lessonIds.dataset.lessonType;
                                }
                                if (lessonIds.dataset.note) {
                                    enhancedLesson.note = lessonIds.dataset.note;
                                }
                                
                                
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å id –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            if (!enhancedLesson.id) {
                                showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—Ä–æ–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                                return;
                            }
                            
                            openModal(enhancedLesson);
                        });
                    } else {
                        cell.classList.add('empty-cell');
                        cell.style.cursor = 'pointer';
                        cell.addEventListener('click', () => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                            if (pendingChanges.length > 0) {
                                showAlert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è');
                                return;
                            }
                            
                            if (canEdit()) {
                                const position = getCellPosition(cell);
                                openModal(null, position);
                            } else {
                            showAlert('–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Ä–æ–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –≥—Ä—É–ø–ø—É, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é');
                            }
                        });
                    }
                    
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
            
            // –û—á–∏—â–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            clearDropAvailability();
            
            // –û—á–∏—â–∞–µ–º pendingChanges –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            if (pendingChanges.length > 0) {
                pendingChanges = [];
                originalTimetableState = null;
                // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º originalTimetableData –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è –æ—Ç–º–µ–Ω—ã
                hideDragDropControls();
            }
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ currentLessonId –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            document.querySelectorAll('[data-current-lesson-id]').forEach(element => {
                delete element.dataset.currentLessonId;
            });
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º drag & drop –¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–∫–æ–≤
            setupDragAndDrop();
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('timetable').style.display = show ? 'none' : 'table';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showInfo() {
            document.getElementById('info').style.display = 'block';
        }

        function hideInfo() {
            document.getElementById('info').style.display = 'none';
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—è
        let activeInput = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ dropdown
        function showDropdown(dropdown) {
            dropdown.style.display = 'block';
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è display: block
            setTimeout(() => {
                dropdown.classList.add('show');
            }, 10);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è dropdown
        function hideDropdown(dropdown) {
            dropdown.classList.remove('show');
            setTimeout(() => {
                dropdown.style.display = 'none';
            }, 150); // –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å transition
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö dropdown –∫—Ä–æ–º–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ
        function hideOtherDropdowns(exceptDropdownId = null) {
            
            const allDropdowns = [
                'calendarDropdown', 'groupDropdown', 'teacherDropdown', 'roomDropdown', 'subjectDropdown',
                'modalTeacherDropdown', 'modalSubjectDropdown', // –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                'groupsDropdown', 'roomsDropdown' // –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            ];
            
            allDropdowns.forEach(dropdownId => {
                if (dropdownId !== exceptDropdownId) {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown && dropdown.style.display !== 'none') {
                        hideDropdown(dropdown);
                    }
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π
        function restoreFieldValues() {
            let restored = false;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, –Ω–æ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const fields = [
                { inputId: 'branchInput', type: 'branch' },
                { inputId: 'calendarInput', type: 'calendar' },
                { inputId: 'groupInput', type: 'group' },
                { inputId: 'teacherInput', type: 'teacher' },
                { inputId: 'roomInput', type: 'room' },
                { inputId: 'subjectInput', type: 'subject' }
            ];
            
            fields.forEach(field => {
                const input = document.getElementById(field.inputId);
                
                if (input && input.value.trim() === '' && selectedValues[field.type].name) {
                    input.value = selectedValues[field.type].name;
                    restored = true;
                }
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
            const modalFields = [
                { inputId: 'teacherField', type: 'teacher' },
                { inputId: 'roomField', type: 'room' },
                { inputId: 'subjectField', type: 'subject' }
            ];
            
            modalFields.forEach(field => {
                const input = document.getElementById(field.inputId);
                if (input && input.value.trim() === '' && selectedValues[field.type].name) {
                    input.value = selectedValues[field.type].name;
                    restored = true;
                }
            });
            
            return restored;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ selectedValues –¥–ª—è –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π
        function clearEmptyFieldValues() {
            const fields = [
                { inputId: 'branchInput', type: 'branch' },
                { inputId: 'calendarInput', type: 'calendar' },
                { inputId: 'groupInput', type: 'group' },
                { inputId: 'teacherInput', type: 'teacher' },
                { inputId: 'roomInput', type: 'room' },
                { inputId: 'subjectInput', type: 'subject' }
            ];
            
            fields.forEach(field => {
                const input = document.getElementById(field.inputId);
                if (input && input.value.trim() === '') {
                    selectedValues[field.type] = { id: '', name: '' };
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function loadAllFiltersAfterCalendar() {
            if (selectedValues.branch && selectedValues.branch.id && selectedValues.calendar && selectedValues.calendar.id) {
                console.log('Loading all filters after calendar selection...');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                const filterTypes = ['group', 'teacher', 'room', 'subject'];
                const dropdowns = ['groupDropdown', 'teacherDropdown', 'roomDropdown', 'subjectDropdown'];
                const loadings = ['loadingGroups', 'loadingTeachers', 'loadingRooms', 'loadingSubjects'];
                
                filterTypes.forEach((type, index) => {
                    const dropdown = document.getElementById(dropdowns[index]);
                    const loading = document.getElementById(loadings[index]);
                    if (dropdown && loading) {
                        loadAllObjects(type, dropdown, loading);
                    }
                });
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        function updateFieldStates() {
            const branchSelected = selectedValues.branch && selectedValues.branch.id;
            const calendarSelected = selectedValues.calendar && selectedValues.calendar.id;
            
            // –ü–æ–ª–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è - –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–º branch
            const calendarInput = document.getElementById('calendarInput');
            if (calendarInput) {
                if (branchSelected) {
                    calendarInput.removeAttribute('readonly');
                    calendarInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å...';
                    calendarInput.style.cursor = 'text';
                } else {
                    calendarInput.setAttribute('readonly', 'readonly');
                    calendarInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª —Å–Ω–∞—á–∞–ª–∞...';
                    calendarInput.value = '';
                    calendarInput.style.cursor = 'not-allowed';
                }
            }
            
            // –ü–æ–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (groups, teachers, rooms, subjects) - –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–º branch –ò calendar
            const filterInputs = [
                { id: 'groupInput', placeholder: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã...' },
                { id: 'teacherInput', placeholder: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è...' },
                { id: 'roomInput', placeholder: '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏...' },
                { id: 'subjectInput', placeholder: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞...' }
            ];
            
            filterInputs.forEach(filter => {
                const input = document.getElementById(filter.id);
                if (input) {
                    if (branchSelected && calendarSelected) {
                        input.removeAttribute('readonly');
                        input.placeholder = filter.placeholder;
                        input.style.cursor = 'text';
                    } else {
                        input.setAttribute('readonly', 'readonly');
                        if (!branchSelected) {
                            input.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª —Å–Ω–∞—á–∞–ª–∞...';
                        } else {
                            input.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å–Ω–∞—á–∞–ª–∞...';
                        }
                        input.value = '';
                        input.style.cursor = 'not-allowed';
                    }
                }
            });
        }


        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            renderTimetable({ days: [] });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö —Ç–∞–±–ª–∏—Ü—ã
            updateWeekDates();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–µ–π
            updateFieldStates();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º branches
            loadBranches();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
            setupAutocomplete('branchInput', 'branchDropdown', 'loadingBranches', 'branch');
            setupAutocomplete('calendarInput', 'calendarDropdown', 'loadingCalendars', 'calendar');
            setupAutocomplete('groupInput', 'groupDropdown', 'loadingGroups', 'group');
            setupAutocomplete('teacherInput', 'teacherDropdown', 'loadingTeachers', 'teacher');
            setupAutocomplete('roomInput', 'roomDropdown', 'loadingRooms', 'room');
            setupAutocomplete('subjectInput', 'subjectDropdown', 'loadingSubjects', 'subject');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
            loadDropdownData();
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
            document.addEventListener('click', function(event) {
                const target = event.target;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ü–µ–ª—å —ç–ª–µ–º–µ–Ω—Ç–æ–º –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞
                const isDropdown = target.closest('.autocomplete-dropdown');
                const isInput = target.closest('input[type="text"]');
                const isAutocompleteItem = target.closest('.autocomplete-item');
                
                if (!isDropdown && !isInput && !isAutocompleteItem) {
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
                    hideOtherDropdowns();
                }
            });

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –≥—Ä—É–ø–ø
            setupGroupSelector();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–π
            setupRoomSelector();

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            setupModalAutocomplete('teacherField', 'modalTeacherDropdown', 'teacher');
            setupModalAutocomplete('subjectField', 'modalSubjectDropdown', 'subject');

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
            window.addEventListener('click', function(e) {
                const lessonModal = document.getElementById('lessonModal');
                const confirmModal = document.getElementById('confirmModal');
                const importModal = document.getElementById('importModal');
                
                if (e.target === lessonModal) {
                    closeModal();
                }
                if (e.target === confirmModal) {
                    closeConfirmModal();
                }
                if (e.target === importModal) {
                    closeImportModal();
                }
            });

            

            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —ç–ª–µ–º–µ–Ω—Ç–∞
            document.addEventListener('click', function(e) {
                // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö dropdown —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const dropdowns = [
                    'branchDropdown', 'calendarDropdown', 'groupDropdown', 'teacherDropdown', 'roomDropdown', 'subjectDropdown',
                    'modalTeacherDropdown', 'modalSubjectDropdown', // –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    'groupsDropdown', 'roomsDropdown' // –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
                ];
                
                // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö input —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const inputs = [
                    'branchInput', 'calendarInput', 'groupInput', 'teacherInput', 'roomInput', 'subjectInput',
                    'groupSearch', 'roomSearch', // –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
                    'teacherField', 'subjectField' // –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                ];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –º—ã –≤–Ω–µ input –∏ dropdown
                const clickedOnInput = inputs.some(inputId => {
                    const input = document.getElementById(inputId);
                    return input && input.contains(e.target);
                });
                
                const clickedOnDropdown = dropdowns.some(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    return dropdown && dropdown.contains(e.target);
                });
                
                // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –≤–Ω–µ input –∏ dropdown, —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ dropdown
                if (!clickedOnInput && !clickedOnDropdown) {
                    console.log('Closing dropdowns - clicked outside');
                    dropdowns.forEach(dropdownId => {
                        const dropdown = document.getElementById(dropdownId);
                        if (dropdown && dropdown.style.display !== 'none') {
                            hideDropdown(dropdown);
                        }
                    });
                    activeInput = null;
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –æ—á–∏—â–µ–Ω—ã
                    const wasRestored = restoreFieldValues();
                    
                    // –û—á–∏—â–∞–µ–º selectedValues –¥–ª—è –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –±—ã–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                    if (!wasRestored) {
                        clearEmptyFieldValues();
                    }
                }
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à–∏ Escape –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeConfirmModal();
                    closeImportModal();
                }
            });

            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', function(e) {
                if (pendingChanges.length > 0) {
                    e.preventDefault();
                    e.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
                    return e.returnValue;
                }
            });
            
            // –û—á–∏—â–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', function() {
                clearAllNotifications();
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ drag-and-drop
            document.getElementById('saveChangesBtn').addEventListener('click', saveDragDropChanges);
            document.getElementById('cancelChangesBtn').addEventListener('click', cancelDragDropChanges);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
            setupImportCalendarHandler();
        });
    </script>
</body>
</html>

